<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Productos - Cesantoni</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a; 
      color: #fff; 
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    .header h1 { font-size: 24px; }
    .header a { color: #c9a227; text-decoration: none; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .search-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar input {
      flex: 1;
      min-width: 250px;
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 16px;
    }
    .search-bar select {
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 14px;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: #1a1a1a;
      padding: 15px 25px;
      border-radius: 10px;
      border: 1px solid #333;
    }
    .stat-card .number { font-size: 28px; font-weight: bold; color: #c9a227; }
    .stat-card .label { font-size: 12px; color: #888; }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }
    
    .product-card {
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .product-card:hover { border-color: #c9a227; }
    
    .product-header {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: #222;
    }
    .product-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
    }
    .product-info { flex: 1; }
    .product-info h3 { 
      font-size: 18px; 
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .product-info .sku { font-size: 12px; color: #888; margin-bottom: 10px; }
    
    .badges { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge.video { background: #1a472a; color: #4ade80; }
    .badge.no-video { background: #4a1a1a; color: #f87171; }
    .badge.image { background: #1a3a4a; color: #60a5fa; }
    
    .product-body { padding: 15px; }
    
    .field-group {
      margin-bottom: 15px;
    }
    .field-group label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }
    .field-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0a0a0a;
      color: #fff;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
    }
    .field-group textarea:focus {
      outline: none;
      border-color: #c9a227;
    }
    
    .video-section {
      background: #0a0a0a;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .video-section video {
      width: 100%;
      border-radius: 6px;
      max-height: 200px;
    }
    .video-section .no-video-msg {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-save { background: #c9a227; color: #000; }
    .btn-video { background: #7c3aed; color: #fff; }
    .btn-delete { background: #dc2626; color: #fff; }
    .btn-view { background: #333; color: #fff; }
    .btn-landing { background: #0891b2; color: #fff; }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1a472a;
      color: #4ade80;
      padding: 15px 25px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.error { background: #4a1a1a; color: #f87171; }
    .toast.show { display: block; }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    .modal-content img {
      max-width: 100%;
      max-height: 80vh;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #333;
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
    }
    
    .generating {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #c9a227;
      font-size: 12px;
    }
    .generating .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #333;
      border-top-color: #c9a227;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚úèÔ∏è Editar Productos</h1>
    <div>
      <a href="/">‚Üê Dashboard</a> | 
      <a href="/qr-tiendas.html">Generar QRs</a>
    </div>
  </div>
  
  <div class="container">
    <div class="search-bar">
      <input type="text" id="search" placeholder="üîç Buscar por nombre o SKU...">
      <select id="filterVideo">
        <option value="">Todos</option>
        <option value="with">‚úÖ Con video</option>
        <option value="without">‚ùå Sin video</option>
      </select>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="number" id="totalProducts">0</div>
        <div class="label">PRODUCTOS</div>
      </div>
      <div class="stat-card">
        <div class="number" id="withVideo">0</div>
        <div class="label">CON VIDEO</div>
      </div>
      <div class="stat-card">
        <div class="number" id="withoutVideo">0</div>
        <div class="label">SIN VIDEO</div>
      </div>
    </div>
    
    <div class="products-grid" id="productsGrid"></div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <div class="modal" id="imageModal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-content">
      <img id="modalImage" src="">
    </div>
  </div>

<script>
let products = [];
let generatingVideos = new Set();

async function loadProducts() {
  try {
    const res = await fetch('/api/products');
    products = await res.json();
    updateStats();
    renderProducts();
  } catch (err) {
    showToast('Error cargando productos', true);
  }
}

function updateStats() {
  const withVideo = products.filter(p => p.video_url).length;
  document.getElementById('totalProducts').textContent = products.length;
  document.getElementById('withVideo').textContent = withVideo;
  document.getElementById('withoutVideo').textContent = products.length - withVideo;
}

function renderProducts() {
  const search = document.getElementById('search').value.toLowerCase();
  const filter = document.getElementById('filterVideo').value;
  
  let filtered = products.filter(p => {
    const matchSearch = p.name.toLowerCase().includes(search) || 
                       (p.sku && p.sku.toLowerCase().includes(search));
    const matchFilter = filter === '' || 
                       (filter === 'with' && p.video_url) ||
                       (filter === 'without' && !p.video_url);
    return matchSearch && matchFilter;
  });
  
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = filtered.map(p => `
    <div class="product-card" data-id="${p.id}">
      <div class="product-header">
        <img class="product-img" 
             src="${p.image_url || '/placeholder.jpg'}" 
             alt="${p.name}"
             onclick="showImage('${p.image_url}')"
             onerror="this.src='/placeholder.jpg'">
        <div class="product-info">
          <h3>${p.name}</h3>
          <div class="sku">${p.sku || 'Sin SKU'}</div>
          <div class="badges">
            ${p.video_url 
              ? '<span class="badge video">‚úì Video</span>' 
              : '<span class="badge no-video">‚úó Sin video</span>'}
            ${p.image_url 
              ? '<span class="badge image">‚úì Imagen</span>' 
              : ''}
          </div>
          ${generatingVideos.has(p.id) 
            ? '<div class="generating"><span class="spinner"></span> Generando video...</div>' 
            : ''}
        </div>
      </div>
      
      <div class="product-body">
        <div class="field-group">
          <label>Descripci√≥n</label>
          <textarea id="desc-${p.id}" placeholder="Descripci√≥n del producto...">${p.description || ''}</textarea>
        </div>
        
        <div class="video-section">
          ${p.video_url 
            ? `<video src="${p.video_url}" controls></video>`
            : '<div class="no-video-msg">üé¨ Sin video generado</div>'}
        </div>
        
        <div class="actions">
          <button class="btn btn-save" onclick="saveDescription(${p.id})">
            üíæ Guardar
          </button>
          <button class="btn btn-video" onclick="generateVideo(${p.id})" ${generatingVideos.has(p.id) ? 'disabled' : ''}>
            üé¨ ${p.video_url ? 'Regenerar' : 'Generar'} Video
          </button>
          ${p.video_url ? `
            <button class="btn btn-delete" onclick="deleteVideo(${p.id})">
              üóëÔ∏è Borrar Video
            </button>
          ` : ''}
          <button class="btn btn-landing" onclick="window.open('/p/${p.sku}', '_blank')">
            üëÅÔ∏è Ver Landing
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

async function saveDescription(productId) {
  const desc = document.getElementById(`desc-${productId}`).value;
  
  try {
    const res = await fetch(`/api/products/${productId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: desc })
    });
    
    if (res.ok) {
      // Actualizar en memoria
      const p = products.find(x => x.id === productId);
      if (p) p.description = desc;
      showToast('Descripci√≥n guardada ‚úì');
    } else {
      throw new Error('Error al guardar');
    }
  } catch (err) {
    showToast('Error guardando descripci√≥n', true);
  }
}

async function generateVideo(productId) {
  const p = products.find(x => x.id === productId);
  if (!p) return;
  
  generatingVideos.add(productId);
  renderProducts();
  showToast('Generando video... (esto toma ~2-3 min)');
  
  try {
    const res = await fetch('/api/video/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_id: productId,
        product_name: p.name,
        product_description: p.description,
        image_url: p.image_url
      })
    });
    
    // El video se genera en background, polling cada 10s
    pollVideoStatus(productId, p.name);
  } catch (err) {
    generatingVideos.delete(productId);
    renderProducts();
    showToast('Error iniciando generaci√≥n', true);
  }
}

async function pollVideoStatus(productId, productName) {
  const slug = productName.toLowerCase().replace(/\s+/g, '_');
  
  for (let i = 0; i < 30; i++) {
    await new Promise(r => setTimeout(r, 10000));
    
    try {
      const res = await fetch(`/api/products/${productId}`);
      const p = await res.json();
      
      if (p.video_url) {
        generatingVideos.delete(productId);
        // Actualizar producto en lista
        const idx = products.findIndex(x => x.id === productId);
        if (idx >= 0) products[idx] = p;
        renderProducts();
        showToast('Video generado ‚úì');
        return;
      }
    } catch (err) {}
  }
  
  generatingVideos.delete(productId);
  renderProducts();
  showToast('Timeout generando video', true);
}

async function deleteVideo(productId) {
  if (!confirm('¬øSeguro que quieres borrar este video?')) return;
  
  try {
    const res = await fetch(`/api/products/${productId}/video`, {
      method: 'DELETE'
    });
    
    if (res.ok) {
      const p = products.find(x => x.id === productId);
      if (p) p.video_url = null;
      renderProducts();
      showToast('Video eliminado ‚úì');
    } else {
      throw new Error('Error');
    }
  } catch (err) {
    showToast('Error eliminando video', true);
  }
}

function showImage(url) {
  if (!url) return;
  document.getElementById('modalImage').src = url;
  document.getElementById('imageModal').classList.add('show');
}

function closeModal() {
  document.getElementById('imageModal').classList.remove('show');
}

function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// Event listeners
document.getElementById('search').addEventListener('input', renderProducts);
document.getElementById('filterVideo').addEventListener('change', renderProducts);
document.getElementById('imageModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});

// Init
loadProducts();
</script>
</body>
</html>
