<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promociones - Cesantoni</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .header {
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      color: white;
      padding: 20px 24px;
    }
    .header h1 { font-size: 20px; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 0; }
    .tab {
      padding: 14px 28px;
      background: #e0e0e0;
      border: none;
      border-radius: 10px 10px 0 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #666;
    }
    .tab.active { background: white; color: #c41e3a; }
    
    .tab-content {
      background: white;
      border-radius: 0 12px 12px 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: none;
    }
    .tab-content.active { display: block; }
    
    /* Filter sections */
    .filter-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .filter-section:last-of-type { border-bottom: none; }
    
    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .filter-title {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-title .num {
      background: #c41e3a;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .filter-actions {
      display: flex;
      gap: 8px;
    }
    .filter-actions button {
      padding: 4px 10px;
      font-size: 11px;
      background: #eee;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .filter-actions button:hover { background: #ddd; }
    
    .filter-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f9f9f9;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
      user-select: none;
    }
    .filter-item:hover { background: #f0f0f0; }
    .filter-item.selected {
      background: #fef2f2;
      border-color: #c41e3a;
    }
    .filter-item .check {
      width: 18px;
      height: 18px;
      border: 2px solid #ccc;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .filter-item.selected .check {
      background: #c41e3a;
      border-color: #c41e3a;
    }
    .filter-item.selected .check::after {
      content: "‚úì";
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    .filter-item .count {
      background: #eee;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      color: #666;
      margin-left: 4px;
    }
    .filter-item .price {
      color: #888;
      font-size: 11px;
    }
    
    /* Selection summary */
    .selection-summary {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    .summary-item h4 { font-size: 12px; opacity: 0.8; margin-bottom: 4px; }
    .summary-item .num { font-size: 28px; font-weight: 700; }
    
    /* Promo details */
    .promo-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      padding: 10px 14px;
      border: 2px solid #eee;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #c41e3a;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 0;
    }
    .checkbox-row input { width: 18px; height: 18px; }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #c41e3a; color: white; }
    .btn-primary:hover { background: #a01830; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #eee; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    .btn-group { display: flex; gap: 12px; margin-top: 24px; }
    
    /* ==================== TAB 2: GESTIONAR ==================== */
    .manage-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .manage-filters select {
      padding: 10px 14px;
      border: 2px solid #eee;
      border-radius: 6px;
      font-size: 14px;
      min-width: 180px;
    }
    
    .promo-group {
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 10px;
      overflow: hidden;
    }
    .promo-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: #fafafa;
      cursor: pointer;
    }
    .promo-group-header:hover { background: #f5f5f5; }
    .promo-group-title {
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .promo-group-title .count {
      background: #c41e3a;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    .promo-group-actions { display: flex; gap: 8px; }
    
    .promo-group-items {
      display: none;
      padding: 0;
    }
    .promo-group.open .promo-group-items { display: block; }
    
    .promo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #eee;
    }
    .promo-item:hover { background: #fafafa; }
    .promo-item-info { flex: 1; }
    .promo-item-info h4 { font-size: 14px; margin-bottom: 2px; }
    .promo-item-info p { font-size: 12px; color: #888; }
    .promo-item-price { 
      font-size: 18px; 
      font-weight: 700; 
      color: #c41e3a;
      margin-right: 16px;
    }
    .promo-item-dates {
      font-size: 11px;
      color: #888;
      margin-right: 16px;
      text-align: right;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-inactive { background: #f8d7da; color: #721c24; }
    .badge-expired { background: #fff3cd; color: #856404; }
    
    .toggle-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }
    .toggle-btn.active { background: #f8d7da; color: #721c24; }
    .toggle-btn.inactive { background: #d4edda; color: #155724; }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    /* Stats */
    .stats-bar {
      display: flex;
      gap: 20px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .stat-item { text-align: center; }
    .stat-item .num { font-size: 24px; font-weight: 700; color: #c41e3a; }
    .stat-item .label { font-size: 11px; color: #888; text-transform: uppercase; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      z-index: 1000;
    }
    .toast.success { background: #28a745; }
    .toast.error { background: #dc3545; }
  </style>
</head>
<body>
  <header class="header">
    <h1>üè∑Ô∏è Promociones Cesantoni</h1>
  </header>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('create')">‚ûï Crear Promoci√≥n</button>
      <button class="tab" onclick="showTab('manage')">üìã Gestionar Promociones</button>
    </div>
    
    <!-- ==================== TAB 1: CREAR ==================== -->
    <div class="tab-content active" id="tab-create">
      
      <!-- 1. Productos -->
      <div class="filter-section">
        <div class="filter-header">
          <div class="filter-title"><span class="num">1</span> Productos</div>
          <div class="filter-actions">
            <button onclick="selectAll('product')">Todos</button>
            <button onclick="selectNone('product')">Ninguno</button>
          </div>
        </div>
        <div class="filter-grid" id="productGrid"></div>
      </div>
      
      <!-- 2. Distribuidores -->
      <div class="filter-section">
        <div class="filter-header">
          <div class="filter-title"><span class="num">2</span> Distribuidores</div>
          <div class="filter-actions">
            <button onclick="selectAll('distributor')">Todos</button>
            <button onclick="selectNone('distributor')">Ninguno</button>
          </div>
        </div>
        <div class="filter-grid" id="distributorGrid"></div>
      </div>
      
      <!-- 3. Estados -->
      <div class="filter-section">
        <div class="filter-header">
          <div class="filter-title"><span class="num">3</span> Estados</div>
          <div class="filter-actions">
            <button onclick="selectAll('state')">Todos</button>
            <button onclick="selectNone('state')">Ninguno</button>
          </div>
        </div>
        <div class="filter-grid" id="stateGrid"></div>
      </div>
      
      <!-- 4. Ciudades -->
      <div class="filter-section">
        <div class="filter-header">
          <div class="filter-title"><span class="num">4</span> Ciudades</div>
          <div class="filter-actions">
            <button onclick="selectAll('city')">Todas</button>
            <button onclick="selectNone('city')">Ninguna</button>
          </div>
        </div>
        <div class="filter-grid" id="cityGrid"></div>
      </div>
      
      <!-- 5. Tiendas -->
      <div class="filter-section">
        <div class="filter-header">
          <div class="filter-title"><span class="num">5</span> Tiendas</div>
          <div class="filter-actions">
            <button onclick="selectAll('store')">Todas</button>
            <button onclick="selectNone('store')">Ninguna</button>
          </div>
        </div>
        <div class="filter-grid" id="storeGrid"></div>
      </div>
      
      <!-- Summary -->
      <div class="selection-summary">
        <div class="summary-item">
          <h4>Productos</h4>
          <div class="num" id="countProducts">0</div>
        </div>
        <div class="summary-item">
          <h4>Tiendas</h4>
          <div class="num" id="countStores">0</div>
        </div>
        <div class="summary-item">
          <h4>Promociones a crear</h4>
          <div class="num" id="countTotal">0</div>
        </div>
      </div>
      
      <!-- Promo details -->
      <div class="promo-details">
        <div class="form-group">
          <label>Nombre de la promoci√≥n</label>
          <input type="text" id="promoName" placeholder="Ej: Hot Sale 2026">
        </div>
        <div class="form-group">
          <label>Precio promocional (MXN/m¬≤)</label>
          <input type="number" id="promoPrice" step="0.01" placeholder="450.00">
        </div>
        <div class="form-group">
          <label>Texto en landing</label>
          <input type="text" id="promoText" placeholder="Ej: üî• HOT SALE">
        </div>
        <div class="form-group">
          <label>Fecha inicio</label>
          <input type="date" id="startDate">
        </div>
        <div class="form-group">
          <label>Fecha fin</label>
          <input type="date" id="endDate">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <div class="checkbox-row">
            <input type="checkbox" id="untilStock">
            <label for="untilStock">O hasta agotar existencias</label>
          </div>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="resetForm()">Limpiar</button>
        <button class="btn btn-primary" onclick="createPromotions()">Crear Promociones</button>
      </div>
    </div>
    
    <!-- ==================== TAB 2: GESTIONAR ==================== -->
    <div class="tab-content" id="tab-manage">
      
      <!-- Stats -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="num" id="statTotal">0</div>
          <div class="label">Total</div>
        </div>
        <div class="stat-item">
          <div class="num" id="statActive">0</div>
          <div class="label">Activas</div>
        </div>
        <div class="stat-item">
          <div class="num" id="statInactive">0</div>
          <div class="label">Inactivas</div>
        </div>
        <div class="stat-item">
          <div class="num" id="statExpired">0</div>
          <div class="label">Expiradas</div>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="manage-filters">
        <select id="filterDistributor" onchange="renderPromoGroups()">
          <option value="">Todos los distribuidores</option>
        </select>
        <select id="filterState" onchange="renderPromoGroups()">
          <option value="">Todos los estados</option>
        </select>
        <select id="filterProduct" onchange="renderPromoGroups()">
          <option value="">Todos los productos</option>
        </select>
        <select id="filterStatus" onchange="renderPromoGroups()">
          <option value="">Todos los estados</option>
          <option value="active">Solo activas</option>
          <option value="inactive">Solo inactivas</option>
          <option value="expired">Solo expiradas</option>
        </select>
      </div>
      
      <!-- Promo groups -->
      <div id="promoGroups">
        <div class="empty-state">Cargando...</div>
      </div>
    </div>
  </div>

  <script>
    let products = [];
    let stores = [];
    let promotions = [];
    
    // Selecciones para crear
    let selected = {
      product: new Set(),
      distributor: new Set(),
      state: new Set(),
      city: new Set(),
      store: new Set()
    };
    
    // ==================== CARGA DE DATOS ====================
    async function loadData() {
      const [prodRes, storeRes, promoRes] = await Promise.all([
        fetch('/api/products'),
        fetch('/api/stores'),
        fetch('/api/promotions')
      ]);
      products = await prodRes.json();
      stores = await storeRes.json();
      promotions = await promoRes.json();
      
      renderProducts();
      renderDistributors();
      renderStates();
      renderCities();
      renderStores();
      renderManageFilters();
      renderPromoGroups();
      updateStats();
      
      // Default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      document.getElementById('endDate').value = nextMonth.toISOString().split('T')[0];
    }
    
    // ==================== TAB 1: CREAR ====================
    function renderProducts() {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = products.map(p => `
        <div class="filter-item ${selected.product.has(p.id) ? 'selected' : ''}" onclick="toggle('product', ${p.id})">
          <span class="check"></span>
          <span>${p.name}</span>
          <span class="price">$${p.base_price}/m¬≤</span>
        </div>
      `).join('');
    }
    
    function renderDistributors() {
      const grid = document.getElementById('distributorGrid');
      const counts = {};
      stores.forEach(s => {
        counts[s.distributor_name] = (counts[s.distributor_name] || 0) + 1;
      });
      
      const unique = [...new Set(stores.map(s => s.distributor_name))].filter(Boolean).sort();
      
      grid.innerHTML = unique.map(d => `
        <div class="filter-item ${selected.distributor.has(d) ? 'selected' : ''}" onclick="toggle('distributor', '${d}')">
          <span class="check"></span>
          <span>${d}</span>
          <span class="count">${counts[d] || 0}</span>
        </div>
      `).join('');
    }
    
    function renderStates() {
      const grid = document.getElementById('stateGrid');
      
      let filtered = stores;
      if (selected.distributor.size > 0) {
        filtered = stores.filter(s => selected.distributor.has(s.distributor_name));
      }
      
      const counts = {};
      filtered.forEach(s => {
        if (s.state) counts[s.state] = (counts[s.state] || 0) + 1;
      });
      
      const unique = Object.keys(counts).sort();
      
      grid.innerHTML = unique.map(state => `
        <div class="filter-item ${selected.state.has(state) ? 'selected' : ''}" onclick="toggle('state', '${state}')">
          <span class="check"></span>
          <span>${state}</span>
          <span class="count">${counts[state]}</span>
        </div>
      `).join('') || '<div class="empty-state" style="padding:20px">Selecciona distribuidores</div>';
    }
    
    function renderCities() {
      const grid = document.getElementById('cityGrid');
      
      let filtered = stores;
      if (selected.distributor.size > 0) filtered = filtered.filter(s => selected.distributor.has(s.distributor_name));
      if (selected.state.size > 0) filtered = filtered.filter(s => selected.state.has(s.state));
      
      const counts = {};
      filtered.forEach(s => {
        if (s.city) counts[s.city] = (counts[s.city] || 0) + 1;
      });
      
      const unique = Object.keys(counts).sort();
      
      grid.innerHTML = unique.map(city => `
        <div class="filter-item ${selected.city.has(city) ? 'selected' : ''}" onclick="toggle('city', '${city}')">
          <span class="check"></span>
          <span>${city}</span>
          <span class="count">${counts[city]}</span>
        </div>
      `).join('') || '<div class="empty-state" style="padding:20px">Selecciona estados</div>';
    }
    
    function renderStores() {
      const grid = document.getElementById('storeGrid');
      
      let filtered = stores;
      if (selected.distributor.size > 0) filtered = filtered.filter(s => selected.distributor.has(s.distributor_name));
      if (selected.state.size > 0) filtered = filtered.filter(s => selected.state.has(s.state));
      if (selected.city.size > 0) filtered = filtered.filter(s => selected.city.has(s.city));
      
      grid.innerHTML = filtered.slice(0, 100).map(s => `
        <div class="filter-item ${selected.store.has(s.id) ? 'selected' : ''}" onclick="toggle('store', ${s.id})">
          <span class="check"></span>
          <span>${s.name}</span>
        </div>
      `).join('') || '<div class="empty-state" style="padding:20px">No hay tiendas</div>';
      
      if (filtered.length > 100) {
        grid.innerHTML += `<div style="padding:10px;color:#888;font-size:12px">... y ${filtered.length - 100} m√°s</div>`;
      }
      
      updateCounts();
    }
    
    function toggle(type, value) {
      if (selected[type].has(value)) {
        selected[type].delete(value);
      } else {
        selected[type].add(value);
      }
      
      // Cascade clear
      if (type === 'distributor') {
        selected.state.clear();
        selected.city.clear();
        selected.store.clear();
      } else if (type === 'state') {
        selected.city.clear();
        selected.store.clear();
      } else if (type === 'city') {
        selected.store.clear();
      }
      
      // Re-render
      if (type === 'product') renderProducts();
      if (type === 'distributor') { renderDistributors(); renderStates(); renderCities(); renderStores(); }
      if (type === 'state') { renderStates(); renderCities(); renderStores(); }
      if (type === 'city') { renderCities(); renderStores(); }
      if (type === 'store') renderStores();
      
      updateCounts();
    }
    
    function selectAll(type) {
      if (type === 'product') {
        products.forEach(p => selected.product.add(p.id));
        renderProducts();
      } else if (type === 'store') {
        let filtered = stores;
        if (selected.distributor.size > 0) filtered = filtered.filter(s => selected.distributor.has(s.distributor_name));
        if (selected.state.size > 0) filtered = filtered.filter(s => selected.state.has(s.state));
        if (selected.city.size > 0) filtered = filtered.filter(s => selected.city.has(s.city));
        filtered.forEach(s => selected.store.add(s.id));
        renderStores();
      } else {
        const grid = document.getElementById(type + 'Grid');
        grid.querySelectorAll('.filter-item').forEach(item => {
          const text = item.querySelector('span:nth-child(2)').textContent;
          selected[type].add(text);
        });
        if (type === 'distributor') { renderDistributors(); renderStates(); renderCities(); renderStores(); }
        if (type === 'state') { renderStates(); renderCities(); renderStores(); }
        if (type === 'city') { renderCities(); renderStores(); }
      }
      updateCounts();
    }
    
    function selectNone(type) {
      selected[type].clear();
      if (type === 'distributor') { selected.state.clear(); selected.city.clear(); selected.store.clear(); }
      if (type === 'state') { selected.city.clear(); selected.store.clear(); }
      if (type === 'city') { selected.store.clear(); }
      
      if (type === 'product') renderProducts();
      if (type === 'distributor') { renderDistributors(); renderStates(); renderCities(); renderStores(); }
      if (type === 'state') { renderStates(); renderCities(); renderStores(); }
      if (type === 'city') { renderCities(); renderStores(); }
      if (type === 'store') renderStores();
      updateCounts();
    }
    
    function updateCounts() {
      const productCount = selected.product.size;
      const storeCount = getSelectedStoreIds().length;
      const total = productCount * storeCount;
      
      document.getElementById('countProducts').textContent = productCount;
      document.getElementById('countStores').textContent = storeCount;
      document.getElementById('countTotal').textContent = total;
    }
    
    function getSelectedStoreIds() {
      if (selected.store.size > 0) return Array.from(selected.store);
      
      let filtered = stores;
      if (selected.distributor.size > 0) filtered = filtered.filter(s => selected.distributor.has(s.distributor_name));
      if (selected.state.size > 0) filtered = filtered.filter(s => selected.state.has(s.state));
      if (selected.city.size > 0) filtered = filtered.filter(s => selected.city.has(s.city));
      
      return filtered.map(s => s.id);
    }
    
    async function createPromotions() {
      const name = document.getElementById('promoName').value;
      const price = document.getElementById('promoPrice').value;
      const text = document.getElementById('promoText').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const untilStock = document.getElementById('untilStock').checked;
      
      if (!name || !price || !startDate || !endDate) {
        showToast('Completa todos los campos', 'error');
        return;
      }
      
      if (selected.product.size === 0) {
        showToast('Selecciona al menos un producto', 'error');
        return;
      }
      
      const storeIds = getSelectedStoreIds();
      if (storeIds.length === 0) {
        showToast('Selecciona al menos una tienda', 'error');
        return;
      }
      
      const productIds = Array.from(selected.product);
      let created = 0;
      
      for (const productId of productIds) {
        for (const storeId of storeIds) {
          const store = stores.find(s => s.id === storeId);
          try {
            await fetch('/api/promotions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name,
                product_id: productId,
                scope_type: 'store',
                scope_value: store.slug,
                promo_price: parseFloat(price),
                promo_text: text || null,
                start_date: startDate,
                end_date: endDate,
                until_stock: untilStock ? 1 : 0
              })
            });
            created++;
          } catch (e) { console.error(e); }
        }
      }
      
      showToast(`‚úÖ ${created} promociones creadas`, 'success');
      resetForm();
      loadData();
    }
    
    function resetForm() {
      document.getElementById('promoName').value = '';
      document.getElementById('promoPrice').value = '';
      document.getElementById('promoText').value = '';
      document.getElementById('untilStock').checked = false;
      
      Object.keys(selected).forEach(k => selected[k].clear());
      renderProducts();
      renderDistributors();
      renderStates();
      renderCities();
      renderStores();
    }
    
    // ==================== TAB 2: GESTIONAR ====================
    function renderManageFilters() {
      // Distribuidores
      const distFilter = document.getElementById('filterDistributor');
      const dists = [...new Set(stores.map(s => s.distributor_name))].filter(Boolean).sort();
      distFilter.innerHTML = '<option value="">Todos los distribuidores</option>' +
        dists.map(d => `<option value="${d}">${d}</option>`).join('');
      
      // Estados
      const stateFilter = document.getElementById('filterState');
      const states = [...new Set(stores.map(s => s.state))].filter(Boolean).sort();
      stateFilter.innerHTML = '<option value="">Todos los estados</option>' +
        states.map(s => `<option value="${s}">${s}</option>`).join('');
      
      // Productos
      const prodFilter = document.getElementById('filterProduct');
      prodFilter.innerHTML = '<option value="">Todos los productos</option>' +
        products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    
    function updateStats() {
      const now = new Date();
      let active = 0, inactive = 0, expired = 0;
      
      promotions.forEach(p => {
        const end = new Date(p.end_date);
        if (!p.active) inactive++;
        else if (end < now) expired++;
        else active++;
      });
      
      document.getElementById('statTotal').textContent = promotions.length;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statInactive').textContent = inactive;
      document.getElementById('statExpired').textContent = expired;
    }
    
    function renderPromoGroups() {
      const container = document.getElementById('promoGroups');
      const distFilter = document.getElementById('filterDistributor').value;
      const stateFilter = document.getElementById('filterState').value;
      const prodFilter = document.getElementById('filterProduct').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      const now = new Date();
      
      // Filtrar promociones
      let filtered = promotions.filter(p => {
        // Buscar tienda por scope_value
        const store = stores.find(s => s.slug === p.scope_value);
        
        if (distFilter && store?.distributor_name !== distFilter) return false;
        if (stateFilter && store?.state !== stateFilter) return false;
        if (prodFilter && p.product_id != prodFilter) return false;
        
        const end = new Date(p.end_date);
        const isActive = p.active && end >= now;
        const isExpired = end < now;
        
        if (statusFilter === 'active' && !isActive) return false;
        if (statusFilter === 'inactive' && p.active) return false;
        if (statusFilter === 'expired' && !isExpired) return false;
        
        return true;
      });
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay promociones con estos filtros</div>';
        return;
      }
      
      // Agrupar por distribuidor
      const groups = {};
      filtered.forEach(p => {
        const store = stores.find(s => s.slug === p.scope_value);
        const distName = store?.distributor_name || 'Sin distribuidor';
        if (!groups[distName]) groups[distName] = [];
        groups[distName].push({ ...p, store });
      });
      
      container.innerHTML = Object.entries(groups).map(([dist, promos]) => `
        <div class="promo-group" id="group-${dist.replace(/\s/g, '')}">
          <div class="promo-group-header" onclick="toggleGroup('${dist.replace(/\s/g, '')}')">
            <div class="promo-group-title">
              <span>${dist}</span>
              <span class="count">${promos.length}</span>
            </div>
            <div class="promo-group-actions">
              <button class="btn btn-success btn-small" onclick="event.stopPropagation(); toggleGroupStatus('${dist}', true)">Activar todas</button>
              <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); toggleGroupStatus('${dist}', false)">Desactivar todas</button>
            </div>
          </div>
          <div class="promo-group-items">
            ${promos.map(p => {
              const end = new Date(p.end_date);
              const isExpired = end < now;
              const statusClass = !p.active ? 'inactive' : isExpired ? 'expired' : 'active';
              const statusText = !p.active ? 'Inactiva' : isExpired ? 'Expirada' : 'Activa';
              
              return `
                <div class="promo-item">
                  <div class="promo-item-info">
                    <h4>${p.product_name || 'Producto'} <span class="badge badge-${statusClass}">${statusText}</span></h4>
                    <p>${p.store?.name || p.scope_value} ‚Ä¢ ${p.store?.state || ''}</p>
                  </div>
                  <div class="promo-item-price">$${p.promo_price}</div>
                  <div class="promo-item-dates">
                    ${formatDate(p.start_date)}<br>${formatDate(p.end_date)}
                  </div>
                  <button class="toggle-btn ${p.active ? 'active' : 'inactive'}" onclick="togglePromo(${p.id})">
                    ${p.active ? 'Desactivar' : 'Activar'}
                  </button>
                  <button class="btn btn-secondary btn-small" style="margin-left:8px" onclick="deletePromo(${p.id})">üóëÔ∏è</button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }
    
    function toggleGroup(groupId) {
      document.getElementById('group-' + groupId).classList.toggle('open');
    }
    
    async function toggleGroupStatus(distributor, activate) {
      const promos = promotions.filter(p => {
        const store = stores.find(s => s.slug === p.scope_value);
        return store?.distributor_name === distributor;
      });
      
      for (const p of promos) {
        if (p.active !== activate) {
          await fetch(`/api/promotions/${p.id}/toggle`, { method: 'PUT' });
        }
      }
      
      showToast(`${promos.length} promociones ${activate ? 'activadas' : 'desactivadas'}`, 'success');
      loadData();
    }
    
    async function togglePromo(id) {
      await fetch(`/api/promotions/${id}/toggle`, { method: 'PUT' });
      loadData();
    }
    
    async function deletePromo(id) {
      if (!confirm('¬øEliminar esta promoci√≥n?')) return;
      await fetch(`/api/promotions/${id}`, { method: 'DELETE' });
      showToast('Promoci√≥n eliminada', 'success');
      loadData();
    }
    
    // ==================== UTILIDADES ====================
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
    }
    
    function formatDate(str) {
      return new Date(str).toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
    }
    
    function showToast(msg, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Init
    loadData();
  </script>
</body>
</html>
