<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Cesantoni Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #0a0a0a;
            --charcoal: #1a1a1a;
            --gold: #c9a227;
            --gold-dark: #a68523;
            --cream: #f5f3ef;
            --white: #ffffff;
            --gray: #666;
            --gray-light: #999;
            --gray-dark: #2a2a2a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 50px;
            transition: all 0.4s ease;
        }

        .header.scrolled {
            background: rgba(10,10,10,0.95);
            padding: 15px 50px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            color: var(--white);
            text-decoration: none;
        }

        .logo span { color: var(--gold); font-weight: 400; }

        .header-badge {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 8px 16px;
        }

        /* Hero */
        .hero {
            height: 100vh;
            position: relative;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }

        .hero-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transform: scale(1.1);
            animation: heroZoom 20s ease-out forwards;
        }

        @keyframes heroZoom {
            to { transform: scale(1); }
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(10,10,10,0.3) 0%, rgba(10,10,10,0.7) 70%, rgba(10,10,10,1) 100%);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            padding: 0 50px 100px;
            max-width: 800px;
        }

        .hero-tag {
            display: inline-block;
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gold);
        }

        .hero-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(4rem, 12vw, 8rem);
            font-weight: 500;
            line-height: 0.9;
            margin-bottom: 30px;
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            font-weight: 300;
            line-height: 1.8;
            color: var(--gray-light);
            max-width: 500px;
        }

        .scroll-indicator {
            position: absolute;
            bottom: 40px;
            right: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 2;
        }

        .scroll-indicator span {
            font-size: 0.65rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gray);
            writing-mode: vertical-rl;
        }

        .scroll-line {
            width: 1px;
            height: 60px;
            background: linear-gradient(180deg, var(--gold) 0%, transparent 100%);
            animation: scrollPulse 2s ease-in-out infinite;
        }

        @keyframes scrollPulse {
            0%, 100% { opacity: 1; transform: scaleY(1); }
            50% { opacity: 0.5; transform: scaleY(0.8); }
        }

        /* Sections */
        section { padding: 120px 50px; }

        .section-container { max-width: 1400px; margin: 0 auto; }

        .section-label {
            display: inline-block;
            font-size: 0.7rem;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 15px;
        }

        .section-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 400;
            color: var(--cream);
            max-width: 600px;
        }

        /* Product Showcase */
        .product-showcase { background: var(--charcoal); }

        .product-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 80px;
            align-items: center;
        }

        .product-image-main {
            position: relative;
            overflow: hidden;
        }

        .product-image-main img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.6s ease;
        }

        .product-image-main:hover img { transform: scale(1.03); }

        .product-details h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3.5rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--cream);
        }

        .format {
            font-size: 0.8rem;
            letter-spacing: 0.15em;
            color: var(--gold);
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        .product-details p {
            font-size: 1rem;
            line-height: 1.9;
            color: var(--gray-light);
            margin-bottom: 40px;
        }

        .product-specs-mini {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .spec-mini {
            padding: 20px;
            border: 1px solid var(--gray-dark);
            transition: all 0.3s ease;
        }

        .spec-mini:hover {
            border-color: var(--gold);
            background: rgba(201,162,39,0.05);
        }

        .spec-mini-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .spec-mini-label {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--gray);
        }

        /* Pricing Section */
        .pricing-section {
            background: var(--black);
            text-align: center;
        }

        .pricing-box {
            max-width: 500px;
            margin: 0 auto;
            padding: 60px;
            border: 1px solid var(--gray-dark);
        }

        .price-original {
            font-size: 1.2rem;
            color: var(--gray);
            text-decoration: line-through;
            margin-bottom: 10px;
        }

        .price-current {
            font-family: 'Cormorant Garamond', serif;
            font-size: 4rem;
            font-weight: 500;
            color: var(--gold);
        }

        .price-unit {
            font-size: 1.2rem;
            color: var(--gray-light);
            font-weight: 300;
        }

        .promo-badge-inline {
            display: inline-block;
            background: var(--gold);
            color: var(--black);
            padding: 12px 30px;
            margin-top: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .promo-dates {
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--gray);
        }

        /* Video */
        .video-section {
            background: var(--black);
            padding: 0;
        }

        .video-container {
            max-width: 1200px;
            margin: 0 auto;
            aspect-ratio: 16/9;
            background: var(--charcoal);
            position: relative;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--charcoal) 0%, var(--black) 100%);
        }

        .video-placeholder-icon {
            width: 80px;
            height: 80px;
            border: 2px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .video-placeholder-icon:hover {
            background: var(--gold);
            transform: scale(1.1);
        }

        .video-placeholder-icon::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 24px solid var(--gold);
            border-top: 14px solid transparent;
            border-bottom: 14px solid transparent;
            margin-left: 8px;
            transition: border-color 0.4s ease;
        }

        .video-placeholder-icon:hover::after { border-left-color: var(--black); }

        .video-placeholder p {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-style: italic;
            color: var(--gray);
        }

        /* Benefits */
        .benefits {
            background: linear-gradient(180deg, var(--black) 0%, var(--charcoal) 100%);
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            margin-top: 60px;
        }

        .benefit-card {
            padding: 50px 40px;
            background: var(--gray-dark);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .benefit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gold);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }

        .benefit-card:hover::before { transform: scaleX(1); }
        .benefit-card:hover { transform: translateY(-10px); }

        .benefit-icon { font-size: 2.5rem; margin-bottom: 25px; }
        .benefit-title { font-size: 1.4rem; margin-bottom: 15px; color: var(--cream); }
        .benefit-text { font-size: 0.9rem; color: var(--gray-light); line-height: 1.7; }

        /* Specs */
        .specs {
            background: var(--cream);
            color: var(--black);
        }

        .specs .section-title { color: var(--black); }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-top: 50px;
        }

        .spec-item {
            padding: 30px;
            background: var(--white);
            border: 1px solid rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
        }

        .spec-item:hover {
            border-color: var(--gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .spec-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--gold-dark);
            margin-bottom: 8px;
        }

        .spec-label {
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--gray);
        }

        /* Uses/Applications */
        .uses-section {
            background: var(--black);
            padding: 80px 50px;
        }

        .uses-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .use-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-dark);
            transition: all 0.3s ease;
        }

        .use-badge:hover {
            border-color: var(--gold);
            background: rgba(201,162,39,0.1);
        }

        .use-badge-icon {
            font-size: 1.5rem;
        }

        .use-badge-text {
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--cream);
        }

        /* PEI Badge */
        .pei-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--gold);
            color: var(--black);
            padding: 10px 20px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            z-index: 10;
        }

        /* Related Products */
        .related-section {
            background: var(--charcoal);
            padding: 80px 50px;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-top: 40px;
        }

        .related-card {
            background: var(--gray-dark);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .related-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .related-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .related-card:hover img {
            transform: scale(1.05);
        }

        .related-card-info {
            padding: 20px;
        }

        .related-card-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: var(--cream);
            margin-bottom: 5px;
        }

        .related-card-format {
            font-size: 0.75rem;
            color: var(--gold);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        @media (max-width: 1024px) {
            .related-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .related-grid { grid-template-columns: 1fr; }
        }

        /* Gallery */
        .gallery-section {
            background: var(--black);
            padding: 80px 50px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 40px;
        }

        .gallery-item {
            aspect-ratio: 1;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .gallery-item:hover img {
            transform: scale(1.1);
        }

        .gallery-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0);
            transition: background 0.3s ease;
        }

        .gallery-item:hover::after {
            background: rgba(201,162,39,0.2);
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 30px;
            color: var(--white);
            font-size: 2rem;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--gray);
            transition: all 0.3s ease;
        }

        .lightbox-close:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        @media (max-width: 768px) {
            .gallery-grid { grid-template-columns: repeat(2, 1fr); }
            .uses-grid { justify-content: flex-start; }
        }

        /* Store */
        .store { background: var(--charcoal); }

        .store-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 80px;
            align-items: center;
        }

        .store-info h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--cream);
        }

        .store-detail {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 25px;
        }

        .store-detail-icon {
            width: 24px;
            height: 24px;
            color: var(--gold);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .store-detail-text {
            font-size: 1rem;
            color: var(--gray-light);
            line-height: 1.6;
        }

        .store-detail-text strong {
            display: block;
            color: var(--white);
            margin-bottom: 5px;
        }

        .promo-banner {
            background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
            padding: 25px 30px;
            margin-top: 40px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .promo-banner-icon { font-size: 2rem; }

        .promo-banner-text { color: var(--black); }

        .promo-banner-text strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .promo-banner-text span {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .store-map {
            height: 400px;
            background: var(--gray-dark);
            position: relative;
            overflow: hidden;
        }

        .store-map iframe {
            width: 100%;
            height: 100%;
            border: none;
            filter: grayscale(100%) contrast(1.1);
        }

        /* Disclaimers */
        .disclaimers {
            background: var(--black);
            padding: 60px 50px;
        }

        .disclaimers-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .disclaimers-title {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 20px;
        }

        .disclaimers-text {
            font-size: 0.8rem;
            color: var(--gray);
            line-height: 2;
        }

        /* WhatsApp CTA */
        .whatsapp-cta {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #25D366;
            color: white;
            padding: 18px 30px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            box-shadow: 0 10px 40px rgba(37,211,102,0.4);
            transition: all 0.3s ease;
        }

        .whatsapp-cta:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(37,211,102,0.5);
        }

        .whatsapp-cta svg { width: 28px; height: 28px; }

        /* Footer */
        footer {
            background: var(--black);
            padding: 60px 40px 30px;
            text-align: center;
            border-top: 1px solid var(--gray-dark);
        }

        footer .logo {
            font-size: 2rem;
            margin-bottom: 20px;
            display: inline-block;
        }

        footer p {
            font-size: 0.75rem;
            color: var(--gray);
            letter-spacing: 0.1em;
        }

        /* Loading */
        .loading {
            position: fixed;
            inset: 0;
            background: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading.hidden { display: none; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 2px solid var(--gray-dark);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading p {
            font-size: 0.8rem;
            color: var(--gray);
            letter-spacing: 0.1em;
        }

        /* Error */
        .error-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .error-page h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .error-page p { color: var(--gray); }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .product-grid, .store-grid {
                grid-template-columns: 1fr;
                gap: 50px;
            }
            .benefits-grid { grid-template-columns: repeat(2, 1fr); }
            .specs-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            section { padding: 60px 20px; }
            .header { padding: 15px 20px; }
            .header-badge { font-size: 0.6rem; padding: 6px 10px; }

            /* Hero mobile fixes */
            .hero-content { padding: 0 20px 80px; }
            .hero-title {
                font-size: clamp(2.5rem, 10vw, 4rem);
                word-break: break-word;
                hyphens: auto;
                line-height: 1;
            }
            .hero-subtitle {
                font-size: 0.95rem;
                line-height: 1.6;
                padding-right: 20px;
            }
            .hero-tag { font-size: 0.6rem; }

            .benefits-grid { grid-template-columns: 1fr; }
            .product-specs-mini { grid-template-columns: 1fr; }
            .specs-grid { grid-template-columns: 1fr; }

            /* WhatsApp button mobile */
            .whatsapp-cta {
                right: 15px;
                bottom: 15px;
                padding: 12px 18px;
                font-size: 0.85rem;
            }
            .whatsapp-cta svg { width: 22px; height: 22px; }

            .pricing-box { padding: 30px 20px; }
            .price-current { font-size: 2.5rem; }

            /* Action buttons mobile */
            .action-bar { gap: 10px; }
            .action-btn {
                padding: 10px 16px;
                font-size: 0.75rem;
                flex: 1 1 auto;
                justify-content: center;
                min-width: 100px;
            }

            /* Product details mobile */
            .product-details h2 { font-size: 2.5rem; }
            .product-details p { font-size: 0.9rem; }

            /* Section titles mobile */
            .section-title { font-size: 2rem; }

            /* Store section mobile */
            .store-info h3 { font-size: 1.8rem; }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .hero-title { font-size: 2.2rem; }
            .hero-content { padding: 0 15px 100px; }
            .price-current { font-size: 2rem; }
            .action-btn {
                padding: 10px 12px;
                font-size: 0.7rem;
            }
            .section-title { font-size: 1.6rem; }
            .product-details h2 { font-size: 2rem; }
        }

        /* ========== NEW FEATURES STYLES ========== */

        /* Action Buttons Bar */
        .action-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 1px solid var(--gray-dark);
            background: transparent;
            color: var(--cream);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .action-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .action-btn.active {
            background: var(--gold);
            color: var(--black);
            border-color: var(--gold);
        }
        .action-btn svg { width: 18px; height: 18px; }

        /* Calculator Section */
        .calculator-section {
            background: var(--charcoal);
            padding: 60px 20px;
        }
        .calculator-box {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        .calc-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        .calc-input {
            width: 120px;
            padding: 15px;
            font-size: 2rem;
            text-align: center;
            background: var(--black);
            border: 2px solid var(--gray-dark);
            color: var(--gold);
            font-family: 'Cormorant Garamond', serif;
        }
        .calc-input:focus {
            outline: none;
            border-color: var(--gold);
        }
        .calc-label {
            font-size: 1.2rem;
            color: var(--gray-light);
        }
        .calc-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        .calc-result-item {
            background: var(--black);
            padding: 25px;
            border: 1px solid var(--gray-dark);
        }
        .calc-result-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            color: var(--gold);
        }
        .calc-result-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        @media (max-width: 600px) {
            .calc-results { grid-template-columns: 1fr; }
            .calc-input { width: 100px; font-size: 1.5rem; }
        }

        /* Share Buttons */
        .share-section {
            background: var(--black);
            padding: 40px 20px;
            text-align: center;
        }
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .share-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .share-btn.whatsapp { background: #25D366; color: white; }
        .share-btn.email { background: var(--gray-dark); color: white; }
        .share-btn.copy { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
        .share-btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Favorites & Compare */
        .product-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--gray-dark);
            color: var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .icon-btn:hover { background: var(--gold); color: var(--black); border-color: var(--gold); }
        .icon-btn.active { background: var(--gold); color: var(--black); }
        .icon-btn svg { width: 20px; height: 20px; }

        /* Compare Badge */
        .compare-badge {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: var(--gold);
            color: var(--black);
            padding: 15px 25px;
            font-weight: 600;
            cursor: pointer;
            z-index: 90;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .compare-badge.show { display: flex; }
        .compare-badge:hover { transform: scale(1.05); }
        @media (max-width: 500px) {
            .compare-badge {
                bottom: 80px;
                right: 15px;
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }

        /* Sample Request Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--charcoal);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: transparent;
            border: 1px solid var(--gray-dark);
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { border-color: var(--gold); color: var(--gold); }
        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        .modal-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--gray-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 14px;
            background: var(--black);
            border: 1px solid var(--gray-dark);
            color: var(--cream);
            font-size: 1rem;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--gold);
        }
        .form-submit {
            width: 100%;
            padding: 16px;
            background: var(--gold);
            border: none;
            color: var(--black);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .form-submit:hover { background: var(--gold-dark); }
        .form-submit:disabled { background: var(--gray); cursor: not-allowed; }

        /* AI Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 100px;
            left: 30px;
            z-index: 150;
        }
        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(201,162,39,0.4);
            transition: transform 0.3s;
        }
        .chat-toggle:hover { transform: scale(1.1); }
        .chat-toggle svg { width: 28px; height: 28px; color: var(--black); }

        .chat-box {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 350px;
            max-height: 500px;
            background: var(--charcoal);
            border: 1px solid var(--gray-dark);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .chat-box.open { display: flex; }

        .chat-header {
            background: var(--black);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--gray-dark);
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .chat-header-info h4 { font-size: 0.95rem; }
        .chat-header-info span { font-size: 0.75rem; color: #22c55e; }
        .chat-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .chat-message.bot {
            background: var(--black);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-message.user {
            background: var(--gold);
            color: var(--black);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.typing {
            color: var(--gray);
        }
        .chat-message.typing::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--gray-dark);
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--black);
            border: 1px solid var(--gray-dark);
            border-radius: 8px;
            color: var(--cream);
            font-size: 0.9rem;
        }
        .chat-input:focus {
            outline: none;
            border-color: var(--gold);
        }
        .chat-send {
            padding: 12px 20px;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            color: var(--black);
            font-weight: 600;
            cursor: pointer;
        }
        .chat-send:hover { background: var(--gold-dark); }
        .chat-send:disabled { background: var(--gray); cursor: not-allowed; }

        .chat-suggestions {
            padding: 0 15px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .chat-suggestion {
            padding: 8px 12px;
            background: var(--black);
            border: 1px solid var(--gray-dark);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gray-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-suggestion:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        @media (max-width: 500px) {
            .chat-widget { left: 10px; bottom: 80px; }
            .chat-box { width: calc(100vw - 20px); left: -5px; }
            .chat-toggle { width: 45px; height: 45px; }
            .chat-toggle svg { width: 22px; height: 22px; }
        }
        @media (max-width: 400px) {
            .chat-widget { bottom: 75px; }
            .chat-toggle { width: 40px; height: 40px; }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--gold);
            color: var(--black);
            padding: 15px 30px;
            font-weight: 500;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Discount Modal */
        .discount-modal {
            text-align: center;
        }
        .discount-code {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            color: var(--gold);
            background: var(--black);
            padding: 20px 40px;
            margin: 20px 0;
            letter-spacing: 0.2em;
            border: 2px dashed var(--gold);
        }
        .discount-percent {
            font-size: 5rem;
            font-weight: bold;
            color: var(--gold);
        }

        /* Reviews Section */
        .reviews-section {
            background: var(--black);
            padding: 60px 20px;
        }
        .reviews-summary {
            text-align: center;
            margin-bottom: 40px;
        }
        .reviews-stars {
            font-size: 2rem;
            color: var(--gold);
            margin: 10px 0;
        }
        .reviews-count {
            color: var(--gray);
            font-size: 0.9rem;
        }
        .review-card {
            background: var(--charcoal);
            padding: 25px;
            margin-bottom: 15px;
            border-left: 3px solid var(--gold);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .review-author {
            font-weight: 500;
        }
        .review-stars {
            color: var(--gold);
        }
        .review-text {
            color: var(--gray-light);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* ========== ROOM VISUALIZER ========== */
        .room-visualizer {
            background: var(--black);
            padding: 60px 20px;
        }
        .room-visualizer-container {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        .room-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0 20px;
            flex-wrap: wrap;
        }
        .room-tab {
            padding: 12px 24px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-dark);
            color: var(--gray-light);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .room-tab:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .room-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--black);
        }
        .room-preview {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            aspect-ratio: 16/10;
            overflow: hidden;
            border: 1px solid var(--gray-dark);
        }
        .room-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .room-floor-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            background-size: cover;
            background-position: center;
            opacity: 0.85;
            mix-blend-mode: multiply;
        }
        .room-label {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.8);
            color: var(--gold);
            padding: 8px 15px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        @media (max-width: 600px) {
            .room-tabs { gap: 5px; flex-wrap: wrap; }
            .room-tab {
                padding: 8px 12px;
                font-size: 0.7rem;
                flex: 0 0 auto;
            }
            .room-preview { aspect-ratio: 4/3; }
            .room-label { font-size: 0.65rem; padding: 6px 10px; }
        }
        @media (max-width: 400px) {
            .room-tab { padding: 6px 8px; font-size: 0.6rem; }
        }

        /* ========== MSI / PAYMENT OPTIONS ========== */
        .msi-section {
            background: var(--charcoal);
            padding: 40px 20px;
            text-align: center;
        }
        .msi-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .msi-card {
            background: var(--black);
            border: 1px solid var(--gray-dark);
            padding: 25px 35px;
            min-width: 150px;
            transition: all 0.3s;
        }
        .msi-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
        }
        .msi-card.featured {
            border-color: var(--gold);
            position: relative;
        }
        .msi-card.featured::before {
            content: 'Popular';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: var(--black);
            padding: 3px 12px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        .msi-months {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            color: var(--gold);
        }
        .msi-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 5px;
        }
        .msi-amount {
            font-size: 1.1rem;
            color: var(--cream);
            margin-top: 10px;
        }
        .msi-banks {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .msi-bank {
            background: var(--white);
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--black);
            font-weight: 600;
        }
        @media (max-width: 600px) {
            .msi-section { padding: 30px 15px; }
            .msi-section h3 { font-size: 1.4rem; }
            .msi-grid { gap: 10px; }
            .msi-card {
                padding: 15px 20px;
                min-width: 90px;
                flex: 1;
            }
            .msi-months { font-size: 2rem; }
            .msi-amount { font-size: 0.9rem; }
            .msi-banks { gap: 8px; }
            .msi-bank { padding: 6px 10px; font-size: 0.6rem; }
        }

        /* ========== STOCK DISPLAY ========== */
        .stock-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px 20px;
            background: var(--black);
            border: 1px solid var(--gray-dark);
        }
        .stock-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .stock-indicator.high { background: #22c55e; }
        .stock-indicator.medium { background: #f59e0b; }
        .stock-indicator.low { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stock-text {
            font-size: 0.9rem;
            color: var(--cream);
        }
        .stock-count {
            color: var(--gold);
            font-weight: 600;
        }

        /* ========== VENDOR NOTIFICATION BADGE ========== */
        .notification-sent {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--gold);
            color: var(--black);
            padding: 10px 20px;
            font-size: 0.8rem;
            z-index: 100;
            transform: translateX(200%);
            transition: transform 0.4s ease;
        }
        .notification-sent.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Cargando experiencia...</p>
    </div>

    <!-- Error -->
    <div class="error-page hidden" id="error">
        <h1>Producto no encontrado</h1>
        <p>El producto que buscas no está disponible.</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="header" id="header">
            <a href="/" class="logo"><img src="/images/logo-cesantoni.png" alt="Cesantoni" style="height: 40px; width: auto;"></a>
            <div class="header-badge" id="headerBadge">Colección Exclusiva</div>
        </header>

        <!-- Hero -->
        <section class="hero">
            <div class="hero-bg" id="heroBg"></div>
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <span class="hero-tag" id="heroTag">Piso Porcelánico Premium</span>
                <h1 class="hero-title" id="heroTitle">Producto</h1>
                <p class="hero-subtitle" id="heroSubtitle">Descripción del producto.</p>
            </div>
            <div class="scroll-indicator">
                <span>Descubre</span>
                <div class="scroll-line"></div>
            </div>
        </section>

        <!-- Product Showcase -->
        <section class="product-showcase">
            <div class="product-grid">
                <div class="product-image-main">
                    <div class="pei-badge hidden" id="peiBadge">PEI IV</div>
                    <img id="productImage" src="" alt="">
                </div>
                <div class="product-details">
                    <span class="section-label" id="productCategory">Porcelánico Premium</span>
                    <h2 id="productName">Producto</h2>
                    <div class="format" id="productFormat">Formato | Acabado</div>
                    <p id="productDescription">Descripción del producto.</p>
                    
                    <div class="product-specs-mini" id="specsMinigrid"></div>
                </div>
            </div>
        </section>

        <!-- Pricing -->
        <section class="pricing-section" id="pricingSection">
            <div class="pricing-box">
                <span class="section-label">Precio Especial</span>
                <div class="price-original hidden" id="priceOriginal">$000</div>
                <div class="price-current">
                    <span id="priceAmount">$000</span>
                    <span class="price-unit">/m²</span>
                </div>
                <div class="promo-badge-inline hidden" id="promoBadge">🔥 OFERTA ESPECIAL</div>
                <div class="promo-dates hidden" id="promoDates">Válido hasta...</div>

                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn" id="btnFavorite" onclick="toggleFavorite()">
                        <svg id="favIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        <span id="favText">Guardar</span>
                    </button>
                    <button class="action-btn" id="btnCompare" onclick="toggleCompare()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span id="compareText">Comparar</span>
                    </button>
                    <button class="action-btn" onclick="openSampleModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                        Solicitar Muestra
                    </button>
                </div>
            </div>
        </section>

        <!-- Calculator -->
        <section class="calculator-section" id="calculatorSection">
            <div class="calculator-box">
                <span class="section-label">Calculadora</span>
                <h2 class="section-title" style="color: var(--cream);">¿Cuánto necesitas?</h2>

                <div class="calc-input-group">
                    <input type="number" class="calc-input" id="calcM2" placeholder="25" min="1" oninput="calculateTotal()">
                    <span class="calc-label">metros cuadrados</span>
                </div>

                <div class="calc-results">
                    <div class="calc-result-item">
                        <div class="calc-result-value" id="calcBoxes">0</div>
                        <div class="calc-result-label">Cajas</div>
                    </div>
                    <div class="calc-result-item">
                        <div class="calc-result-value" id="calcPieces">0</div>
                        <div class="calc-result-label">Piezas</div>
                    </div>
                    <div class="calc-result-item">
                        <div class="calc-result-value" id="calcTotal">$0</div>
                        <div class="calc-result-label">Costo Total</div>
                    </div>
                </div>

                <div class="action-bar" style="margin-top: 30px;">
                    <button class="action-btn" onclick="generateQuote()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Generar Cotización
                    </button>
                </div>
            </div>
        </section>

        <!-- Room Visualizer -->
        <section class="room-visualizer" id="roomVisualizerSection">
            <div class="room-visualizer-container">
                <span class="section-label">Visualizador</span>
                <h2 class="section-title" style="color: var(--cream); margin: 0 auto;">Visualiza en tu espacio</h2>

                <div class="room-tabs">
                    <button class="room-tab active" data-room="sala" onclick="selectRoom('sala')">🛋️ Sala</button>
                    <button class="room-tab" data-room="comedor" onclick="selectRoom('comedor')">🍽️ Comedor</button>
                    <button class="room-tab" data-room="cocina" onclick="selectRoom('cocina')">🍳 Cocina</button>
                    <button class="room-tab" data-room="bano" onclick="selectRoom('bano')">🚿 Baño</button>
                    <button class="room-tab" data-room="recamara" onclick="selectRoom('recamara')">🛏️ Recámara</button>
                    <button class="room-tab" data-room="terraza" onclick="selectRoom('terraza')">🌿 Terraza</button>
                </div>

                <div class="room-preview">
                    <img id="roomImage" src="https://images.unsplash.com/photo-1618221195710-dd6b41faaea6?w=800" alt="Vista de sala">
                    <div class="room-floor-overlay" id="roomFloorOverlay"></div>
                    <div class="room-label" id="roomLabel">Sala</div>
                </div>
            </div>
        </section>

        <!-- MSI Payment Options -->
        <section class="msi-section" id="msiSection">
            <span class="section-label">Opciones de Pago</span>
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; margin: 10px 0; color: var(--cream);">Meses Sin Intereses</h3>

            <div class="msi-grid" id="msiGrid">
                <div class="msi-card">
                    <div class="msi-months">3</div>
                    <div class="msi-label">meses</div>
                    <div class="msi-amount" id="msi3">$0/mes</div>
                </div>
                <div class="msi-card featured">
                    <div class="msi-months">6</div>
                    <div class="msi-label">meses</div>
                    <div class="msi-amount" id="msi6">$0/mes</div>
                </div>
                <div class="msi-card">
                    <div class="msi-months">12</div>
                    <div class="msi-label">meses</div>
                    <div class="msi-amount" id="msi12">$0/mes</div>
                </div>
            </div>

            <div class="msi-banks">
                <span class="msi-bank">BBVA</span>
                <span class="msi-bank">Banorte</span>
                <span class="msi-bank">Santander</span>
                <span class="msi-bank">HSBC</span>
                <span class="msi-bank">Citibanamex</span>
            </div>
        </section>

        <!-- Share -->
        <section class="share-section">
            <span class="section-label">Comparte</span>
            <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; margin: 15px 0 25px;">¿Te gusta? Compártelo</h3>
            <div class="share-buttons">
                <button class="share-btn whatsapp" onclick="shareWhatsApp()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    WhatsApp
                </button>
                <button class="share-btn email" onclick="shareEmail()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    Email
                </button>
                <button class="share-btn copy" onclick="copyLink()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Copiar Link
                </button>
            </div>
        </section>

        <!-- Video -->
        <section class="video-section" id="videoSection">
            <div class="video-container">
                <video id="productVideo" class="hidden" controls playsinline></video>
                <div class="video-placeholder" id="videoPlaceholder">
                    <div class="video-placeholder-icon"></div>
                    <p>Video experiencia próximamente</p>
                </div>
            </div>
        </section>

        <!-- Benefits -->
        <section class="benefits">
            <div class="section-container">
                <span class="section-label" id="benefitsLabel">¿Por qué elegir este producto?</span>
                <h2 class="section-title" id="benefitsTitle">Excelencia en cada detalle</h2>

                <div class="benefits-grid" id="benefitsGrid">
                    <!-- Se genera dinámicamente según el producto -->
                </div>
            </div>
        </section>

        <!-- Specs -->
        <section class="specs">
            <div class="section-container">
                <span class="section-label" style="color: var(--gold-dark);">Especificaciones Técnicas</span>
                <h2 class="section-title">La ciencia detrás de la belleza</h2>

                <div class="specs-grid" id="specsGrid"></div>
            </div>
        </section>

        <!-- Uses/Applications -->
        <section class="uses-section hidden" id="usesSection">
            <div class="section-container" style="text-align: center;">
                <span class="section-label">Aplicaciones Recomendadas</span>
                <h2 class="section-title" style="margin: 0 auto;">Ideal para cada espacio</h2>
                <div class="uses-grid" id="usesGrid"></div>
            </div>
        </section>

        <!-- Gallery -->
        <section class="gallery-section hidden" id="gallerySection">
            <div class="section-container" style="text-align: center;">
                <span class="section-label">Galería</span>
                <h2 class="section-title" style="margin: 0 auto;">Inspiración visual</h2>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </section>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox">
            <div class="lightbox-close" onclick="closeLightbox()">×</div>
            <img id="lightboxImg" src="" alt="">
        </div>

        <!-- Related Products -->
        <section class="related-section hidden" id="relatedSection">
            <div class="section-container" style="text-align: center;">
                <span class="section-label">Te puede interesar</span>
                <h2 class="section-title" style="margin: 0 auto;">Productos Similares</h2>
                <div class="related-grid" id="relatedGrid"></div>
            </div>
        </section>

        <!-- Store -->
        <section class="store" id="storeSection">
            <div class="section-container">
                <div class="store-grid">
                    <div class="store-info">
                        <span class="section-label">Disponible en</span>
                        <h3 id="storeName">Tienda</h3>
                        
                        <div class="store-detail">
                            <svg class="store-detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <div class="store-detail-text">
                                <strong>Dirección</strong>
                                <span id="storeAddress">Dirección de la tienda</span>
                            </div>
                        </div>
                        
                        <div class="store-detail" id="storePhoneSection">
                            <svg class="store-detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <div class="store-detail-text">
                                <strong>Teléfono</strong>
                                <span id="storePhone">000 000 0000</span>
                            </div>
                        </div>

                        <div class="promo-banner hidden" id="storePromoBanner">
                            <span class="promo-banner-icon">🏷️</span>
                            <div class="promo-banner-text">
                                <strong id="storePromoTitle">Promoción Especial</strong>
                                <span id="storePromoText">Detalles de la promoción</span>
                            </div>
                        </div>

                        <!-- Stock Display -->
                        <div class="stock-display" id="stockDisplay">
                            <div class="stock-indicator high" id="stockIndicator"></div>
                            <div class="stock-text">
                                <span id="stockText">Disponible:</span>
                                <span class="stock-count" id="stockCount">Consultando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="store-map" id="storeMap">
                        <iframe id="mapIframe" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </section>

        <!-- Disclaimers -->
        <section class="disclaimers">
            <div class="disclaimers-content">
                <h4 class="disclaimers-title">Información Importante</h4>
                <p class="disclaimers-text">
                    Precio por metro cuadrado (m²). No incluye instalación.<br>
                    Precios sujetos a cambio sin previo aviso.<br>
                    Consulta disponibilidad en tienda antes de comprar.<br>
                    <span id="disclaimerPromo" class="hidden">Promoción válida solo en tiendas participantes.<br></span>
                    Imágenes de referencia. El color real puede variar.
                </p>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <a href="/" class="logo"><img src="/images/logo-cesantoni.png" alt="Cesantoni" style="height: 35px; width: auto;"></a>
            <p>© 2026 Cesantoni. Tradición e innovación desde 1998.</p>
        </footer>

        <!-- WhatsApp -->
        <a id="whatsappBtn" href="#" class="whatsapp-cta" target="_blank">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            Cotizar por WhatsApp
        </a>

        <!-- Compare Badge -->
        <div class="compare-badge" id="compareBadge" onclick="goToCompare()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Comparar (<span id="compareCount">0</span>)
        </div>

        <!-- Vendor Notification Badge -->
        <div class="notification-sent" id="vendorNotification">
            ✅ Vendedor notificado de tu visita
        </div>

        <!-- Sample Request Modal -->
        <div class="modal-overlay" id="sampleModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeSampleModal()">&times;</button>
                <h2 class="modal-title">Solicitar Muestra Gratis</h2>
                <p class="modal-subtitle">Te enviamos una muestra de <strong id="sampleProductName"></strong> a tu domicilio sin costo.</p>

                <form id="sampleForm" onsubmit="submitSampleRequest(event)">
                    <div class="form-group">
                        <label>Nombre completo</label>
                        <input type="text" id="sampleName" required placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Teléfono / WhatsApp</label>
                        <input type="tel" id="samplePhone" required placeholder="55 1234 5678">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="sampleEmail" placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Dirección de envío</label>
                        <textarea id="sampleAddress" rows="2" required placeholder="Calle, número, colonia, CP, ciudad"></textarea>
                    </div>
                    <button type="submit" class="form-submit" id="sampleSubmit">Solicitar Muestra</button>
                </form>
            </div>
        </div>

        <!-- Quote Modal -->
        <div class="modal-overlay" id="quoteModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeQuoteModal()">&times;</button>
                <h2 class="modal-title">Generar Cotización</h2>
                <p class="modal-subtitle">Recibe tu cotización detallada por email.</p>

                <div style="background: var(--black); padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="color: var(--gray);">Total calculado</div>
                    <div style="font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; color: var(--gold);" id="quoteTotal">$0</div>
                    <div style="color: var(--gray); font-size: 0.85rem;"><span id="quoteM2">0</span> m² de <span id="quoteProduct"></span></div>
                </div>

                <form id="quoteForm" onsubmit="submitQuote(event)">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="quoteName" required placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="quoteEmail" required placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="quotePhone" placeholder="55 1234 5678">
                    </div>
                    <button type="submit" class="form-submit">Enviar Cotización</button>
                </form>
            </div>
        </div>

        <!-- Discount Modal -->
        <div class="modal-overlay" id="discountModal">
            <div class="modal-content discount-modal">
                <button class="modal-close" onclick="closeDiscountModal()">&times;</button>
                <span class="section-label" style="color: var(--gold);">Descuento Exclusivo</span>
                <div class="discount-percent">5%</div>
                <h2 class="modal-title">de descuento adicional</h2>
                <p class="modal-subtitle">Por visitar nuestra experiencia digital. Usa este código en tienda:</p>
                <div class="discount-code" id="discountCode">CES-XXXX</div>
                <p style="color: var(--gray); font-size: 0.8rem;">Válido solo hoy en esta tienda. Presenta este código al vendedor.</p>
                <button class="form-submit" style="margin-top: 20px;" onclick="copyDiscountCode()">Copiar Código</button>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast"></div>

        <!-- AI Chat Widget -->
        <div class="chat-widget">
            <button class="chat-toggle" onclick="toggleChat()" title="Asistente IA">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
            </button>

            <div class="chat-box" id="chatBox">
                <div class="chat-header">
                    <div class="chat-avatar">🤖</div>
                    <div class="chat-header-info">
                        <h4>Asistente Cesantoni</h4>
                        <span>● En línea</span>
                    </div>
                    <button class="chat-close" onclick="toggleChat()">&times;</button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        ¡Hola! Soy tu asistente de Cesantoni. ¿En qué puedo ayudarte con este producto?
                    </div>
                </div>

                <div class="chat-suggestions" id="chatSuggestions">
                    <button class="chat-suggestion" onclick="askSuggestion('¿Cómo se instala este piso?')">Instalación</button>
                    <button class="chat-suggestion" onclick="askSuggestion('¿Qué mantenimiento necesita?')">Mantenimiento</button>
                    <button class="chat-suggestion" onclick="askSuggestion('¿Es resistente al agua?')">Resistencia</button>
                    <button class="chat-suggestion" onclick="askSuggestion('¿Tienen financiamiento?')">Financiamiento</button>
                </div>

                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="chat-send" onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state for new features
        let currentProduct = null;
        let currentPrice = 0;
        let currentStore = null;

        // Get URL params
        const path = window.location.pathname;
        const sku = path.split('/p/')[1]?.split('?')[0];
        const urlParams = new URLSearchParams(window.location.search);
        const storeSlug = urlParams.get('store');

        async function loadProduct() {
            if (!sku) {
                showError();
                return;
            }

            try {
                // Build API URL
                let url = `/api/promotions/for-product/${sku}?`;
                
                // Get store info
                let store = null;
                if (storeSlug) {
                    const storeRes = await fetch(`/api/stores?slug=${storeSlug}`);
                    const stores = await storeRes.json();
                    store = stores.find(s => s.slug === storeSlug);
                    if (store) {
                        url += `store_slug=${storeSlug}&`;
                        url += `state=${encodeURIComponent(store.state || '')}&`;
                        url += `distributor=${encodeURIComponent(store.distributor_name || '')}`;
                    }
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Producto no encontrado');

                const data = await response.json();
                const { product, promotion, final_price, has_promotion } = data;

                renderProduct(product, promotion, final_price, has_promotion, store);
                trackScan(product.id, store?.id);

            } catch (err) {
                console.error('Error:', err);
                showError();
            }
        }

        function renderProduct(product, promotion, finalPrice, hasPromo, store) {
            // Store globals for new features
            currentProduct = product;
            currentPrice = finalPrice;
            currentStore = store;

            // Page title
            document.getElementById('pageTitle').textContent = `${product.name} | Cesantoni Premium`;

            // Parse gallery and filter for unique images of THIS product only
            let galleryImages = [];
            try {
                const rawGallery = product.gallery ? JSON.parse(product.gallery) : [];
                const productSlug = product.slug.toLowerCase().replace(/-/g, '');
                const productName = product.name.toLowerCase().replace(/\s+/g, '');

                // Filter: only images that contain product name/slug, exclude other products
                galleryImages = rawGallery.filter(url => {
                    const urlLower = url.toLowerCase();
                    const fileName = urlLower.split('/').pop();

                    // Must contain product reference OR be generic (piso, render without other product names)
                    const hasProductRef = fileName.includes(productSlug) ||
                                         fileName.includes(productName.replace(/\s/g, '')) ||
                                         fileName.includes(product.name.split(' ')[0].toLowerCase());

                    // Exclude images of other products
                    const otherProducts = ['memphis', 'amberwood', 'nebraska', 'decker', 'alabama', 'blendwood'];
                    const isOtherProduct = otherProducts.some(other =>
                        fileName.includes(other) && !productSlug.includes(other) && !productName.includes(other)
                    );

                    return (hasProductRef || fileName.includes('piso')) && !isOtherProduct;
                });
            } catch(e) { galleryImages = []; }

            // Select different images for hero and product
            const mainImg = product.image_url || '';
            const mainImgName = mainImg.split('/').pop().split('-')[0].toLowerCase();

            // Find a DIFFERENT image for the hero background
            const heroImg = galleryImages.find(img => {
                const imgName = img.split('/').pop().split('-')[0].toLowerCase();
                return imgName !== mainImgName;
            }) || mainImg || 'https://via.placeholder.com/1920x1080?text=' + encodeURIComponent(product.name);

            document.getElementById('heroBg').style.backgroundImage = `url('${heroImg}')`;
            document.getElementById('heroTag').textContent = product.category || 'Piso Porcelánico Premium';
            document.getElementById('heroTitle').textContent = product.name;
            document.getElementById('heroSubtitle').textContent = product.description ||
                `Elegancia y durabilidad premium. Transforma cada espacio en una obra maestra del diseño contemporáneo.`;

            // Product showcase - use main image (different from hero)
            document.getElementById('productImage').src = mainImg || heroImg;
            document.getElementById('productImage').alt = product.name;
            document.getElementById('productCategory').textContent = product.category || 'Porcelánico Premium';
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productFormat').textContent = 
                `${product.format || '60×60 cm'} | ${product.finish || 'Acabado Mate'}`;
            document.getElementById('productDescription').textContent = product.description ||
                `Inspirado en los diseños más elegantes, este piso captura la esencia de la sofisticación con la durabilidad superior del porcelánico.`;

            // Mini specs
            const miniSpecs = [
                { value: product.resistance || 'PEI 4', label: 'Resistencia' },
                { value: product.pieces_per_box ? `${product.pieces_per_box} pzas` : '5 pzas', label: 'Piezas/Caja' },
                { value: product.type || 'Porcelánico', label: 'Tipo' },
                { value: product.usage || 'Int/Ext', label: 'Uso' }
            ];
            document.getElementById('specsMinigrid').innerHTML = miniSpecs.map(s => `
                <div class="spec-mini">
                    <div class="spec-mini-value">${s.value}</div>
                    <div class="spec-mini-label">${s.label}</div>
                </div>
            `).join('');

            // Pricing
            document.getElementById('priceAmount').textContent = `$${formatPrice(finalPrice)}`;
            
            if (hasPromo && promotion) {
                document.getElementById('priceOriginal').textContent = `$${formatPrice(product.base_price)} /m²`;
                document.getElementById('priceOriginal').classList.remove('hidden');
                document.getElementById('promoBadge').textContent = promotion.promo_text || '🔥 OFERTA ESPECIAL';
                document.getElementById('promoBadge').classList.remove('hidden');
                
                const startDate = new Date(promotion.start_date).toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
                const endDate = new Date(promotion.end_date).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
                document.getElementById('promoDates').textContent = `Válido del ${startDate} al ${endDate}`;
                document.getElementById('promoDates').classList.remove('hidden');
                
                document.getElementById('headerBadge').textContent = promotion.promo_text || 'Promoción Especial';
                document.getElementById('disclaimerPromo').classList.remove('hidden');
            }

            // Video
            if (product.video_url) {
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('productVideo').classList.remove('hidden');
                document.getElementById('productVideo').src = product.video_url;
            }

            // Generate personalized benefits
            renderBenefits(product);

            // PEI Badge
            if (product.pei) {
                document.getElementById('peiBadge').textContent = product.pei;
                document.getElementById('peiBadge').classList.remove('hidden');
            }

            // Full specs
            const specs = [
                { value: product.format || '60×60 cm', label: 'Formato' },
                { value: product.pei || product.resistance || 'PEI 4', label: 'Resistencia' },
                { value: product.water_absorption || '<0.5%', label: 'Absorción' },
                { value: product.mohs || '6-7', label: 'Dureza Mohs' },
                { value: product.pieces_per_box || '5 pzas', label: 'Piezas/Caja' },
                { value: product.sqm_per_box ? `${product.sqm_per_box} m²` : '1.20 m²', label: 'm² por Caja' },
                { value: product.type || 'Porcelánico', label: 'Tipo' },
                { value: product.finish || 'Mate', label: 'Acabado' }
            ];
            document.getElementById('specsGrid').innerHTML = specs.map(s => `
                <div class="spec-item">
                    <div class="spec-value">${s.value}</div>
                    <div class="spec-label">${s.label}</div>
                </div>
            `).join('');

            // Uses/Applications
            const usesStr = product.uses || '';
            if (usesStr) {
                const uses = usesStr.split(',').map(u => u.trim()).filter(Boolean);
                if (uses.length > 0) {
                    const useIcons = {
                        'BAÑO': '🚿',
                        'COCINA': '🍳',
                        'INTERIOR': '🏠',
                        'EXTERIOR': '☀️',
                        'COMERCIAL': '🏢',
                        'RESIDENCIAL': '🏡',
                        'FACHADA': '🏛️',
                        'PISCINA': '🏊'
                    };
                    document.getElementById('usesGrid').innerHTML = uses.map(use => `
                        <div class="use-badge">
                            <span class="use-badge-icon">${useIcons[use] || '✓'}</span>
                            <span class="use-badge-text">${use}</span>
                        </div>
                    `).join('');
                    document.getElementById('usesSection').classList.remove('hidden');
                }
            }

            // Gallery - usando galleryImages ya filtradas (sin imágenes de otros productos)
            if (galleryImages.length > 0) {
                // Función para extraer nombre base (sin resolución, prefijos, sufijos)
                const getBaseName = (url) => {
                    let name = url.split('/').pop().toLowerCase();
                    // Quitar extensión
                    name = name.replace(/\.(jpg|jpeg|png|webp)$/, '');
                    // Quitar sufijos de resolución: -scaled, -819x1024, -1024x512, _1, -1, etc.
                    name = name.replace(/-scaled$/, '');
                    name = name.replace(/-?\d{3,4}x\d{3,4}$/, '');
                    name = name.replace(/-e\d+$/, ''); // timestamps como -e1740408990720
                    name = name.replace(/[-_]\d+$/, ''); // sufijos como _1, -1
                    // Quitar prefijos comunes
                    name = name.replace(/^render_?/i, '');
                    name = name.replace(/^vxl_?\d*_?ld_?/i, '');
                    name = name.replace(/^vxlab_?\d*_?/i, '');
                    name = name.replace(/^porcelanato_?/i, '');
                    name = name.replace(/^cesantoni_?/i, '');
                    name = name.replace(/^piedra_porcelanica_?/i, '');
                    name = name.replace(/^cemento_?/i, '');
                    return name;
                };

                // Excluir hero y producto para no repetir
                const heroBaseName = getBaseName(heroImg);
                const mainBaseName = getBaseName(mainImg);
                const seenNames = new Set([heroBaseName, mainBaseName]);

                // También trackear por tipo de espacio para garantizar variedad
                const seenRooms = new Set();
                const roomTypes = ['sala', 'cocina', 'bano', 'sanitario', 'recamara', 'habitacion', 'terraza', 'comedor', 'restaurante', 'exterior'];

                // Filtrar imágenes únicas Y de diferentes espacios
                const uniqueGallery = galleryImages.filter(img => {
                    const baseName = getBaseName(img);
                    const imgLower = img.toLowerCase();

                    // Detectar tipo de espacio
                    const roomType = roomTypes.find(r => imgLower.includes(r)) || 'other';

                    // Rechazar si ya vimos este nombre base
                    if (seenNames.has(baseName)) return false;

                    // Rechazar si ya tenemos imagen de este espacio (para garantizar variedad)
                    if (roomType !== 'other' && seenRooms.has(roomType)) return false;

                    seenNames.add(baseName);
                    if (roomType !== 'other') seenRooms.add(roomType);
                    return true;
                });

                // Priorizar imágenes de diferentes espacios
                const roomPriority = ['cocina', 'sala', 'bano', 'sanitario', 'recamara', 'habitacion', 'terraza', 'comedor', 'restaurante', 'exterior'];
                const sortedGallery = uniqueGallery.sort((a, b) => {
                    const aLower = a.toLowerCase();
                    const bLower = b.toLowerCase();
                    const aRoom = roomPriority.findIndex(r => aLower.includes(r));
                    const bRoom = roomPriority.findIndex(r => bLower.includes(r));
                    if (aRoom !== -1 && bRoom === -1) return -1;
                    if (bRoom !== -1 && aRoom === -1) return 1;
                    if (aRoom !== -1 && bRoom !== -1) return aRoom - bRoom;
                    return 0;
                });

                const finalGallery = sortedGallery.length >= 4 ? sortedGallery : uniqueGallery;

                if (finalGallery.length > 0) {
                    document.getElementById('galleryGrid').innerHTML = finalGallery.slice(0, 4).map((img, i) => `
                        <div class="gallery-item" onclick="openLightbox('${img}')">
                            <img src="${img}" alt="${product.name} - Vista ${i + 1}" loading="lazy">
                        </div>
                    `).join('');
                    document.getElementById('gallerySection').classList.remove('hidden');
                }
            }

            // Related Products
            loadRelatedProducts(product, store);

            // Store
            if (store) {
                document.getElementById('storeName').textContent = store.name;
                document.getElementById('storeAddress').textContent = 
                    `${store.address || ''}, ${store.city || ''}, ${store.state || ''}`;
                document.getElementById('storePhone').textContent = store.phone || store.whatsapp || '';
                
                if (!store.phone && !store.whatsapp) {
                    document.getElementById('storePhoneSection').classList.add('hidden');
                }

                // Map
                const mapQuery = encodeURIComponent(`${store.address || ''} ${store.city || ''} ${store.state || ''} Mexico`);
                document.getElementById('mapIframe').src = 
                    `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${mapQuery}`;

                // Store promo banner
                if (hasPromo && promotion) {
                    document.getElementById('storePromoBanner').classList.remove('hidden');
                    document.getElementById('storePromoTitle').textContent = promotion.promo_text || promotion.name;
                    document.getElementById('storePromoText').textContent = `Precio especial: $${formatPrice(finalPrice)}/m²`;
                }
            } else {
                document.getElementById('storeSection').classList.add('hidden');
            }

            // WhatsApp
            const whatsappNumber = store?.whatsapp || store?.phone || '5215512345678';
            const whatsappMsg = encodeURIComponent(
                `¡Hola! Me interesa el piso ${product.name}` +
                (hasPromo ? ` con la promoción ${promotion.promo_text || promotion.name}` : '') +
                (store ? ` que vi en ${store.name}` : '') +
                `. ¿Podrían darme más información?`
            );
            document.getElementById('whatsappBtn').href = `https://wa.me/${whatsappNumber.replace(/\D/g, '')}?text=${whatsappMsg}`;

            // Show content
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            // Update new features UI
            updateFavoriteUI();
            updateCompareUI();
            checkFirstVisitDiscount();

            // Initialize new features
            initRoomVisualizer();
            initMSI();
            updateStockDisplay(store?.id, product?.id);
            notifyVendor(store, product);
        }

        function formatPrice(price) {
            return Number(price).toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        async function trackScan(productId, storeId) {
            try {
                // Detectar si viene de NFC o QR
                const source = urlParams.get('source') || 'qr';

                await fetch('/api/scans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        store_id: storeId,
                        referrer: document.referrer,
                        user_agent: navigator.userAgent,
                        utm_source: urlParams.get('utm_source'),
                        utm_medium: urlParams.get('utm_medium'),
                        utm_campaign: urlParams.get('utm_campaign'),
                        source: source
                    })
                });
            } catch (e) {
                console.log('Tracking error:', e);
            }
        }

        // Load related products
        async function loadRelatedProducts(product, store) {
            try {
                // Parse related_products JSON
                let relatedSlugs = [];
                try {
                    relatedSlugs = product.related_products ? JSON.parse(product.related_products) : [];
                } catch(e) { relatedSlugs = []; }

                if (relatedSlugs.length === 0) return;

                // Fetch related products data
                const relatedProducts = [];
                for (const slug of relatedSlugs.slice(0, 4)) {
                    try {
                        const res = await fetch(`/api/promotions/for-product/${slug}`);
                        if (res.ok) {
                            const data = await res.json();
                            relatedProducts.push(data.product);
                        }
                    } catch(e) { /* skip */ }
                }

                if (relatedProducts.length > 0) {
                    const storeParam = store ? `?store=${store.slug}` : '';
                    document.getElementById('relatedGrid').innerHTML = relatedProducts.map(p => `
                        <a class="related-card" href="/p/${p.slug || p.sku}${storeParam}">
                            <img src="${p.image_url || ''}" alt="${p.name}" loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/400x400?text=${encodeURIComponent(p.name)}'">
                            <div class="related-card-info">
                                <div class="related-card-name">${p.name}</div>
                                <div class="related-card-format">${p.format || p.category || 'Ver más'}</div>
                            </div>
                        </a>
                    `).join('');
                    document.getElementById('relatedSection').classList.remove('hidden');
                }
            } catch(e) {
                console.log('Error loading related:', e);
            }
        }

        // Generate personalized benefits based on product characteristics
        function renderBenefits(product) {
            const benefits = [];
            const type = (product.type || '').toUpperCase();
            const category = (product.category || '').toUpperCase();
            const finish = (product.finish || '').toLowerCase();
            const usesStr = (product.uses || '').toUpperCase();
            const uses = usesStr.split(',').map(u => u.trim());

            // Benefits based on TYPE (Pasta Blanca, Porcelánico, etc.)
            if (type.includes('PASTA BLANCA')) {
                benefits.push({
                    icon: '🏺',
                    title: 'Pasta Blanca Premium',
                    text: 'Fabricado con arcillas blancas de alta pureza. Base clara que realza los colores y permite acabados más vivos y luminosos.'
                });
                benefits.push({
                    icon: '✨',
                    title: 'Colores Más Vivos',
                    text: 'La pasta blanca permite que los esmaltes y diseños se aprecien con mayor intensidad y fidelidad de color.'
                });
            } else if (type.includes('PORCELÁNICO') && type.includes('RECTIFICADO')) {
                benefits.push({
                    icon: '📐',
                    title: 'Rectificado de Precisión',
                    text: 'Bordes cortados con precisión milimétrica. Permite instalación con junta mínima para un acabado continuo y elegante.'
                });
                benefits.push({
                    icon: '💎',
                    title: 'Porcelánico Premium',
                    text: 'Absorción de agua menor al 0.5%. Máxima resistencia, durabilidad superior y apto para alto tráfico.'
                });
            } else if (type.includes('PORCELÁNICO')) {
                benefits.push({
                    icon: '💎',
                    title: 'Porcelánico de Alta Gama',
                    text: 'Absorción de agua ultrabaja menor al 0.5%. Resistencia excepcional al desgaste, manchas y productos químicos.'
                });
                benefits.push({
                    icon: '🛡️',
                    title: 'Durabilidad Superior',
                    text: 'Fabricado a temperaturas superiores a 1200°C. Estructura compacta que garantiza décadas de belleza sin deterioro.'
                });
            } else {
                benefits.push({
                    icon: '⭐',
                    title: 'Calidad Cesantoni',
                    text: 'Fabricado bajo los más altos estándares de calidad. Garantía de excelencia respaldada por más de 25 años de tradición.'
                });
            }

            // Benefits based on CATEGORY (Madera, Mármol, Piedra, etc.)
            if (category.includes('MADERA') || category.includes('WOOD')) {
                benefits.push({
                    icon: '🌳',
                    title: 'Calidez de la Madera',
                    text: 'Reproduce fielmente las vetas y texturas naturales de la madera. La calidez del wood con la resistencia del porcelánico.'
                });
                benefits.push({
                    icon: '🔄',
                    title: 'Sin Mantenimiento',
                    text: 'A diferencia de la madera natural, no requiere barnizado, lijado ni tratamientos especiales. Fácil limpieza diaria.'
                });
            } else if (category.includes('MÁRMOL') || category.includes('MARBLE')) {
                benefits.push({
                    icon: '🏛️',
                    title: 'Elegancia del Mármol',
                    text: 'Reproduce las vetas únicas y la sofisticación del mármol natural. Cada pieza es una obra de arte arquitectónico.'
                });
                benefits.push({
                    icon: '💫',
                    title: 'Brillo Permanente',
                    text: 'Mantiene su lustre sin necesidad de pulido periódico. Resistente a manchas de vino, café y ácidos cotidianos.'
                });
            } else if (category.includes('PIEDRA') || category.includes('STONE')) {
                benefits.push({
                    icon: '⛰️',
                    title: 'Textura Natural',
                    text: 'Captura la esencia de la piedra natural con texturas táctiles auténticas. Robustez visual con ligereza estructural.'
                });
                benefits.push({
                    icon: '🏔️',
                    title: 'Resistencia Extrema',
                    text: 'Ideal para espacios de alto tránsito. Soporta condiciones exigentes manteniendo su aspecto original.'
                });
            } else if (category.includes('CEMENTO') || category.includes('CONCRETE')) {
                benefits.push({
                    icon: '🏗️',
                    title: 'Estilo Industrial',
                    text: 'El acabado contemporáneo del cemento con las ventajas del porcelánico. Perfecto para diseños modernos y lofts.'
                });
                benefits.push({
                    icon: '🎨',
                    title: 'Versatilidad Total',
                    text: 'Combina con cualquier estilo decorativo. Base neutra que permite destacar mobiliario y accesorios.'
                });
            }

            // Benefits based on USES
            if (uses.includes('EXTERIOR') || uses.includes('FACHADA')) {
                benefits.push({
                    icon: '☀️',
                    title: 'Apto para Exteriores',
                    text: 'Resistente a rayos UV, lluvia y cambios extremos de temperatura. No se decolora ni deteriora con la exposición solar.'
                });
            }
            if (uses.includes('BAÑO') || uses.includes('PISCINA')) {
                benefits.push({
                    icon: '💧',
                    title: 'Resistente a la Humedad',
                    text: 'Impermeabilidad total. No absorbe agua ni genera hongos. Superficie antideslizante disponible para zonas húmedas.'
                });
            }
            if (uses.includes('COMERCIAL')) {
                benefits.push({
                    icon: '🏢',
                    title: 'Uso Comercial Intensivo',
                    text: 'Diseñado para soportar alto tráfico peatonal. Ideal para locales, oficinas, restaurantes y espacios públicos.'
                });
            }

            // Benefits based on FINISH
            if (finish.includes('pulido') || finish.includes('brillante')) {
                benefits.push({
                    icon: '✨',
                    title: 'Acabado Pulido',
                    text: 'Superficie brillante que refleja la luz y amplifica visualmente los espacios. Elegancia incomparable.'
                });
            } else if (finish.includes('mate')) {
                benefits.push({
                    icon: '🎭',
                    title: 'Acabado Mate',
                    text: 'Superficie suave sin reflejos. Aspecto natural y sofisticado que no muestra huellas ni marcas de agua.'
                });
            } else if (finish.includes('lappato') || finish.includes('satinado')) {
                benefits.push({
                    icon: '🌟',
                    title: 'Acabado Satinado',
                    text: 'El equilibrio perfecto entre mate y brillante. Brillo sutil que aporta profundidad sin reflejos excesivos.'
                });
            }

            // Always add installation benefit
            benefits.push({
                icon: '🔧',
                title: 'Fácil Instalación',
                text: 'Dimensiones calibradas para instalación precisa. Compatible con sistemas de calefacción radiante.'
            });

            // Limit to 6 benefits max
            const finalBenefits = benefits.slice(0, 6);

            // Update section title based on product
            const benefitsLabel = document.getElementById('benefitsLabel');
            const benefitsTitle = document.getElementById('benefitsTitle');

            if (type.includes('PASTA BLANCA')) {
                benefitsLabel.textContent = '¿Por qué elegir Pasta Blanca?';
                benefitsTitle.textContent = 'La diferencia está en la base';
            } else if (category.includes('MADERA')) {
                benefitsLabel.textContent = '¿Por qué elegir piso tipo madera?';
                benefitsTitle.textContent = 'Naturaleza y tecnología en armonía';
            } else if (category.includes('MÁRMOL')) {
                benefitsLabel.textContent = '¿Por qué elegir efecto mármol?';
                benefitsTitle.textContent = 'Lujo accesible y duradero';
            } else {
                benefitsLabel.textContent = `¿Por qué elegir ${product.name}?`;
                benefitsTitle.textContent = 'Excelencia en cada detalle';
            }

            // Render benefits grid
            document.getElementById('benefitsGrid').innerHTML = finalBenefits.map(b => `
                <div class="benefit-card">
                    <div class="benefit-icon">${b.icon}</div>
                    <h3 class="benefit-title">${b.title}</h3>
                    <p class="benefit-text">${b.text}</p>
                </div>
            `).join('');
        }

        // Header scroll effect
        window.addEventListener('scroll', () => {
            const header = document.getElementById('header');
            if (header) header.classList.toggle('scrolled', window.scrollY > 100);
        });

        // Lightbox functions
        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target === document.getElementById('lightbox')) {
                closeLightbox();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
                closeSampleModal();
                closeQuoteModal();
                closeDiscountModal();
            }
        });

        // ========== NEW FEATURES JAVASCRIPT ==========

        // ========== CALCULATOR ==========
        function calculateTotal() {
            const m2 = parseFloat(document.getElementById('calcM2').value) || 0;
            const sqmPerBox = currentProduct?.sqm_per_box || 1.44;
            const piecesPerBox = currentProduct?.pieces_per_box || 4;

            const boxes = Math.ceil(m2 / sqmPerBox);
            const pieces = boxes * piecesPerBox;
            const total = m2 * currentPrice;

            document.getElementById('calcBoxes').textContent = boxes;
            document.getElementById('calcPieces').textContent = pieces;
            document.getElementById('calcTotal').textContent = '$' + formatPrice(total);
        }

        // ========== SHARE FUNCTIONS ==========
        function shareWhatsApp() {
            const text = `Mira este piso: ${currentProduct?.name}\n` +
                        `Precio: $${formatPrice(currentPrice)}/m²\n` +
                        `${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareEmail() {
            const subject = `Te comparto: ${currentProduct?.name} | Cesantoni`;
            const body = `Hola,\n\nTe comparto este piso que me gustó:\n\n` +
                        `${currentProduct?.name}\n` +
                        `Precio: $${formatPrice(currentPrice)}/m²\n` +
                        `Categoría: ${currentProduct?.category || 'Porcelánico'}\n\n` +
                        `Ver más: ${window.location.href}\n\n` +
                        `Saludos`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('Link copiado al portapapeles');
            });
        }

        // ========== FAVORITES ==========
        function getFavorites() {
            return JSON.parse(localStorage.getItem('cesantoni_favorites') || '[]');
        }

        function saveFavorites(favorites) {
            localStorage.setItem('cesantoni_favorites', JSON.stringify(favorites));
        }

        function toggleFavorite() {
            if (!currentProduct) return;

            let favorites = getFavorites();
            const index = favorites.findIndex(f => f.sku === currentProduct.sku);

            if (index > -1) {
                favorites.splice(index, 1);
                showToast('Eliminado de favoritos');
            } else {
                favorites.push({
                    sku: currentProduct.sku,
                    name: currentProduct.name,
                    image: currentProduct.image_url,
                    price: currentPrice,
                    category: currentProduct.category
                });
                showToast('Agregado a favoritos');
            }

            saveFavorites(favorites);
            updateFavoriteUI();
        }

        function updateFavoriteUI() {
            if (!currentProduct) return;
            const favorites = getFavorites();
            const isFav = favorites.some(f => f.sku === currentProduct.sku);
            const btn = document.getElementById('btnFavorite');
            const text = document.getElementById('favText');
            const icon = document.getElementById('favIcon');

            if (isFav) {
                btn.classList.add('active');
                text.textContent = 'Guardado';
                icon.setAttribute('fill', 'currentColor');
            } else {
                btn.classList.remove('active');
                text.textContent = 'Guardar';
                icon.setAttribute('fill', 'none');
            }
        }

        // ========== COMPARE ==========
        function getCompareList() {
            return JSON.parse(localStorage.getItem('cesantoni_compare') || '[]');
        }

        function saveCompareList(list) {
            localStorage.setItem('cesantoni_compare', JSON.stringify(list));
        }

        function toggleCompare() {
            if (!currentProduct) return;

            let compareList = getCompareList();
            const index = compareList.findIndex(c => c.sku === currentProduct.sku);

            if (index > -1) {
                compareList.splice(index, 1);
                showToast('Eliminado de comparación');
            } else {
                if (compareList.length >= 4) {
                    showToast('Máximo 4 productos para comparar');
                    return;
                }
                compareList.push({
                    sku: currentProduct.sku,
                    name: currentProduct.name,
                    image: currentProduct.image_url,
                    price: currentPrice,
                    category: currentProduct.category,
                    format: currentProduct.format,
                    finish: currentProduct.finish,
                    type: currentProduct.type,
                    pei: currentProduct.pei || currentProduct.resistance,
                    sqm_per_box: currentProduct.sqm_per_box
                });
                showToast('Agregado a comparación');
            }

            saveCompareList(compareList);
            updateCompareUI();
        }

        function updateCompareUI() {
            const compareList = getCompareList();
            const count = compareList.length;
            const badge = document.getElementById('compareBadge');
            const countSpan = document.getElementById('compareCount');
            const btn = document.getElementById('btnCompare');
            const text = document.getElementById('compareText');

            countSpan.textContent = count;

            if (count > 0) {
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }

            if (currentProduct) {
                const isInCompare = compareList.some(c => c.sku === currentProduct.sku);
                if (isInCompare) {
                    btn.classList.add('active');
                    text.textContent = 'En comparación';
                } else {
                    btn.classList.remove('active');
                    text.textContent = 'Comparar';
                }
            }
        }

        function goToCompare() {
            window.location.href = '/comparar.html';
        }

        // ========== SAMPLE REQUEST ==========
        function openSampleModal() {
            document.getElementById('sampleProductName').textContent = currentProduct?.name || 'este producto';
            document.getElementById('sampleModal').classList.add('show');
        }

        function closeSampleModal() {
            document.getElementById('sampleModal').classList.remove('show');
        }

        async function submitSampleRequest(e) {
            e.preventDefault();
            const btn = document.getElementById('sampleSubmit');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const data = {
                product_id: currentProduct?.id,
                product_name: currentProduct?.name,
                store_id: currentStore?.id,
                store_name: currentStore?.name,
                customer_name: document.getElementById('sampleName').value,
                customer_phone: document.getElementById('samplePhone').value,
                customer_email: document.getElementById('sampleEmail').value,
                address: document.getElementById('sampleAddress').value
            };

            try {
                const res = await fetch('/api/samples', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeSampleModal();
                    showToast('Solicitud enviada. Te contactaremos pronto.');
                    document.getElementById('sampleForm').reset();
                } else {
                    showToast('Error al enviar. Intenta de nuevo.');
                }
            } catch (err) {
                showToast('Error de conexión');
            }

            btn.disabled = false;
            btn.textContent = 'Solicitar Muestra';
        }

        // ========== QUOTE ==========
        function generateQuote() {
            const m2 = parseFloat(document.getElementById('calcM2').value) || 0;
            if (m2 <= 0) {
                showToast('Ingresa los metros cuadrados primero');
                document.getElementById('calcM2').focus();
                return;
            }

            const total = m2 * currentPrice;
            document.getElementById('quoteTotal').textContent = '$' + formatPrice(total);
            document.getElementById('quoteM2').textContent = m2;
            document.getElementById('quoteProduct').textContent = currentProduct?.name || 'Producto';
            document.getElementById('quoteModal').classList.add('show');
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('show');
        }

        async function submitQuote(e) {
            e.preventDefault();
            const m2 = parseFloat(document.getElementById('calcM2').value) || 0;

            const data = {
                product_id: currentProduct?.id,
                product_name: currentProduct?.name,
                product_sku: currentProduct?.sku,
                m2: m2,
                price_per_m2: currentPrice,
                total: m2 * currentPrice,
                store_id: currentStore?.id,
                store_name: currentStore?.name,
                customer_name: document.getElementById('quoteName').value,
                customer_email: document.getElementById('quoteEmail').value,
                customer_phone: document.getElementById('quotePhone').value
            };

            try {
                const res = await fetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeQuoteModal();
                    showToast('Cotización enviada a tu email');
                    document.getElementById('quoteForm').reset();
                } else {
                    showToast('Error al enviar cotización');
                }
            } catch (err) {
                showToast('Error de conexión');
            }
        }

        // ========== DISCOUNT ==========
        function checkFirstVisitDiscount() {
            const shown = localStorage.getItem('cesantoni_discount_shown');
            if (!shown && currentStore) {
                setTimeout(() => {
                    showDiscountModal();
                    localStorage.setItem('cesantoni_discount_shown', 'true');
                }, 5000); // Show after 5 seconds
            }
        }

        function showDiscountModal() {
            const code = generateDiscountCode();
            document.getElementById('discountCode').textContent = code;
            document.getElementById('discountModal').classList.add('show');
        }

        function closeDiscountModal() {
            document.getElementById('discountModal').classList.remove('show');
        }

        function generateDiscountCode() {
            const storePrefix = currentStore?.slug?.substring(0, 3).toUpperCase() || 'CES';
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${storePrefix}-${random}`;
        }

        function copyDiscountCode() {
            const code = document.getElementById('discountCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Código copiado');
            });
        }

        // ========== TOAST ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== AI CHAT ==========
        function toggleChat() {
            const chatBox = document.getElementById('chatBox');
            chatBox.classList.toggle('open');
            if (chatBox.classList.contains('open')) {
                document.getElementById('chatInput').focus();
            }
        }

        function askSuggestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chatMessages');

            // Add user message
            messagesContainer.innerHTML += `<div class="chat-message user">${message}</div>`;
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Hide suggestions after first message
            document.getElementById('chatSuggestions').style.display = 'none';

            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            messagesContainer.innerHTML += `<div class="chat-message bot typing" id="${typingId}">Escribiendo</div>`;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        product: currentProduct ? {
                            name: currentProduct.name,
                            category: currentProduct.category,
                            type: currentProduct.type,
                            format: currentProduct.format,
                            finish: currentProduct.finish,
                            price: currentPrice,
                            description: currentProduct.description,
                            pei: currentProduct.pei,
                            resistance: currentProduct.resistance,
                            uses: currentProduct.uses
                        } : null,
                        store: currentStore ? {
                            name: currentStore.name,
                            address: currentStore.address,
                            city: currentStore.city,
                            state: currentStore.state,
                            phone: currentStore.phone,
                            whatsapp: currentStore.whatsapp
                        } : null
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById(typingId)?.remove();

                // Add bot response
                const reply = data.reply || 'Lo siento, hubo un error. ¿Puedes intentar de nuevo?';
                messagesContainer.innerHTML += `<div class="chat-message bot">${reply}</div>`;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (err) {
                console.error('Chat error:', err);
                document.getElementById(typingId)?.remove();
                messagesContainer.innerHTML += `<div class="chat-message bot">Lo siento, no pude conectar. Intenta de nuevo o contacta por WhatsApp.</div>`;
            }
        }

        // ========== ROOM VISUALIZER ==========
        // Default fallback images (Unsplash)
        const defaultRoomImages = {
            sala: 'https://images.unsplash.com/photo-1618221195710-dd6b41faaea6?w=800',
            cocina: 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=800',
            bano: 'https://images.unsplash.com/photo-1552321554-5fefe8c9ef14?w=800',
            recamara: 'https://images.unsplash.com/photo-1617325247661-675ab4b64ae2?w=800',
            terraza: 'https://images.unsplash.com/photo-1600566753376-12c8ab7fb75b?w=800'
        };

        // Product-specific room images (populated from gallery)
        let productRoomImages = {};

        const roomLabels = {
            sala: 'Sala',
            comedor: 'Comedor',
            cocina: 'Cocina',
            bano: 'Baño',
            recamara: 'Recámara',
            terraza: 'Terraza'
        };

        // Keywords to match gallery images to rooms
        const roomKeywords = {
            sala: ['sala', 'living', 'estancia', 'recibidor'],
            comedor: ['comedor', 'dining', 'mesa'],
            cocina: ['cocina', 'kitchen', 'credenza'],
            bano: ['bano', 'baño', 'bath', 'wc', 'regadera'],
            recamara: ['recamara', 'habitacion', 'bedroom', 'cuarto', 'dormitorio'],
            terraza: ['exterior', 'terraza', 'patio', 'jardin', 'fachada', 'balcon', 'outdoor']
        };

        function matchGalleryToRooms(gallery) {
            const matched = {};
            if (!gallery || !Array.isArray(gallery)) return matched;

            gallery.forEach(url => {
                const urlLower = url.toLowerCase();
                for (const [room, keywords] of Object.entries(roomKeywords)) {
                    if (!matched[room]) {
                        for (const keyword of keywords) {
                            if (urlLower.includes(keyword)) {
                                matched[room] = url;
                                break;
                            }
                        }
                    }
                }
            });

            // NO fallback - solo mostrar tabs con imágenes reales que coinciden
            return matched;
        }

        function selectRoom(room) {
            // Update tabs
            document.querySelectorAll('.room-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.room-tab[data-room="${room}"]`).classList.add('active');

            // Use product gallery image if available, otherwise default
            const imgSrc = productRoomImages[room] || defaultRoomImages[room];
            document.getElementById('roomImage').src = imgSrc;
            document.getElementById('roomLabel').textContent = roomLabels[room];

            // Hide floor overlay if using product gallery (image already shows floor)
            const overlay = document.getElementById('roomFloorOverlay');
            if (productRoomImages[room]) {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'block';
                if (currentProduct?.image_url) {
                    overlay.style.backgroundImage = `url(${currentProduct.image_url})`;
                }
            }
        }

        function initRoomVisualizer() {
            // Parse product gallery and match to rooms
            if (currentProduct?.gallery) {
                try {
                    const gallery = typeof currentProduct.gallery === 'string'
                        ? JSON.parse(currentProduct.gallery)
                        : currentProduct.gallery;
                    productRoomImages = matchGalleryToRooms(gallery);
                } catch (e) {
                    productRoomImages = {};
                }
            }

            // Ocultar tabs sin imagen real del producto
            const rooms = ['sala', 'comedor', 'cocina', 'bano', 'recamara', 'terraza'];
            let firstAvailable = null;
            let availableCount = 0;

            rooms.forEach(room => {
                const tab = document.querySelector(`.room-tab[data-room="${room}"]`);
                if (tab) {
                    if (productRoomImages[room]) {
                        tab.style.display = 'flex';
                        if (!firstAvailable) firstAvailable = room;
                        availableCount++;
                    } else {
                        tab.style.display = 'none';
                    }
                }
            });

            // Si no hay imágenes reales, ocultar toda la sección
            const visualizerSection = document.getElementById('roomVisualizerSection');
            if (availableCount === 0) {
                if (visualizerSection) visualizerSection.classList.add('hidden');
                return;
            } else {
                if (visualizerSection) visualizerSection.classList.remove('hidden');
            }

            // Seleccionar el primer room disponible
            if (firstAvailable) {
                selectRoom(firstAvailable);
            }
        }

        // ========== MSI PAYMENT OPTIONS ==========
        function updateMSI(totalAmount) {
            const msi3 = Math.ceil(totalAmount / 3);
            const msi6 = Math.ceil(totalAmount / 6);
            const msi12 = Math.ceil(totalAmount / 12);

            document.getElementById('msi3').textContent = '$' + formatPrice(msi3) + '/mes';
            document.getElementById('msi6').textContent = '$' + formatPrice(msi6) + '/mes';
            document.getElementById('msi12').textContent = '$' + formatPrice(msi12) + '/mes';
        }

        function initMSI() {
            // Calculate for 10m² as default example
            const defaultM2 = 10;
            const total = defaultM2 * currentPrice;
            updateMSI(total);
        }

        // Override calculateTotal to also update MSI
        const originalCalculateTotal = calculateTotal;
        calculateTotal = function() {
            const m2 = parseFloat(document.getElementById('calcM2').value) || 0;
            const sqmPerBox = currentProduct?.sqm_per_box || 1.44;
            const piecesPerBox = currentProduct?.pieces_per_box || 4;

            const boxes = Math.ceil(m2 / sqmPerBox);
            const pieces = boxes * piecesPerBox;
            const total = m2 * currentPrice;

            document.getElementById('calcBoxes').textContent = boxes;
            document.getElementById('calcPieces').textContent = pieces;
            document.getElementById('calcTotal').textContent = '$' + formatPrice(total);

            // Update MSI when calculator changes
            if (m2 > 0) {
                updateMSI(total);
            }
        };

        // ========== STOCK DISPLAY ==========
        function updateStockDisplay(storeId, productId) {
            // Simulate stock based on store and product
            // In a real implementation, this would fetch from an inventory API
            const seed = (storeId || 1) * (productId || 1);
            const stockLevels = ['high', 'medium', 'low'];
            const stockLevel = stockLevels[seed % 3];

            // Generate a realistic stock number
            const baseStock = stockLevel === 'high' ? 50 : stockLevel === 'medium' ? 15 : 5;
            const variation = Math.floor(Math.random() * 10);
            const stock = baseStock + variation;

            const indicator = document.getElementById('stockIndicator');
            const countEl = document.getElementById('stockCount');
            const textEl = document.getElementById('stockText');

            indicator.className = 'stock-indicator ' + stockLevel;

            if (stockLevel === 'high') {
                countEl.textContent = stock + '+ cajas disponibles';
                textEl.textContent = '✓ En stock:';
            } else if (stockLevel === 'medium') {
                countEl.textContent = stock + ' cajas disponibles';
                textEl.textContent = 'Stock limitado:';
            } else {
                countEl.textContent = 'Últimas ' + stock + ' cajas';
                textEl.textContent = '⚠️ Pocas unidades:';
            }
        }

        // ========== VENDOR NOTIFICATION ==========
        async function notifyVendor(store, product) {
            if (!store?.whatsapp) return;

            // Only notify once per session per product
            const notifiedKey = `notified_${product?.id}_${store?.id}`;
            if (sessionStorage.getItem(notifiedKey)) return;

            try {
                // In production, this would send a server-side notification
                // For now, we track the scan and show a visual indicator
                sessionStorage.setItem(notifiedKey, 'true');

                // Show notification badge
                const badge = document.getElementById('vendorNotification');
                badge.classList.add('show');
                setTimeout(() => badge.classList.remove('show'), 4000);

                // Log the notification (could be sent to server)
                console.log('Vendor notification:', {
                    store: store.name,
                    whatsapp: store.whatsapp,
                    product: product.name,
                    time: new Date().toISOString()
                });
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        // Init compare badge
        updateCompareUI();

        // Init
        loadProduct();
    </script>
</body>
</html>
