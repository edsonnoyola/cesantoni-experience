<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesantoni Experience - CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1a1a1a; --accent: #c41e3a; --green: #28a745; --gold: #C9A962; --gold-light: #F5EED6; --gold-dark: #8B7340; --gray: #FAFAF8; --gray-100: #F5F4F0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--gray); color: var(--primary); }
        
        /* Sidebar */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 220px; background: var(--primary); padding: 20px 0; z-index: 100; }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .logo h1 { font-family: 'Playfair Display', serif; color: white; font-size: 1.3rem; }
        .logo span { color: var(--gold); font-size: 0.75rem; }
        .nav-item, a.nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: rgba(255,255,255,0.6); cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(201,169,98,0.1); color: var(--gold); border-left: 3px solid var(--gold); }
        
        /* Main */
        .main { margin-left: 220px; padding: 28px 32px; min-height: 100vh; }
        
        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.6rem; }
        .period-select { padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; background: white; }
        
        /* Stats Grid */
        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stat-card .label { font-size: 0.75rem; color: #888; margin-bottom: 4px; text-transform: uppercase; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; }
        .stat-card .change { font-size: 0.75rem; margin-top: 4px; }
        .stat-card .change.up { color: var(--green); }
        .stat-card .change.down { color: var(--accent); }
        
        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 20px; }
        
        /* Cards */
        .card { background: white; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-family: 'Playfair Display', serif; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .card-action { font-size: 0.75rem; color: var(--accent); cursor: pointer; }
        
        /* Heat Map */
        .mexico-map { position: relative; width: 100%; }
        .mexico-map svg { width: 100%; height: auto; }
        .mexico-map path { fill: #e0e0e0; stroke: white; stroke-width: 1; transition: all 0.2s; cursor: pointer; }
        .mexico-map path:hover { opacity: 0.8; }
        .heat-0 { fill: #f0f0f0; }
        .heat-1 { fill: #ffebee; }
        .heat-2 { fill: #ffcdd2; }
        .heat-3 { fill: #ef9a9a; }
        .heat-4 { fill: #e57373; }
        .heat-5 { fill: #ef5350; }
        .heat-6 { fill: #c41e3a; }
        .map-legend { display: flex; justify-content: center; gap: 8px; margin-top: 12px; font-size: 0.7rem; }
        .map-legend span { display: flex; align-items: center; gap: 4px; }
        .map-legend .dot { width: 12px; height: 12px; border-radius: 2px; }
        
        /* Rankings */
        .ranking-list { list-style: none; }
        .ranking-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-pos { width: 24px; height: 24px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; }
        .ranking-pos.gold { background: var(--gold); color: white; }
        .ranking-pos.silver { background: #aaa; color: white; }
        .ranking-pos.bronze { background: #cd7f32; color: white; }
        .ranking-info { flex: 1; }
        .ranking-name { font-size: 0.85rem; font-weight: 600; }
        .ranking-sub { font-size: 0.7rem; color: #888; }
        .ranking-value { font-weight: 700; color: var(--accent); }
        
        /* Chart */
        .chart-container { position: relative; height: 200px; }
        
        /* Alerts */
        .alert-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff8e1; border-radius: 6px; margin-bottom: 8px; font-size: 0.8rem; }
        .alert-item.danger { background: #ffebee; }
        .alert-item .icon { font-size: 1.2rem; }
        
        /* Promos */
        .promo-mini { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.8rem; }
        .promo-mini:last-child { border-bottom: none; }
        .promo-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .promo-badge.active { background: #d4edda; color: #155724; }
        .promo-badge.expiring { background: #fff3cd; color: #856404; }
        
        /* Terra conversations */
        .terra-msg { padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.8rem; }
        .terra-msg:last-child { border-bottom: none; }
        .terra-msg .terra-q { color: #333; font-weight: 500; }
        .terra-msg .terra-a { color: #888; font-size: 0.75rem; margin-top: 2px; }
        .terra-msg .terra-meta { font-size: 0.65rem; color: #bbb; margin-top: 2px; }
        .terra-stat { display: inline-block; background: #f5f5f5; border-radius: 12px; padding: 4px 10px; font-size: 0.75rem; margin: 2px; }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Productos page */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .product-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.2s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .product-card-img { height: 120px; background: #f5f5f5 center/cover; }
        .product-card-body { padding: 12px; }
        .product-card-body h4 { font-size: 0.9rem; margin-bottom: 4px; }
        .product-card-body p { font-size: 0.75rem; color: #888; }
        
        /* Filters */
        .filters-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-chip { padding: 6px 14px; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        .filter-chip:hover, .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        .search-input { padding: 10px 16px; border: 1px solid #ddd; border-radius: 8px; width: 300px; }
        
        /* Promo section */
        .promo-filters { display: flex; flex-direction: column; gap: 12px; }
        .filter-section { padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .filter-label { font-weight: 600; font-size: 0.8rem; color: #666; }
        .filter-grid { display: flex; flex-wrap: wrap; gap: 6px; max-height: 120px; overflow-y: auto; }
        .filter-chip2 { padding: 5px 10px; background: #f5f5f5; border: 2px solid transparent; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }
        .filter-chip2:hover { background: #eee; }
        .filter-chip2.selected { background: #fef2f2; border-color: var(--accent); }
        .chip-btn { padding: 3px 8px; font-size: 0.65rem; background: #eee; border: none; border-radius: 4px; cursor: pointer; margin-left: 4px; }
        
        .promo-summary { display: flex; justify-content: space-around; background: linear-gradient(135deg, var(--accent), #a01830); color: white; padding: 16px; border-radius: 8px; margin: 12px 0; text-align: center; }
        .promo-summary .big { font-size: 1.8rem; font-weight: 700; }
        .promo-summary .lbl { font-size: 0.7rem; opacity: 0.8; }
        
        .promo-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; }
        .promo-form input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        
        .promo-group { border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
        .promo-group-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #fafafa; cursor: pointer; font-size: 0.85rem; }
        .promo-group-items { display: none; }
        .promo-group.open .promo-group-items { display: block; }
        .promo-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-top: 1px solid #eee; font-size: 0.8rem; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #a01830; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-sm { padding: 4px 10px; font-size: 0.7rem; }
        
        /* Landing grid */
        .landing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .landing-card { background: white; border: 1px solid #eee; border-radius: 10px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .landing-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .landing-card-img { height: 100px; background: #f5f5f5 center/cover; }
        .landing-card-body { padding: 10px; }
        .landing-card-body h4 { font-size: 0.85rem; }
        .landing-card-body .price { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
        
        /* Tooltip */
        .tooltip { position: absolute; background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; pointer-events: none; z-index: 1000; }
        
        /* Badge */
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        
        /* Period pills */
        .period-pills { display: flex; gap: 4px; }
        .period-pill { padding: 6px 16px; border: 1px solid #e0e0e0; background: white; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #888; }
        .period-pill:hover { border-color: var(--gold); color: var(--gold); }
        .period-pill.active { background: var(--gold); color: white; border-color: var(--gold); }

        /* Funnel redesign */
        .funnel-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .funnel-steps { display: flex; flex-direction: column; align-items: center; gap: 0; padding: 8px 0; }
        .funnel-step { position: relative; text-align: center; padding: 14px 0; width: 100%; }
        .funnel-step-bar { margin: 0 auto; height: 44px; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: width 0.5s ease; }
        .funnel-step-bar .step-value { font-size: 1rem; font-weight: 700; color: white; }
        .funnel-step-bar .step-label { font-size: 0.72rem; color: rgba(255,255,255,0.85); }
        .funnel-dropoff { font-size: 0.65rem; color: #bbb; padding: 2px 0; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .funnel-dropoff span { color: var(--accent); font-weight: 600; }
        .funnel-sidebar { display: flex; flex-direction: column; gap: 16px; }
        .rate-card { background: var(--gray-100); border-radius: 10px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; }
        .rate-card .rate-value { font-size: 1.4rem; font-weight: 700; color: var(--gold-dark); }
        .rate-card .rate-label { font-size: 0.7rem; color: #888; }
        .rate-card .rate-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; background: var(--gold-light); }
        .funnel-products { margin-top: auto; }
        .funnel-products .fp-title { font-size: 0.72rem; color: #888; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .funnel-product-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.8rem; }
        .funnel-product-item .fp-rank { width: 22px; height: 22px; border-radius: 50%; background: var(--gold-light); color: var(--gold-dark); font-size: 0.65rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .funnel-product-item .fp-rank.top { background: var(--gold); color: white; }
        .funnel-product-item .fp-name { flex: 1; color: #444; }
        .funnel-product-item .fp-count { font-weight: 700; color: var(--gold-dark); }

        /* Leads summary widget */
        .leads-summary { display: flex; flex-direction: column; gap: 16px; }
        .source-bar-container { display: flex; flex-direction: column; gap: 6px; }
        .source-bar { height: 8px; border-radius: 4px; overflow: hidden; display: flex; background: var(--gray-100); }
        .source-bar .seg { height: 100%; transition: width 0.4s ease; }
        .source-bar .seg-landing { background: #3498db; }
        .source-bar .seg-terra { background: var(--gold); }
        .source-bar .seg-wa { background: #25D366; }
        .source-legend { display: flex; gap: 14px; font-size: 0.68rem; color: #888; }
        .source-legend .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; vertical-align: middle; }
        .lead-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .lead-stat { background: var(--gray-100); border-radius: 10px; padding: 12px; text-align: center; }
        .lead-stat .ls-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .lead-stat .ls-label { font-size: 0.65rem; color: #888; text-transform: uppercase; margin-top: 2px; }
        .lead-stat.highlight { background: var(--gold-light); }
        .lead-stat.highlight .ls-value { color: var(--gold-dark); }
        .recent-leads-list { display: flex; flex-direction: column; gap: 0; }
        .recent-lead { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s; }
        .recent-lead:last-child { border-bottom: none; }
        .recent-lead:hover { background: #fafafa; margin: 0 -8px; padding: 10px 8px; border-radius: 8px; }
        .lead-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: white; flex-shrink: 0; }
        .lead-avatar.src-landing { background: #3498db; }
        .lead-avatar.src-terra { background: var(--gold); }
        .lead-avatar.src-wa { background: #25D366; }
        .recent-lead .rl-info { flex: 1; min-width: 0; }
        .recent-lead .rl-name { font-size: 0.82rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recent-lead .rl-meta { font-size: 0.68rem; color: #999; }
        .recent-lead .rl-time { font-size: 0.65rem; color: #bbb; white-space: nowrap; }

        /* Skeleton loading */
        @keyframes skeleton-pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-pulse 1.5s ease-in-out infinite; border-radius: 6px; }

        @media (max-width: 1200px) {
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .grid-3 { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 900px) {
            .sidebar { width: 60px; }
            .sidebar .logo h1, .sidebar .logo span, .nav-item span:last-child { display: none; }
            .main { margin-left: 60px; padding: 20px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .grid-2, .grid-2-1 { grid-template-columns: 1fr; }
            .funnel-layout { grid-template-columns: 1fr; }
            .lead-stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <img src="/images/logo-cesantoni.png" alt="Cesantoni" style="width: 160px; height: auto; margin-bottom: 5px;">
            <span>Experience CRM</span>
        </div>
        <div class="nav-item active" onclick="showPage('dashboard')">üìä <span>Dashboard</span></div>
        <div class="nav-item" onclick="showPage('leads')">üéØ <span>Leads</span></div>
        <div class="nav-item" onclick="showPage('productos')">üì¶ <span>Productos</span></div>
        <div class="nav-item" onclick="showPage('tiendas')">üè™ <span>Tiendas</span></div>
        <a href="/qr-tiendas.html" class="nav-item" style="text-decoration:none;">üì± <span>Generar QRs</span></a>
        <a href="/nfc.html" class="nav-item" style="text-decoration:none;">üì≤ <span>NFC Tags</span></a>
        <a href="/qr-terra.html" class="nav-item" style="text-decoration:none;">ü§ñ <span>QR Terra</span></a>
        <div class="nav-item" onclick="showPage('whatsapp')">üí¨ <span>WhatsApp Bot</span></div>
        <div class="nav-item" onclick="showPage('promociones')">üí∞ <span>Promociones</span></div>
        <a href="/landings.html" class="nav-item" style="text-decoration:none;">üìÑ <span>Landings</span></a>
    </nav>

    <main class="main">
        <!-- ==================== DASHBOARD ==================== -->
        <div id="page-dashboard" class="page active">
            <div class="page-header">
                <h1>Dashboard</h1>
                <select class="period-select" id="period" onchange="loadDashboard()">
                    <option value="7">√öltimos 7 d√≠as</option>
                    <option value="30" selected>√öltimos 30 d√≠as</option>
                    <option value="90">√öltimos 90 d√≠as</option>
                </select>
            </div>
            
            <!-- KPIs -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="label">Escaneos</div>
                    <div class="value" id="kpi-scans">-</div>
                    <div class="change up" id="kpi-scans-change">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Clicks WhatsApp</div>
                    <div class="value" id="kpi-wa">-</div>
                    <div class="change" id="kpi-wa-change">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Conversi√≥n</div>
                    <div class="value" id="kpi-conv">-</div>
                    <div class="change" id="kpi-conv-change">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Tiendas Activas</div>
                    <div class="value" id="kpi-stores">-</div>
                    <div class="change" id="kpi-stores-change">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Promos Activas</div>
                    <div class="value" id="kpi-promos">-</div>
                </div>
            </div>
            
            <!-- Map + Trend -->
            <div class="grid-2-1">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Escaneos por Estado</span>
                    </div>
                    <div class="mexico-map" id="mexico-map"></div>
                    <div class="map-legend">
                        <span><div class="dot heat-1"></div> 1-10</span>
                        <span><div class="dot heat-2"></div> 11-25</span>
                        <span><div class="dot heat-3"></div> 26-50</span>
                        <span><div class="dot heat-4"></div> 51-100</span>
                        <span><div class="dot heat-5"></div> 101-200</span>
                        <span><div class="dot heat-6"></div> 200+</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Tendencia</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Rankings -->
            <div class="grid-3">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Productos</span>
                    </div>
                    <ul class="ranking-list" id="top-products"></ul>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Tiendas</span>
                    </div>
                    <ul class="ranking-list" id="top-stores"></ul>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Estados</span>
                    </div>
                    <ul class="ranking-list" id="top-states"></ul>
                </div>
            </div>
            
            <!-- Terra Insights -->
            <div class="grid-2" style="margin-bottom:20px">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Terra - Resumen IA</span>
                        <span class="card-action" id="terra-refresh" onclick="loadTerraInsights()" style="cursor:pointer">Actualizar ‚Üí</span>
                    </div>
                    <div id="terra-summary" style="font-size:0.85rem;line-height:1.5;color:#444;max-height:300px;overflow-y:auto">
                        <span style="color:#aaa">Cargando insights de Terra...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Ultimas preguntas</span>
                        <span style="font-size:0.7rem;color:#888" id="terra-total"></span>
                    </div>
                    <div id="terra-recent" style="max-height:300px;overflow-y:auto">
                        <span style="color:#aaa;font-size:0.85rem">Sin conversaciones a√∫n</span>
                    </div>
                </div>
            </div>

            <!-- Terra Store Sessions (Phase 6) -->
            <div class="grid-2" style="margin-bottom:20px">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Visitas Terra</span>
                        <span class="card-action" onclick="loadTerraSessions()">Actualizar ‚Üí</span>
                    </div>
                    <div id="terra-sessions-stats" style="display:flex;justify-content:space-around;text-align:center;padding:12px 0;border-bottom:1px solid #f0f0f0;margin-bottom:8px">
                        <div><div style="font-size:1.4rem;font-weight:700" id="ts-total">-</div><div style="font-size:0.65rem;color:#888">Visitas</div></div>
                        <div><div style="font-size:1.4rem;font-weight:700" id="ts-avg-products">-</div><div style="font-size:0.65rem;color:#888">Pisos/visita</div></div>
                        <div><div style="font-size:1.4rem;font-weight:700" id="ts-avg-duration">-</div><div style="font-size:0.65rem;color:#888">Min prom</div></div>
                        <div><div style="font-size:1.4rem;font-weight:700" id="ts-wa-rate">-</div><div style="font-size:0.65rem;color:#888">WhatsApp %</div></div>
                    </div>
                    <div id="terra-sessions-list" style="max-height:200px;overflow-y:auto;font-size:0.8rem">
                        <span style="color:#aaa">Cargando sesiones...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Detalle de Visitas</span>
                    </div>
                    <div id="terra-sessions-detail" style="max-height:280px;overflow-y:auto;font-size:0.8rem">
                        <span style="color:#aaa">Selecciona una visita para ver detalle</span>
                    </div>
                </div>
            </div>

            <!-- FUNNEL ANALYTICS -->
            <div style="margin-bottom:20px">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Funnel de Conversion</span>
                        <div style="display:flex;align-items:center;gap:12px">
                            <div class="period-pills">
                                <button class="period-pill" onclick="setFunnelDays(7)" data-days="7">7d</button>
                                <button class="period-pill active" onclick="setFunnelDays(30)" data-days="30">30d</button>
                                <button class="period-pill" onclick="setFunnelDays(90)" data-days="90">90d</button>
                            </div>
                        </div>
                    </div>
                    <div id="funnel-viz">
                        <div class="funnel-layout">
                            <div class="funnel-steps" id="funnel-steps">
                                <!-- Skeleton loading -->
                                <div class="funnel-step"><div class="skeleton" style="width:100%;height:44px;margin:0 auto"></div></div>
                                <div class="funnel-step"><div class="skeleton" style="width:85%;height:44px;margin:0 auto"></div></div>
                                <div class="funnel-step"><div class="skeleton" style="width:65%;height:44px;margin:0 auto"></div></div>
                                <div class="funnel-step"><div class="skeleton" style="width:45%;height:44px;margin:0 auto"></div></div>
                                <div class="funnel-step"><div class="skeleton" style="width:30%;height:44px;margin:0 auto"></div></div>
                            </div>
                            <div class="funnel-sidebar">
                                <div id="funnel-rates"></div>
                                <div class="funnel-products" id="funnel-top-products"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEADS SUMMARY -->
            <div style="margin-bottom:20px">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Leads</span>
                        <span class="card-action" onclick="showPage('leads')">Ver todos ‚Üí</span>
                    </div>
                    <div class="leads-summary" id="leads-widget">
                        <!-- Source bar -->
                        <div class="source-bar-container">
                            <div class="source-bar" id="leads-source-bar"></div>
                            <div class="source-legend" id="leads-source-legend"></div>
                        </div>
                        <!-- Stats -->
                        <div class="lead-stats-grid" id="leads-stats-grid">
                            <div class="lead-stat highlight"><div class="ls-value">-</div><div class="ls-label">Total</div></div>
                            <div class="lead-stat"><div class="ls-value">-</div><div class="ls-label">Nuevos</div></div>
                            <div class="lead-stat"><div class="ls-value">-</div><div class="ls-label">Contactados</div></div>
                            <div class="lead-stat"><div class="ls-value">-</div><div class="ls-label">Convertidos</div></div>
                        </div>
                        <!-- Recent leads -->
                        <div>
                            <div style="font-size:0.72rem;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Recientes</div>
                            <div class="recent-leads-list" id="leads-recent">
                                <div class="recent-lead"><div class="skeleton" style="width:36px;height:36px;border-radius:50%"></div><div style="flex:1"><div class="skeleton" style="width:60%;height:12px;margin-bottom:6px"></div><div class="skeleton" style="width:40%;height:10px"></div></div></div>
                                <div class="recent-lead"><div class="skeleton" style="width:36px;height:36px;border-radius:50%"></div><div style="flex:1"><div class="skeleton" style="width:55%;height:12px;margin-bottom:6px"></div><div class="skeleton" style="width:35%;height:10px"></div></div></div>
                                <div class="recent-lead"><div class="skeleton" style="width:36px;height:36px;border-radius:50%"></div><div style="flex:1"><div class="skeleton" style="width:50%;height:12px;margin-bottom:6px"></div><div class="skeleton" style="width:45%;height:10px"></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts + Promos -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Alertas</span>
                    </div>
                    <div id="alerts-list"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Promociones</span>
                        <span class="card-action" onclick="showPage('promociones')">Ver todas ‚Üí</span>
                    </div>
                    <div id="promos-summary"></div>
                </div>
            </div>
        </div>
        
        <!-- ==================== PRODUCTOS ==================== -->
        <div id="page-productos" class="page">
            <div class="page-header">
                <h1>Productos</h1>
                <input type="text" class="search-input" placeholder="Buscar producto..." id="search-products" oninput="filterProducts()">
            </div>
            <div class="filters-row" id="category-filters"></div>
            <div class="products-grid" id="products-grid"></div>
        </div>
        
        <!-- ==================== TIENDAS ==================== -->
        <div id="page-tiendas" class="page">
            <div class="page-header">
                <h1>Tiendas</h1>
            </div>
            <div class="filters-row">
                <select id="filter-dist" onchange="filterStores()"><option value="">Todos los distribuidores</option></select>
                <select id="filter-state" onchange="filterStores()"><option value="">Todos los estados</option></select>
            </div>
            <div id="stores-list"></div>
        </div>
        
        <!-- ==================== QR ==================== -->
        <div id="page-qr" class="page">
            <div class="page-header"><h1>Generar QR</h1></div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-title" style="margin-bottom:16px">Configuraci√≥n</div>
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <select id="qr-product" style="padding:10px;border:1px solid #ddd;border-radius:6px"></select>
                        <select id="qr-store" style="padding:10px;border:1px solid #ddd;border-radius:6px"></select>
                        <button class="btn btn-primary" onclick="generateQR()">Generar QR</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title" style="margin-bottom:16px">Preview</div>
                    <div id="qr-result" style="text-align:center"></div>
                </div>
            </div>
        </div>
        
        <!-- ==================== PROMOCIONES ==================== -->
        <div id="page-promociones" class="page">
            <div class="page-header"><h1>Promociones</h1></div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-title" style="margin-bottom:12px">‚ûï Crear Promoci√≥n</div>
                    <div class="promo-filters">
                        <div class="filter-section">
                            <div class="filter-header"><span class="filter-label">1. Productos</span><div><button class="chip-btn" onclick="promoSelectAll('product')">Todos</button><button class="chip-btn" onclick="promoSelectNone('product')">Ninguno</button></div></div>
                            <div class="filter-grid" id="promo-products"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-header"><span class="filter-label">2. Distribuidores</span><div><button class="chip-btn" onclick="promoSelectAll('dist')">Todos</button><button class="chip-btn" onclick="promoSelectNone('dist')">Ninguno</button></div></div>
                            <div class="filter-grid" id="promo-dists"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-header"><span class="filter-label">3. Estados</span><div><button class="chip-btn" onclick="promoSelectAll('state')">Todos</button><button class="chip-btn" onclick="promoSelectNone('state')">Ninguno</button></div></div>
                            <div class="filter-grid" id="promo-states"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-header"><span class="filter-label">4. Ciudades</span><div><button class="chip-btn" onclick="promoSelectAll('city')">Todas</button><button class="chip-btn" onclick="promoSelectNone('city')">Ninguna</button></div></div>
                            <div class="filter-grid" id="promo-cities"></div>
                        </div>
                        <div class="filter-section">
                            <div class="filter-header"><span class="filter-label">5. Tiendas</span><div><button class="chip-btn" onclick="promoSelectAll('store')">Todas</button><button class="chip-btn" onclick="promoSelectNone('store')">Ninguna</button></div></div>
                            <div class="filter-grid" id="promo-stores"></div>
                        </div>
                    </div>
                    <div class="promo-summary">
                        <div><span class="big" id="promo-cnt-prod">0</span><div class="lbl">Productos</div></div>
                        <div><span class="big" id="promo-cnt-store">0</span><div class="lbl">Tiendas</div></div>
                        <div><span class="big" id="promo-cnt-total">0</span><div class="lbl">Promos</div></div>
                    </div>
                    <div class="promo-form">
                        <input type="text" id="promo-name" placeholder="Nombre">
                        <input type="number" id="promo-price" placeholder="Precio $">
                        <input type="text" id="promo-text" placeholder="Texto">
                        <input type="date" id="promo-start">
                        <input type="date" id="promo-end">
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button class="btn btn-secondary" onclick="resetPromoForm()">Limpiar</button>
                        <button class="btn btn-primary" onclick="createPromos()">Crear</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìã Gestionar</span>
                        <span id="promo-total-badge"></span>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <select id="manage-dist" onchange="renderPromoList()" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px"><option value="">Todos dist.</option></select>
                        <select id="manage-state" onchange="renderPromoList()" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px"><option value="">Todos estados</option></select>
                    </div>
                    <div id="promo-list" style="max-height:400px;overflow-y:auto"></div>
                </div>
            </div>
        </div>
        
        <!-- ==================== LANDINGS ==================== -->
        <div id="page-landings" class="page">
            <div class="page-header">
                <h1>Landings</h1>
                <span class="badge badge-info" style="background:#e3f2fd;color:#1976d2">1 landing = miles de tiendas</span>
            </div>
            
            <!-- Mis Landings Creadas -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìÑ Mis Landings</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateLanding()">+ Crear Landing</button>
                </div>
                <div id="landings-list"></div>
            </div>
            
            <!-- Modal Crear/Editar Landing -->
            <div class="card" id="landing-editor" style="display:none">
                <div class="card-header">
                    <span class="card-title" id="editor-title">‚ú® Crear Nueva Landing</span>
                    <button class="btn btn-sm btn-secondary" onclick="closeLandingEditor()">‚úï Cerrar</button>
                </div>
                
                <!-- Paso 1: Seleccionar Producto -->
                <div id="editor-step1">
                    <p style="color:#666;margin-bottom:12px">Selecciona un producto de la bodega:</p>
                    <input type="text" class="search-input" placeholder="Buscar producto..." id="landing-search" oninput="filterLandingProducts()" style="margin-bottom:12px;width:100%">
                    <div class="products-grid" id="landing-products-grid" style="max-height:250px;overflow-y:auto"></div>
                </div>
                
                <!-- Paso 2: Editar Landing -->
                <div id="editor-step2" style="display:none">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee">
                        <img id="editor-product-img" src="" style="width:60px;height:60px;object-fit:cover;border-radius:6px">
                        <div>
                            <div style="font-weight:600" id="editor-product-name"></div>
                            <div style="font-size:0.8rem;color:#888" id="editor-product-sku"></div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="backToStep1()" style="margin-left:auto">Cambiar producto</button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                        <div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label style="font-size:0.75rem;font-weight:600;color:#666">T√≠tulo</label>
                                <input type="text" id="landing-title" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
                            </div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label style="font-size:0.75rem;font-weight:600;color:#666">Descripci√≥n Premium ‚ú®</label>
                                <textarea id="landing-desc" rows="4" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></textarea>
                                <button class="btn btn-sm btn-secondary" onclick="regenerateDescription()" style="margin-top:6px">üîÑ Generar otra descripci√≥n</button>
                            </div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label style="font-size:0.75rem;font-weight:600;color:#666">Texto Promocional (opcional)</label>
                                <input type="text" id="landing-promo-text" placeholder="üî• HOT SALE - 30% OFF" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
                            </div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label style="font-size:0.75rem;font-weight:600;color:#666">Video</label>
                                <div style="display:flex;gap:8px">
                                    <input type="text" id="landing-video" placeholder="Se genera con Veo 3.1" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px">
                                    <button class="btn btn-primary" onclick="generateVideoVeo()" id="btnGenVideo">üé¨ Generar</button>
                                </div>
                                <div id="video-status" style="font-size:0.75rem;color:#888;margin-top:6px"></div>
                            </div>
                        </div>
                        
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#666;display:block;margin-bottom:8px">Vista Previa</label>
                            <div id="landing-preview" style="border:1px solid #ddd;border-radius:8px;overflow:hidden;background:#1a1a1a"></div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid #eee">
                        <button class="btn btn-primary" onclick="saveLanding()">üíæ Guardar Landing</button>
                        <button class="btn btn-secondary" onclick="previewFullLanding()">üëÅÔ∏è Preview Completo</button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Generar QRs -->
            <div class="card" id="qr-generator" style="display:none">
                <div class="card-header">
                    <span class="card-title">üì± Generar QRs para: <span id="qr-landing-name"></span></span>
                    <button class="btn btn-sm btn-secondary" onclick="closeQRGenerator()">‚úï Cerrar</button>
                </div>
                
                <p style="color:#666;margin-bottom:16px">Selecciona las tiendas donde quieres generar QRs. Cada QR tendr√° una URL √∫nica que trackea la tienda.</p>
                
                <div class="promo-filters">
                    <div class="filter-section">
                        <div class="filter-header"><span class="filter-label">Distribuidores</span><div><button class="chip-btn" onclick="qrSelectAll('dist')">Todos</button><button class="chip-btn" onclick="qrSelectNone('dist')">Ninguno</button></div></div>
                        <div class="filter-grid" id="qr-dists"></div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-header"><span class="filter-label">Estados</span><div><button class="chip-btn" onclick="qrSelectAll('state')">Todos</button><button class="chip-btn" onclick="qrSelectNone('state')">Ninguno</button></div></div>
                        <div class="filter-grid" id="qr-states"></div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-header"><span class="filter-label">Tiendas</span><div><button class="chip-btn" onclick="qrSelectAll('store')">Todas</button><button class="chip-btn" onclick="qrSelectNone('store')">Ninguna</button></div></div>
                        <div class="filter-grid" id="qr-stores" style="max-height:200px;overflow-y:auto"></div>
                    </div>
                </div>
                
                <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin:16px 0;text-align:center">
                    <span style="font-size:2.5rem;font-weight:700;color:var(--accent)" id="qr-count">0</span>
                    <div style="color:#666;font-size:0.9rem">QRs / URLs a generar</div>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="copyAllURLs()">üìã Copiar URLs</button>
                    <button class="btn btn-secondary" onclick="downloadQRsPDF()">üìÑ Descargar QRs PDF</button>
                    <button class="btn btn-secondary" onclick="downloadURLsCSV()">üìä Exportar CSV</button>
                </div>
                
                <div id="urls-output" style="display:none;margin-top:16px">
                    <label style="font-size:0.75rem;font-weight:600;color:#666">URLs Generadas:</label>
                    <textarea id="urls-textarea" rows="8" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:0.75rem" readonly></textarea>
                </div>
            </div>
        </div>
        <!-- ==================== LEADS ==================== -->
        <div id="page-leads" class="page">
            <div class="page-header"><h1>Leads CRM</h1></div>
            <div class="stats-row" style="grid-template-columns: repeat(5, 1fr);">
                <div class="stat-card"><div class="label">Total</div><div class="value" id="lp-total">-</div></div>
                <div class="stat-card"><div class="label">Landing</div><div class="value" id="lp-landing">-</div></div>
                <div class="stat-card"><div class="label">Terra QR</div><div class="value" id="lp-terra">-</div></div>
                <div class="stat-card"><div class="label">WhatsApp</div><div class="value" id="lp-wa">-</div></div>
                <div class="stat-card"><div class="label">Nuevos</div><div class="value" id="lp-new">-</div></div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                <button onclick="loadLeadsPage()" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #ddd;background:#C41E3A;color:#fff;border-radius:20px;cursor:pointer">Todos</button>
                <button onclick="loadLeadsPage('landing')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #ddd;background:#fff;border-radius:20px;cursor:pointer">üåê Landing</button>
                <button onclick="loadLeadsPage('terra_qr')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #ddd;background:#fff;border-radius:20px;cursor:pointer">üè™ Terra QR</button>
                <button onclick="loadLeadsPage('whatsapp_bot')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #ddd;background:#fff;border-radius:20px;cursor:pointer">üí¨ WhatsApp</button>
                <button onclick="loadLeadsPage(null,'new')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #27ae60;color:#27ae60;background:#fff;border-radius:20px;cursor:pointer">Nuevos</button>
                <button onclick="loadLeadsPage(null,'contacted')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #f39c12;color:#f39c12;background:#fff;border-radius:20px;cursor:pointer">Contactados</button>
                <button onclick="loadLeadsPage(null,'converted')" class="lp-filter" style="font-size:0.75rem;padding:6px 14px;border:1px solid #3498db;color:#3498db;background:#fff;border-radius:20px;cursor:pointer">Convertidos</button>
            </div>
            <div style="display:grid;grid-template-columns:380px 1fr;gap:16px">
                <div class="card" style="margin:0">
                    <div class="card-header"><span class="card-title">üìã Leads</span><span class="card-action" onclick="loadLeadsPage()">Actualizar</span></div>
                    <div id="lp-list" style="max-height:calc(100vh - 300px);overflow-y:auto">
                        <span style="color:#aaa">Cargando...</span>
                    </div>
                </div>
                <div class="card" style="margin:0">
                    <div id="lp-detail" style="max-height:calc(100vh - 260px);overflow-y:auto">
                        <div style="display:flex;align-items:center;justify-content:center;height:300px;color:#aaa;font-size:0.9rem">
                            Selecciona un lead para ver su informacion completa
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ==================== WHATSAPP BOT ==================== -->
        <div id="page-whatsapp" class="page">
            <div class="page-header"><h1>WhatsApp Bot - Leads</h1></div>
            <div class="stats-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card"><div class="label">Conversaciones</div><div class="value" id="wa-page-total">-</div></div>
                <div class="stat-card"><div class="label">Hoy</div><div class="value" id="wa-page-today">-</div></div>
                <div class="stat-card"><div class="label">Mensajes total</div><div class="value" id="wa-page-msgs">-</div></div>
            </div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üì± Leads WhatsApp</span>
                        <span class="card-action" onclick="loadWAPage()">Actualizar ‚Üí</span>
                    </div>
                    <div id="wa-page-list" style="max-height:500px;overflow-y:auto;font-size:0.85rem">
                        <span style="color:#aaa">Cargando...</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üí¨ Conversaci√≥n completa</span>
                        <span id="wa-page-phone" style="font-size:0.7rem;color:#888"></span>
                    </div>
                    <div id="wa-page-chat" style="max-height:500px;overflow-y:auto;font-size:0.85rem">
                        <span style="color:#aaa">Selecciona un lead para ver mensajes</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==================== DATA ====================
        let products = [], stores = [], promotions = [], scans = [];
        let trendChart = null;
        
        async function loadAllData() {
            try {
                const [p, s, pr] = await Promise.all([
                    fetch('/api/products').then(r => r.json()).catch(() => []),
                    fetch('/api/stores').then(r => r.json()).catch(() => []),
                    fetch('/api/promotions').then(r => r.json()).catch(() => [])
                ]);
                products = p || [];
                stores = s || [];
                promotions = pr || [];
            } catch (e) {
                console.error('Error loading data:', e);
                products = [];
                stores = [];
                promotions = [];
            }
        }
        
        // ==================== NAVIGATION ====================
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(n => { if (n.textContent.trim().toLowerCase().includes(page === 'dashboard' ? 'dashboard' : page)) n.classList.add('active'); });
            if (typeof event !== 'undefined' && event && event.currentTarget && event.currentTarget.classList) event.currentTarget.classList.add('active');
            
            if (page === 'dashboard') loadDashboard();
            if (page === 'leads') loadLeadsPage();
            if (page === 'whatsapp') loadWAPage();
            if (page === 'productos') loadProducts();
            if (page === 'tiendas') loadStores();
            if (page === 'qr') loadQRSelects();
            if (page === 'promociones') loadPromoSection();
            if (page === 'landings') loadLandings();
        }
        
        // ==================== DASHBOARD ====================
        async function loadDashboard() {
            await loadAllData();
            const days = parseInt(document.getElementById('period').value);
            
            try {
                const analytics = await fetch(`/api/analytics/overview?days=${days}`).then(r => r.json());
                
                // KPIs
                document.getElementById('kpi-scans').textContent = (analytics.total_scans || 0).toLocaleString();
                document.getElementById('kpi-wa').textContent = (analytics.whatsapp_clicks || 0).toLocaleString();
                const conv = analytics.total_scans > 0 ? ((analytics.whatsapp_clicks || 0) / analytics.total_scans * 100).toFixed(1) : 0;
                document.getElementById('kpi-conv').textContent = conv + '%';
                document.getElementById('kpi-stores').textContent = analytics.active_stores || stores.length;
                document.getElementById('kpi-promos').textContent = promotions.filter(p => p.active).length;
                
                // Changes (mock for now)
                document.getElementById('kpi-scans-change').textContent = '‚Üë 12% vs anterior';
                document.getElementById('kpi-scans-change').className = 'change up';
                
                // Top products
                const topProducts = analytics.top_products || [];
                document.getElementById('top-products').innerHTML = topProducts.slice(0, 5).map((p, i) => `
                    <li class="ranking-item">
                        <span class="ranking-pos ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</span>
                        <div class="ranking-info">
                            <div class="ranking-name">${p.product_name || p.name || 'Producto'}</div>
                        </div>
                        <span class="ranking-value">${p.scans || p.count || 0}</span>
                    </li>
                `).join('') || '<li style="color:#999;padding:20px;text-align:center">Sin datos</li>';
                
                // Top stores
                const topStores = analytics.top_stores || [];
                document.getElementById('top-stores').innerHTML = topStores.slice(0, 5).map((s, i) => `
                    <li class="ranking-item">
                        <span class="ranking-pos ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</span>
                        <div class="ranking-info">
                            <div class="ranking-name">${s.store_name || s.name || 'Tienda'}</div>
                            <div class="ranking-sub">${s.state || ''}</div>
                        </div>
                        <span class="ranking-value">${s.scans || s.count || 0}</span>
                    </li>
                `).join('') || '<li style="color:#999;padding:20px;text-align:center">Sin datos</li>';
                
                // Top states
                const topStates = analytics.top_states || [];
                document.getElementById('top-states').innerHTML = topStates.slice(0, 5).map((s, i) => `
                    <li class="ranking-item">
                        <span class="ranking-pos ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</span>
                        <div class="ranking-info">
                            <div class="ranking-name">${s.state || 'Estado'}</div>
                        </div>
                        <span class="ranking-value">${s.scans || s.count || 0}</span>
                    </li>
                `).join('') || '<li style="color:#999;padding:20px;text-align:center">Sin datos</li>';
                
                // Render heat map
                renderMexicoMap(analytics.by_state || topStates);
                
                // Render trend chart
                renderTrendChart(analytics.daily || []);
                
            } catch (e) {
                console.error('Analytics error:', e);
            }
            
            // Alerts
            renderAlerts();

            // Promos summary
            renderPromosSummary();

            // Terra Insights
            loadTerraInsights();

            // Terra Store Sessions
            loadTerraSessions();
        }
        
        async function loadTerraInsights() {
            const days = parseInt(document.getElementById('period').value) || 30;
            try {
                // Load conversations list
                const convRes = await fetch(`/api/terra/conversations?days=${days}`);
                const conversations = await convRes.json();

                const recentEl = document.getElementById('terra-recent');
                const totalEl = document.getElementById('terra-total');
                totalEl.textContent = conversations.length + ' conversaciones';

                if (conversations.length === 0) {
                    recentEl.innerHTML = '<span style="color:#aaa;font-size:0.85rem">Sin conversaciones en este periodo. Cuando los clientes hablen con Terra, sus preguntas aparecer√°n aqu√≠.</span>';
                    document.getElementById('terra-summary').innerHTML = '<span style="color:#aaa">Sin datos suficientes para generar resumen.</span>';
                    return;
                }

                // Show recent conversations
                recentEl.innerHTML = conversations.slice(0, 15).map(c => `
                    <div class="terra-msg">
                        <div class="terra-q">${c.customer_name || 'An√≥nimo'}: "${c.question}"</div>
                        <div class="terra-a">Terra: ${(c.answer || '').substring(0, 100)}${c.answer && c.answer.length > 100 ? '...' : ''}</div>
                        <div class="terra-meta">${c.product_name ? 'üì¶ ' + c.product_name : ''} ${c.store_name ? 'üè™ ' + c.store_name : ''} ¬∑ ${mxDate(c.created_at).toLocaleDateString('es-MX', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                `).join('');

                // Load AI summary
                document.getElementById('terra-summary').innerHTML = '<span style="color:#aaa">Generando resumen con IA...</span>';
                const sumRes = await fetch(`/api/terra/summary?days=${days}`);
                const summary = await sumRes.json();

                let html = '';
                if (summary.top_products && summary.top_products.length > 0) {
                    html += '<div style="margin-bottom:8px"><strong>Productos consultados:</strong> ';
                    html += summary.top_products.slice(0, 5).map(p => `<span class="terra-stat">${p.name} (${p.count})</span>`).join(' ');
                    html += '</div>';
                }
                if (summary.top_stores && summary.top_stores.length > 0) {
                    html += '<div style="margin-bottom:8px"><strong>Tiendas:</strong> ';
                    html += summary.top_stores.map(s => `<span class="terra-stat">${s.name} (${s.count})</span>`).join(' ');
                    html += '</div>';
                }
                if (summary.summary) {
                    html += '<div style="margin-top:10px;padding:10px;background:#f9f9f9;border-radius:8px;font-size:0.8rem;line-height:1.6;white-space:pre-wrap">' + summary.summary.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '</div>';
                }
                document.getElementById('terra-summary').innerHTML = html || '<span style="color:#aaa">Sin resumen disponible.</span>';

            } catch (e) {
                console.error('Terra insights error:', e);
                document.getElementById('terra-summary').innerHTML = '<span style="color:#aaa">Error cargando insights.</span>';
            }
        }

        async function loadTerraSessions() {
            const days = parseInt(document.getElementById('period').value) || 30;
            try {
                const res = await fetch(`/api/terra/sessions?days=${days}&limit=50`);
                const data = await res.json();
                const { sessions, summary } = data;

                document.getElementById('ts-total').textContent = summary.total_sessions;
                document.getElementById('ts-avg-products').textContent = summary.avg_products_per_visit;
                document.getElementById('ts-avg-duration').textContent = summary.avg_duration_minutes + 'm';
                document.getElementById('ts-wa-rate').textContent = summary.whatsapp_rate + '%';

                const listEl = document.getElementById('terra-sessions-list');
                if (sessions.length === 0) {
                    listEl.innerHTML = '<span style="color:#aaa">Sin visitas Terra en este periodo.</span>';
                    return;
                }

                listEl.innerHTML = sessions.slice(0, 20).map(s => {
                    let productsCount = 0;
                    try { productsCount = JSON.parse(s.products_visited || '[]').length; } catch(e) {}
                    const dur = s.duration_minutes ? Math.round(s.duration_minutes) + ' min' : 'activa';
                    const wa = s.whatsapp_sent ? '‚úÖ WhatsApp' : '';
                    const date = new Date(s.started_at).toLocaleDateString('es-MX', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
                    return `<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;cursor:pointer" onclick="showSessionDetail('${s.session_id}')">
                        <strong>${s.customer_name || 'An√≥nimo'}</strong> ‚Äî ${s.store_name || 'Sin tienda'}
                        <div style="font-size:0.7rem;color:#888">${productsCount} pisos ¬∑ ${dur} ${wa} ¬∑ ${date}</div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('Terra sessions error:', e);
            }
        }

        async function showSessionDetail(sessionId) {
            const detailEl = document.getElementById('terra-sessions-detail');
            try {
                const res = await fetch(`/api/terra/sessions?days=90&limit=200`);
                const data = await res.json();
                const session = data.sessions.find(s => s.session_id === sessionId);
                if (!session) { detailEl.innerHTML = '<span style="color:#aaa">Sesi√≥n no encontrada</span>'; return; }

                let products = [];
                try { products = JSON.parse(session.products_visited || '[]'); } catch(e) {}

                let html = `<div style="margin-bottom:8px"><strong>${session.customer_name || 'An√≥nimo'}</strong> en ${session.store_name || 'N/A'}</div>`;
                html += `<div style="font-size:0.7rem;color:#888;margin-bottom:8px">${new Date(session.started_at).toLocaleString('es-MX')} ¬∑ ${session.duration_minutes ? Math.round(session.duration_minutes) + ' min' : 'activa'}</div>`;

                if (products.length > 0) {
                    html += '<div style="margin-bottom:8px"><strong>Pisos explorados:</strong></div>';
                    html += products.map((p, i) => `<div style="padding:4px 0;border-bottom:1px solid #f5f5f5">${i+1}. <strong>${p.name}</strong> <span style="color:#888">${p.category || ''}</span></div>`).join('');
                }

                if (session.recommendation) {
                    html += `<div style="margin-top:8px;padding:8px;background:#fff8e1;border-radius:6px;font-size:0.75rem"><strong>Recomendaci√≥n Terra:</strong><br>${session.recommendation}</div>`;
                }

                html += `<div style="margin-top:8px;font-size:0.7rem;color:#888">WhatsApp: ${session.whatsapp_sent ? '‚úÖ Enviado' : '‚ùå No enviado'}</div>`;
                detailEl.innerHTML = html;
            } catch (e) {
                detailEl.innerHTML = '<span style="color:#aaa">Error cargando detalle</span>';
            }
        }

        function renderMexicoMap(stateData) {
            const stateScans = {};
            stateData.forEach(s => {
                stateScans[s.state] = s.scans || s.count || 0;
            });
            
            const getHeatColor = (count) => {
                if (!count || count === 0) return '#e8e8e8';
                if (count <= 10) return '#ffcdd2';
                if (count <= 25) return '#ef9a9a';
                if (count <= 50) return '#e57373';
                if (count <= 100) return '#ef5350';
                if (count <= 200) return '#e53935';
                return '#c41e3a';
            };
            
            // Mexico SVG paths by state
            const mexicoSVG = `
            <svg viewBox="0 0 800 600" style="width:100%;height:auto">
              <g id="mexico-states">
                <path id="Baja California" d="M40,50 L80,40 L95,80 L100,150 L90,200 L70,220 L50,180 L35,120 Z" />
                <path id="Baja California Sur" d="M50,220 L70,230 L85,280 L90,350 L70,380 L45,360 L40,300 L45,250 Z" />
                <path id="Sonora" d="M100,50 L180,45 L200,80 L210,150 L180,180 L140,190 L100,160 L95,100 Z" />
                <path id="Chihuahua" d="M180,50 L280,55 L290,120 L280,200 L220,220 L180,190 L185,120 Z" />
                <path id="Coahuila" d="M280,80 L360,85 L380,140 L360,200 L300,210 L280,160 Z" />
                <path id="Nuevo Le√≥n" d="M360,100 L420,110 L430,170 L400,210 L360,200 L365,140 Z" />
                <path id="Tamaulipas" d="M420,120 L470,140 L480,220 L450,280 L400,260 L390,200 L410,160 Z" />
                <path id="Sinaloa" d="M140,200 L180,195 L200,250 L190,320 L150,340 L120,290 L130,240 Z" />
                <path id="Durango" d="M180,200 L260,210 L270,280 L240,330 L190,320 L175,260 Z" />
                <path id="Zacatecas" d="M260,220 L320,225 L340,290 L310,340 L250,330 L245,270 Z" />
                <path id="San Luis Potos√≠" d="M320,230 L390,240 L400,310 L360,360 L310,345 L305,280 Z" />
                <path id="Nayarit" d="M150,340 L190,330 L200,380 L170,410 L140,390 Z" />
                <path id="Aguascalientes" d="M270,330 L300,335 L305,360 L280,370 L265,355 Z" />
                <path id="Jalisco" d="M170,380 L250,360 L280,380 L270,450 L200,470 L160,430 Z" />
                <path id="Guanajuato" d="M280,360 L340,355 L360,400 L330,430 L290,420 L275,390 Z" />
                <path id="Quer√©taro" d="M340,360 L380,365 L390,400 L365,420 L340,405 Z" />
                <path id="Hidalgo" d="M380,370 L420,375 L430,410 L405,440 L375,425 Z" />
                <path id="Colima" d="M180,450 L210,445 L220,480 L195,495 L175,475 Z" />
                <path id="Michoac√°n" d="M210,430 L290,420 L310,470 L270,510 L210,500 L195,460 Z" />
                <path id="Ciudad de M√©xico" d="M370,430 L395,428 L400,450 L380,460 L365,445 Z" />
                <path id="Estado de M√©xico" d="M330,420 L370,425 L385,470 L350,500 L310,480 L320,440 Z" />
                <path id="Tlaxcala" d="M400,435 L425,432 L430,455 L410,465 L395,450 Z" />
                <path id="Morelos" d="M360,470 L390,465 L400,495 L375,510 L355,495 Z" />
                <path id="Puebla" d="M400,450 L460,445 L480,510 L440,550 L390,530 L385,480 Z" />
                <path id="Guerrero" d="M270,510 L350,500 L380,550 L340,600 L260,590 L240,550 Z" />
                <path id="Oaxaca" d="M350,540 L450,520 L490,570 L450,620 L370,610 L340,580 Z" />
                <path id="Veracruz" d="M420,380 L480,360 L520,420 L510,520 L460,540 L430,480 L440,420 Z" />
                <path id="Tabasco" d="M510,480 L570,470 L590,510 L560,540 L520,530 Z" />
                <path id="Chiapas" d="M500,540 L580,530 L620,580 L580,630 L510,620 L490,580 Z" />
                <path id="Campeche" d="M570,450 L630,440 L650,500 L620,540 L570,520 Z" />
                <path id="Yucat√°n" d="M600,380 L680,370 L700,420 L670,460 L620,450 L605,410 Z" />
                <path id="Quintana Roo" d="M680,400 L730,390 L750,480 L720,550 L680,530 L670,460 L690,420 Z" />
              </g>
            </svg>`;
            
            document.getElementById('mexico-map').innerHTML = mexicoSVG;
            
            // Apply colors to each state
            document.querySelectorAll('#mexico-states path').forEach(path => {
                const stateName = path.id;
                const count = stateScans[stateName] || 0;
                const color = getHeatColor(count);
                
                path.style.fill = color;
                path.style.stroke = '#fff';
                path.style.strokeWidth = '1';
                path.style.cursor = 'pointer';
                path.style.transition = 'all 0.2s';
                
                path.onmouseenter = (e) => {
                    path.style.opacity = '0.8';
                    showMapTooltip(e, stateName, count);
                };
                path.onmouseleave = () => {
                    path.style.opacity = '1';
                    hideMapTooltip();
                };
                path.onclick = () => {
                    alert(`${stateName}: ${count} escaneos`);
                };
            });
        }
        
        function showMapTooltip(e, state, count) {
            let tooltip = document.getElementById('map-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'map-tooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            tooltip.innerHTML = `<strong>${state}</strong><br>${count} escaneos`;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 30) + 'px';
        }
        
        function hideMapTooltip() {
            const tooltip = document.getElementById('map-tooltip');
            if (tooltip) tooltip.style.display = 'none';
        }
        
        function renderTrendChart(dailyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) trendChart.destroy();
            
            // Generate sample data if none
            const labels = [];
            const data = [];
            const days = parseInt(document.getElementById('period').value);
            
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' }));
                
                const found = dailyData.find(dd => dd.date === d.toISOString().split('T')[0]);
                data.push(found ? found.scans : Math.floor(Math.random() * 50) + 10);
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Escaneos',
                        data,
                        borderColor: '#c41e3a',
                        backgroundColor: 'rgba(196,30,58,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' } }
                    }
                }
            });
        }
        
        function renderAlerts() {
            const alerts = [];
            
            // Promos expiring soon
            const now = new Date();
            const soon = new Date();
            soon.setDate(soon.getDate() + 7);
            
            const expiring = promotions.filter(p => {
                const end = new Date(p.end_date);
                return p.active && end > now && end <= soon;
            });
            
            if (expiring.length > 0) {
                alerts.push({ icon: '‚è∞', text: `${expiring.length} promociones vencen en 7 d√≠as`, type: 'warning' });
            }
            
            // Inactive promos
            const inactive = promotions.filter(p => !p.active).length;
            if (inactive > 0) {
                alerts.push({ icon: 'üí§', text: `${inactive} promociones inactivas`, type: '' });
            }
            
            // No promos
            if (promotions.length === 0) {
                alerts.push({ icon: 'üì¢', text: 'No hay promociones creadas', type: 'danger' });
            }
            
            document.getElementById('alerts-list').innerHTML = alerts.length > 0 
                ? alerts.map(a => `<div class="alert-item ${a.type}"><span class="icon">${a.icon}</span>${a.text}</div>`).join('')
                : '<p style="color:#999;text-align:center;padding:20px">Sin alertas</p>';
        }
        
        function renderPromosSummary() {
            const active = promotions.filter(p => p.active);
            const now = new Date();
            const soon = new Date();
            soon.setDate(soon.getDate() + 7);
            
            const expiring = active.filter(p => new Date(p.end_date) <= soon);
            
            let html = `<div class="promo-mini"><span>Activas</span><span class="promo-badge active">${active.length}</span></div>`;
            if (expiring.length > 0) {
                html += `<div class="promo-mini"><span>Por vencer (7 d√≠as)</span><span class="promo-badge expiring">${expiring.length}</span></div>`;
            }
            html += `<div class="promo-mini"><span>Total</span><span>${promotions.length}</span></div>`;
            
            document.getElementById('promos-summary').innerHTML = html;
        }
        
        // ==================== PRODUCTOS ====================
        function loadProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = products.map(p => `
                <div class="product-card" onclick="openProduct(${p.id})">
                    <div class="product-card-img" style="background-image:url('${p.image_url || ''}')"></div>
                    <div class="product-card-body">
                        <h4>${p.name}</h4>
                        <p>${p.sku || ''} ‚Ä¢ $${p.base_price || 450}/m¬≤</p>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProducts() {
            const search = document.getElementById('search-products').value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(search));
            document.getElementById('products-grid').innerHTML = filtered.map(p => `
                <div class="product-card" onclick="openProduct(${p.id})">
                    <div class="product-card-img" style="background-image:url('${p.image_url || ''}')"></div>
                    <div class="product-card-body">
                        <h4>${p.name}</h4>
                        <p>${p.sku || ''} ‚Ä¢ $${p.base_price || 450}/m¬≤</p>
                    </div>
                </div>
            `).join('');
        }
        
        function openProduct(id) {
            const p = products.find(pr => pr.id === id);
            if (p) window.open(p.url || `https://cesantoni.com.mx/producto/${p.slug}`, '_blank');
        }
        
        // ==================== TIENDAS ====================
        function loadStores() {
            const dists = [...new Set(stores.map(s => s.distributor_name))].filter(Boolean).sort();
            const states = [...new Set(stores.map(s => s.state))].filter(Boolean).sort();
            
            document.getElementById('filter-dist').innerHTML = '<option value="">Todos los distribuidores</option>' + dists.map(d => `<option>${d}</option>`).join('');
            document.getElementById('filter-state').innerHTML = '<option value="">Todos los estados</option>' + states.map(s => `<option>${s}</option>`).join('');
            
            filterStores();
        }
        
        function filterStores() {
            const dist = document.getElementById('filter-dist').value;
            const state = document.getElementById('filter-state').value;
            
            let filtered = stores;
            if (dist) filtered = filtered.filter(s => s.distributor_name === dist);
            if (state) filtered = filtered.filter(s => s.state === state);
            
            // Group by distributor
            const groups = {};
            filtered.forEach(s => {
                const key = s.distributor_name || 'Otro';
                if (!groups[key]) groups[key] = [];
                groups[key].push(s);
            });
            
            document.getElementById('stores-list').innerHTML = Object.entries(groups).map(([dist, strs]) => `
                <div class="card" style="margin-bottom:12px">
                    <div class="card-header">
                        <span class="card-title">${dist}</span>
                        <span class="badge badge-success">${strs.length} tiendas</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
                        ${strs.map(s => `<div style="padding:8px;background:#f9f9f9;border-radius:6px;font-size:0.8rem">
                            <strong>${s.name}</strong><br>
                            <span style="color:#888">${s.city || ''}, ${s.state || ''}</span>
                        </div>`).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // ==================== QR ====================
        function loadQRSelects() {
            document.getElementById('qr-product').innerHTML = '<option value="">Selecciona producto</option>' + 
                products.map(p => `<option value="${p.slug || p.sku}">${p.name}</option>`).join('');
            document.getElementById('qr-store').innerHTML = '<option value="">Selecciona tienda</option>' + 
                stores.map(s => `<option value="${s.slug}">${s.name} - ${s.state || ''}</option>`).join('');
        }
        
        async function generateQR() {
            const product = document.getElementById('qr-product').value;
            const store = document.getElementById('qr-store').value;
            
            if (!product || !store) return alert('Selecciona producto y tienda');
            
            const url = `${location.origin}/p/${product}?store=${store}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            
            document.getElementById('qr-result').innerHTML = `
                <img src="${qrUrl}" style="margin-bottom:12px"><br>
                <code style="font-size:0.7rem;word-break:break-all">${url}</code><br>
                <button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="window.open('${qrUrl}')">Descargar</button>
            `;
        }
        
        // ==================== PROMOCIONES ====================
        let promoSelected = { product: new Set(), dist: new Set(), state: new Set(), city: new Set(), store: new Set() };
        
        function loadPromoSection() {
            renderPromoFilters();
            renderPromoList();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('promo-start').value = today;
            const next = new Date(); next.setMonth(next.getMonth() + 1);
            document.getElementById('promo-end').value = next.toISOString().split('T')[0];
        }
        
        function renderPromoFilters() {
            // Products
            document.getElementById('promo-products').innerHTML = products.map(p => 
                `<div class="filter-chip2 ${promoSelected.product.has(p.id)?'selected':''}" onclick="promoToggle('product',${p.id})">${p.name}</div>`
            ).join('');
            
            // Distributors
            const dists = [...new Set(stores.map(s => s.distributor_name))].filter(Boolean).sort();
            document.getElementById('promo-dists').innerHTML = dists.map(d => 
                `<div class="filter-chip2 ${promoSelected.dist.has(d)?'selected':''}" onclick="promoToggle('dist','${d}')">${d}</div>`
            ).join('');
            
            // States
            let filtered = stores;
            if (promoSelected.dist.size) filtered = filtered.filter(s => promoSelected.dist.has(s.distributor_name));
            const states = [...new Set(filtered.map(s => s.state))].filter(Boolean).sort();
            document.getElementById('promo-states').innerHTML = states.map(st => 
                `<div class="filter-chip2 ${promoSelected.state.has(st)?'selected':''}" onclick="promoToggle('state','${st}')">${st}</div>`
            ).join('') || '<span style="color:#999;font-size:0.75rem">Selecciona distribuidores</span>';
            
            // Cities
            if (promoSelected.state.size) filtered = filtered.filter(s => promoSelected.state.has(s.state));
            const cities = [...new Set(filtered.map(s => s.city))].filter(Boolean).sort();
            document.getElementById('promo-cities').innerHTML = cities.map(c => 
                `<div class="filter-chip2 ${promoSelected.city.has(c)?'selected':''}" onclick="promoToggle('city','${c}')">${c}</div>`
            ).join('') || '<span style="color:#999;font-size:0.75rem">Selecciona estados</span>';
            
            // Stores
            if (promoSelected.city.size) filtered = filtered.filter(s => promoSelected.city.has(s.city));
            document.getElementById('promo-stores').innerHTML = filtered.slice(0, 50).map(s => 
                `<div class="filter-chip2 ${promoSelected.store.has(s.id)?'selected':''}" onclick="promoToggle('store',${s.id})">${s.name}</div>`
            ).join('') || '<span style="color:#999;font-size:0.75rem">No hay tiendas</span>';
            
            updatePromoCounts();
            
            // Manage filters
            document.getElementById('manage-dist').innerHTML = '<option value="">Todos dist.</option>' + dists.map(d => `<option>${d}</option>`).join('');
            document.getElementById('manage-state').innerHTML = '<option value="">Todos estados</option>' + [...new Set(stores.map(s=>s.state))].filter(Boolean).sort().map(s => `<option>${s}</option>`).join('');
        }
        
        function promoToggle(type, val) {
            promoSelected[type].has(val) ? promoSelected[type].delete(val) : promoSelected[type].add(val);
            if (type === 'dist') { promoSelected.state.clear(); promoSelected.city.clear(); promoSelected.store.clear(); }
            if (type === 'state') { promoSelected.city.clear(); promoSelected.store.clear(); }
            if (type === 'city') promoSelected.store.clear();
            renderPromoFilters();
        }
        
        function promoSelectAll(type) {
            if (type === 'product') products.forEach(p => promoSelected.product.add(p.id));
            else if (type === 'store') getFilteredPromoStores().forEach(s => promoSelected.store.add(s.id));
            else {
                const items = document.querySelectorAll(`#promo-${type}s .filter-chip2`);
                items.forEach(el => promoSelected[type].add(el.textContent.trim()));
            }
            renderPromoFilters();
        }
        
        function promoSelectNone(type) {
            promoSelected[type].clear();
            if (type === 'dist') { promoSelected.state.clear(); promoSelected.city.clear(); promoSelected.store.clear(); }
            if (type === 'state') { promoSelected.city.clear(); promoSelected.store.clear(); }
            if (type === 'city') promoSelected.store.clear();
            renderPromoFilters();
        }
        
        function getFilteredPromoStores() {
            let f = stores;
            if (promoSelected.dist.size) f = f.filter(s => promoSelected.dist.has(s.distributor_name));
            if (promoSelected.state.size) f = f.filter(s => promoSelected.state.has(s.state));
            if (promoSelected.city.size) f = f.filter(s => promoSelected.city.has(s.city));
            return f;
        }
        
        function getSelectedPromoStoreIds() {
            return promoSelected.store.size ? Array.from(promoSelected.store) : getFilteredPromoStores().map(s => s.id);
        }
        
        function updatePromoCounts() {
            const p = promoSelected.product.size, s = getSelectedPromoStoreIds().length;
            document.getElementById('promo-cnt-prod').textContent = p;
            document.getElementById('promo-cnt-store').textContent = s;
            document.getElementById('promo-cnt-total').textContent = p * s;
        }
        
        async function createPromos() {
            const name = document.getElementById('promo-name').value;
            const price = document.getElementById('promo-price').value;
            const text = document.getElementById('promo-text').value;
            const start = document.getElementById('promo-start').value;
            const end = document.getElementById('promo-end').value;
            
            if (!name || !price || !start || !end) return alert('Completa los campos');
            if (!promoSelected.product.size) return alert('Selecciona productos');
            
            const storeIds = getSelectedPromoStoreIds();
            if (!storeIds.length) return alert('Selecciona tiendas');
            
            let created = 0;
            for (const pid of promoSelected.product) {
                for (const sid of storeIds) {
                    const store = stores.find(s => s.id === sid);
                    await fetch('/api/promotions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, product_id: pid, scope_type: 'store', scope_value: store.slug, promo_price: +price, promo_text: text, start_date: start, end_date: end })
                    });
                    created++;
                }
            }
            
            alert(`‚úÖ ${created} promociones creadas`);
            resetPromoForm();
            promotions = await fetch('/api/promotions').then(r => r.json());
            renderPromoList();
        }
        
        function resetPromoForm() {
            ['promo-name', 'promo-price', 'promo-text'].forEach(id => document.getElementById(id).value = '');
            Object.keys(promoSelected).forEach(k => promoSelected[k].clear());
            renderPromoFilters();
        }
        
        function renderPromoList() {
            const distF = document.getElementById('manage-dist').value;
            const stateF = document.getElementById('manage-state').value;
            
            let filtered = promotions.filter(p => {
                const store = stores.find(s => s.slug === p.scope_value);
                if (distF && store?.distributor_name !== distF) return false;
                if (stateF && store?.state !== stateF) return false;
                return true;
            });
            
            document.getElementById('promo-total-badge').innerHTML = `<span class="badge badge-success">${promotions.length} total</span>`;
            
            if (!filtered.length) {
                document.getElementById('promo-list').innerHTML = '<p style="color:#999;text-align:center;padding:20px">No hay promociones</p>';
                return;
            }
            
            const groups = {};
            filtered.forEach(p => {
                const store = stores.find(s => s.slug === p.scope_value);
                const key = store?.distributor_name || 'Otro';
                if (!groups[key]) groups[key] = [];
                groups[key].push({ ...p, store });
            });
            
            document.getElementById('promo-list').innerHTML = Object.entries(groups).map(([dist, promos]) => `
                <div class="promo-group" onclick="this.classList.toggle('open')">
                    <div class="promo-group-header">
                        <span><strong>${dist}</strong> <span class="badge badge-success">${promos.length}</span></span>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();togglePromoGroup('${dist}',true)">On</button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();togglePromoGroup('${dist}',false)">Off</button>
                        </div>
                    </div>
                    <div class="promo-group-items">
                        ${promos.map(p => `
                            <div class="promo-item">
                                <div>
                                    <strong>${p.product_name || 'Producto'}</strong>
                                    <span class="badge ${p.active?'badge-success':'badge-danger'}">${p.active?'ON':'OFF'}</span><br>
                                    <small style="color:#888">${p.store?.name || ''}</small>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="font-weight:700;color:#c41e3a">$${p.promo_price}</span>
                                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();window.open('/p/${p.product_sku || ''}?store=${p.scope_value}')">üëÅÔ∏è</button>
                                    <button class="btn btn-sm ${p.active?'btn-secondary':'btn-primary'}" onclick="event.stopPropagation();togglePromo(${p.id})">${p.active?'Off':'On'}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        async function togglePromoGroup(dist, activate) {
            const toToggle = promotions.filter(p => {
                const store = stores.find(s => s.slug === p.scope_value);
                return store?.distributor_name === dist && p.active !== activate;
            });
            for (const p of toToggle) await fetch(`/api/promotions/${p.id}/toggle`, { method: 'PUT' });
            promotions = await fetch('/api/promotions').then(r => r.json());
            renderPromoList();
        }
        
        async function togglePromo(id) {
            await fetch(`/api/promotions/${id}/toggle`, { method: 'PUT' });
            promotions = await fetch('/api/promotions').then(r => r.json());
            renderPromoList();
        }
        
        // ==================== LANDINGS ====================
        let landings = [];
        let selectedLandingProduct = null;
        let editingLandingId = null;
        let qrSelectedLanding = null;
        let qrSelected = { dist: new Set(), state: new Set(), store: new Set() };
        
        async function loadLandings() {
            try {
                landings = await fetch('/api/landings').then(r => r.json());
            } catch(e) {
                landings = [];
            }
            renderLandingsList();
        }
        
        function renderLandingsList() {
            if (!landings.length) {
                document.getElementById('landings-list').innerHTML = `
                    <div style="text-align:center;padding:40px;color:#888">
                        <div style="font-size:3rem;margin-bottom:16px">üìÑ</div>
                        <p>No hay landings creadas a√∫n</p>
                        <p style="font-size:0.85rem">Haz click en "+ Crear Landing" para comenzar</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('landings-list').innerHTML = `
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="border-bottom:2px solid #eee;text-align:left">
                            <th style="padding:12px 8px;font-size:0.75rem;color:#888;text-transform:uppercase">Producto</th>
                            <th style="padding:12px 8px;font-size:0.75rem;color:#888;text-transform:uppercase">Video</th>
                            <th style="padding:12px 8px;font-size:0.75rem;color:#888;text-transform:uppercase">Promo</th>
                            <th style="padding:12px 8px;font-size:0.75rem;color:#888;text-transform:uppercase">Creado</th>
                            <th style="padding:12px 8px;font-size:0.75rem;color:#888;text-transform:uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${landings.map(l => `
                            <tr style="border-bottom:1px solid #f0f0f0">
                                <td style="padding:12px 8px">
                                    <div style="display:flex;align-items:center;gap:10px">
                                        <img src="${l.product_image || l.image_url || ''}" style="width:40px;height:40px;object-fit:cover;border-radius:4px" onerror="this.src='https://via.placeholder.com/40'">
                                        <div>
                                            <div style="font-weight:600">${l.title || l.product_name}</div>
                                            <div style="font-size:0.75rem;color:#888">${l.product_sku || ''}</div>
                                        </div>
                                    </div>
                                </td>
                                <td style="padding:12px 8px">
                                    ${l.video_url ? '<span style="color:#28a745">‚úÖ Video</span>' : '<span style="color:#999">Sin video</span>'}
                                </td>
                                <td style="padding:12px 8px">
                                    ${l.promo_text ? `<span class="badge" style="background:#fff3cd;color:#856404">${l.promo_text}</span>` : '-'}
                                </td>
                                <td style="padding:12px 8px;font-size:0.85rem;color:#666">
                                    ${mxDate(l.created_at).toLocaleDateString('es-MX')}
                                </td>
                                <td style="padding:12px 8px">
                                    <div style="display:flex;gap:6px">
                                        <button class="btn btn-sm btn-primary" onclick="openQRGenerator(${l.id})">üì± QRs</button>
                                        <button class="btn btn-sm btn-secondary" onclick="editLanding(${l.id})">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-secondary" onclick="previewLanding(${l.id})">üëÅÔ∏è</button>
                                        <button class="btn btn-sm btn-secondary" onclick="deleteLanding(${l.id})" style="color:#dc3545">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // ==================== CREAR/EDITAR LANDING ====================
        function showCreateLanding() {
            editingLandingId = null;
            selectedLandingProduct = null;
            document.getElementById('editor-title').textContent = '‚ú® Crear Nueva Landing';
            document.getElementById('editor-step1').style.display = 'block';
            document.getElementById('editor-step2').style.display = 'none';
            document.getElementById('landing-editor').style.display = 'block';
            document.getElementById('landing-editor').scrollIntoView({ behavior: 'smooth' });
            renderLandingProducts();
        }
        
        function closeLandingEditor() {
            document.getElementById('landing-editor').style.display = 'none';
            editingLandingId = null;
            selectedLandingProduct = null;
        }
        
        function renderLandingProducts() {
            const search = document.getElementById('landing-search')?.value?.toLowerCase() || '';
            const filtered = products.filter(p => p.name.toLowerCase().includes(search));
            
            document.getElementById('landing-products-grid').innerHTML = filtered.slice(0, 50).map(p => `
                <div class="product-card" onclick="selectLandingProduct(${p.id})" style="cursor:pointer">
                    <div class="product-card-img" style="background-image:url('${p.image_url || ''}')"></div>
                    <div class="product-card-body">
                        <h4>${p.name}</h4>
                        <p style="font-size:0.8rem;color:#888">${p.sku || ''}</p>
                    </div>
                </div>
            `).join('') || '<p style="color:#999;padding:20px">No hay productos</p>';
        }
        
        function filterLandingProducts() { renderLandingProducts(); }
        
        function getPremiumDescription(name) {
            const descriptions = [
                `Inspirado en la elegancia atemporal de los espacios m√°s sofisticados del mundo, ${name} transforma cada ambiente en una declaraci√≥n de estilo. Su acabado magistral y textura √∫nica crean una experiencia visual que eleva cualquier proyecto arquitect√≥nico.`,
                `${name} representa la fusi√≥n perfecta entre artesan√≠a tradicional e innovaci√≥n tecnol√≥gica. Cada pieza es una obra maestra que aporta car√°cter, profundidad y un sentido de lujo incomparable a tus espacios.`,
                `Descubre la belleza extraordinaria de ${name}. Dise√±ado para quienes entienden que los detalles marcan la diferencia, este porcel√°nico premium redefine los est√°ndares de elegancia en pisos contempor√°neos.`,
                `${name} no es solo un piso, es una experiencia sensorial. Su dise√±o exclusivo y acabado impecable capturan la esencia del lujo europeo, creando ambientes que inspiran y perduran en el tiempo.`,
                `La colecci√≥n ${name} nace de la b√∫squeda incansable de la perfecci√≥n. Cada tonalidad, cada veta, cada textura ha sido cuidadosamente seleccionada para crear espacios que hablan de refinamiento y buen gusto.`
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }
        
        function selectLandingProduct(id) {
            selectedLandingProduct = products.find(p => p.id === id);
            if (!selectedLandingProduct) return;
            
            document.getElementById('editor-product-img').src = selectedLandingProduct.image_url || '';
            document.getElementById('editor-product-name').textContent = selectedLandingProduct.name;
            document.getElementById('editor-product-sku').textContent = selectedLandingProduct.sku || '';
            
            document.getElementById('landing-title').value = selectedLandingProduct.name;
            document.getElementById('landing-desc').value = getPremiumDescription(selectedLandingProduct.name);
            document.getElementById('landing-promo-text').value = '';
            document.getElementById('landing-video').value = selectedLandingProduct.video_url || '';
            
            document.getElementById('editor-step1').style.display = 'none';
            document.getElementById('editor-step2').style.display = 'block';
            
            updateLandingPreview();
            
            ['landing-title', 'landing-desc', 'landing-promo-text'].forEach(id => {
                document.getElementById(id).oninput = updateLandingPreview;
            });
        }
        
        function backToStep1() {
            document.getElementById('editor-step1').style.display = 'block';
            document.getElementById('editor-step2').style.display = 'none';
        }
        
        function regenerateDescription() {
            if (selectedLandingProduct) {
                document.getElementById('landing-desc').value = getPremiumDescription(selectedLandingProduct.name);
                updateLandingPreview();
            }
        }
        
        function updateLandingPreview() {
            const title = document.getElementById('landing-title').value;
            const desc = document.getElementById('landing-desc').value;
            const promoText = document.getElementById('landing-promo-text').value;
            const video = document.getElementById('landing-video').value;
            const image = selectedLandingProduct?.image_url || '';
            
            document.getElementById('landing-preview').innerHTML = `
                <div style="background:#0a0a0a;color:#fff;font-family:sans-serif">
                    ${video ? 
                        `<video src="${video}" style="width:100%;height:120px;object-fit:cover" autoplay muted loop></video>` : 
                        `<img src="${image}" style="width:100%;height:120px;object-fit:cover" onerror="this.style.background='#333'">`
                    }
                    ${promoText ? `<div style="background:#c9a227;color:#000;padding:6px;text-align:center;font-size:0.75rem;font-weight:600">${promoText}</div>` : ''}
                    <div style="padding:12px">
                        <div style="color:#c9a227;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px">Porcel√°nico Premium</div>
                        <h3 style="font-size:1.2rem;margin-bottom:8px;font-family:Georgia,serif">${title}</h3>
                        <p style="font-size:0.7rem;color:#999;line-height:1.4">${desc.substring(0, 120)}...</p>
                        <button style="width:100%;margin-top:10px;padding:10px;background:#25d366;color:white;border:none;border-radius:4px;font-size:0.8rem;font-weight:600">
                            üì± Cotizar por WhatsApp
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function generateVideoVeo() {
            if (!selectedLandingProduct) return alert('Selecciona un producto primero');
            
            const btn = document.getElementById('btnGenVideo');
            const status = document.getElementById('video-status');
            const slug = selectedLandingProduct.name.toLowerCase().replace(/\s+/g, '_');
            const expectedUrl = `/videos/${slug}.mp4`;
            
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            status.textContent = 'Conectando con Veo 3.1...';
            
            try {
                // Iniciar generaci√≥n
                const response = await fetch('/api/video/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        product_id: selectedLandingProduct.id, 
                        product_name: selectedLandingProduct.name,
                        product_description: selectedLandingProduct.description || 'porcelanato premium de alta calidad',
                        image_url: selectedLandingProduct.image_url
                    })
                });
                
                if (!response.ok) throw new Error('Error al iniciar generaci√≥n');
                
                // Polling: verificar cada 5 seg si el video ya existe (max 3 min)
                let attempts = 0;
                const maxAttempts = 36; // 36 * 5 = 180 seg = 3 min
                
                while (attempts < maxAttempts) {
                    attempts++;
                    status.textContent = `Generando video con IA... (${attempts * 5}s)`;
                    
                    await new Promise(r => setTimeout(r, 5000));
                    
                    // Verificar si el video ya existe
                    const check = await fetch(expectedUrl, { method: 'HEAD' });
                    if (check.ok) {
                        document.getElementById('landing-video').value = expectedUrl;
                        status.innerHTML = '‚úÖ <a href="' + expectedUrl + '" target="_blank">Ver video generado</a>';
                        updateLandingPreview();
                        return;
                    }
                }
                
                status.textContent = '‚è∞ Timeout - revisa la consola del servidor';
            } catch (err) {
                status.textContent = '‚ùå ' + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé¨ Generar';
            }
        }
        
        async function saveLanding() {
            if (!selectedLandingProduct) return alert('Selecciona un producto');
            
            const data = {
                product_id: selectedLandingProduct.id,
                title: document.getElementById('landing-title').value,
                description: document.getElementById('landing-desc').value,
                promo_text: document.getElementById('landing-promo-text').value,
                video_url: document.getElementById('landing-video').value,
                image_url: selectedLandingProduct.image_url
            };
            
            const url = editingLandingId ? `/api/landings/${editingLandingId}` : '/api/landings';
            const method = editingLandingId ? 'PUT' : 'POST';
            
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('‚úÖ Landing guardada');
                closeLandingEditor();
                loadLandings();
            } else {
                alert('‚ùå Error al guardar');
            }
        }
        
        async function editLanding(id) {
            const landing = landings.find(l => l.id === id);
            if (!landing) return;
            
            editingLandingId = id;
            selectedLandingProduct = products.find(p => p.id === landing.product_id);
            
            document.getElementById('editor-title').textContent = '‚úèÔ∏è Editar Landing';
            document.getElementById('editor-product-img').src = landing.product_image || landing.image_url || '';
            document.getElementById('editor-product-name').textContent = landing.product_name || landing.title;
            document.getElementById('editor-product-sku').textContent = landing.product_sku || '';
            
            document.getElementById('landing-title').value = landing.title;
            document.getElementById('landing-desc').value = landing.description || '';
            document.getElementById('landing-promo-text').value = landing.promo_text || '';
            document.getElementById('landing-video').value = landing.video_url || '';
            
            document.getElementById('editor-step1').style.display = 'none';
            document.getElementById('editor-step2').style.display = 'block';
            document.getElementById('landing-editor').style.display = 'block';
            document.getElementById('landing-editor').scrollIntoView({ behavior: 'smooth' });
            
            updateLandingPreview();
        }
        
        function previewLanding(id) {
            const landing = landings.find(l => l.id === id);
            if (!landing) return;
            const sku = landing.product_sku || 'producto';
            window.open(`/p/${sku}?store=cesantoni-fresnillo`, '_blank');
        }
        
        async function deleteLanding(id) {
            if (!confirm('¬øEliminar esta landing?')) return;
            await fetch(`/api/landings/${id}`, { method: 'DELETE' });
            loadLandings();
        }
        
        function previewFullLanding() {
            if (!selectedLandingProduct) return;
            window.open(`/p/${selectedLandingProduct.sku}?store=cesantoni-fresnillo`, '_blank');
        }
        
        // ==================== GENERADOR DE QRs ====================
        function openQRGenerator(landingId) {
            qrSelectedLanding = landings.find(l => l.id === landingId);
            if (!qrSelectedLanding) return;
            
            qrSelected = { dist: new Set(), state: new Set(), store: new Set() };
            document.getElementById('qr-landing-name').textContent = qrSelectedLanding.title || qrSelectedLanding.product_name;
            document.getElementById('qr-generator').style.display = 'block';
            document.getElementById('qr-generator').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('urls-output').style.display = 'none';
            
            renderQRFilters();
        }
        
        function closeQRGenerator() {
            document.getElementById('qr-generator').style.display = 'none';
            qrSelectedLanding = null;
        }
        
        function renderQRFilters() {
            const dists = [...new Set(stores.map(s => s.distributor_name))].filter(Boolean).sort();
            document.getElementById('qr-dists').innerHTML = dists.map(d => 
                `<div class="filter-chip2 ${qrSelected.dist.has(d)?'selected':''}" onclick="qrToggle('dist','${d}')">${d}</div>`
            ).join('');
            
            let filtered = stores;
            if (qrSelected.dist.size) filtered = filtered.filter(s => qrSelected.dist.has(s.distributor_name));
            
            const states = [...new Set(filtered.map(s => s.state))].filter(Boolean).sort();
            document.getElementById('qr-states').innerHTML = states.map(st => 
                `<div class="filter-chip2 ${qrSelected.state.has(st)?'selected':''}" onclick="qrToggle('state','${st}')">${st}</div>`
            ).join('') || '<span style="color:#999;font-size:0.75rem">Selecciona distribuidores</span>';
            
            if (qrSelected.state.size) filtered = filtered.filter(s => qrSelected.state.has(s.state));
            
            document.getElementById('qr-stores').innerHTML = filtered.map(s => 
                `<div class="filter-chip2 ${qrSelected.store.has(s.id)?'selected':''}" onclick="qrToggle('store',${s.id})">${s.name}</div>`
            ).join('') || '<span style="color:#999;font-size:0.75rem">No hay tiendas</span>';
            
            updateQRCount();
        }
        
        function qrToggle(type, val) {
            qrSelected[type].has(val) ? qrSelected[type].delete(val) : qrSelected[type].add(val);
            if (type === 'dist') { qrSelected.state.clear(); qrSelected.store.clear(); }
            if (type === 'state') qrSelected.store.clear();
            renderQRFilters();
        }
        
        function qrSelectAll(type) {
            if (type === 'store') {
                getQRFilteredStores().forEach(s => qrSelected.store.add(s.id));
            } else {
                document.querySelectorAll(`#qr-${type}s .filter-chip2`).forEach(el => {
                    qrSelected[type].add(el.textContent.trim());
                });
            }
            renderQRFilters();
        }
        
        function qrSelectNone(type) {
            qrSelected[type].clear();
            if (type === 'dist') { qrSelected.state.clear(); qrSelected.store.clear(); }
            if (type === 'state') qrSelected.store.clear();
            renderQRFilters();
        }
        
        function getQRFilteredStores() {
            let f = stores;
            if (qrSelected.dist.size) f = f.filter(s => qrSelected.dist.has(s.distributor_name));
            if (qrSelected.state.size) f = f.filter(s => qrSelected.state.has(s.state));
            return f;
        }
        
        function getQRSelectedStores() {
            return qrSelected.store.size ? 
                stores.filter(s => qrSelected.store.has(s.id)) : 
                getQRFilteredStores();
        }
        
        function updateQRCount() {
            document.getElementById('qr-count').textContent = getQRSelectedStores().length;
        }
        
        function generateURLs() {
            const selectedStores = getQRSelectedStores();
            const sku = qrSelectedLanding.product_sku || qrSelectedLanding.title.toLowerCase().replace(/\s+/g, '-');
            const baseUrl = window.location.origin;
            
            return selectedStores.map(store => ({
                store: store.name,
                distributor: store.distributor_name,
                state: store.state,
                url: `${baseUrl}/p/${sku}?store=${store.slug}`
            }));
        }
        
        function copyAllURLs() {
            const urls = generateURLs();
            if (!urls.length) return alert('Selecciona al menos una tienda');
            
            const text = urls.map(u => `${u.store}\t${u.url}`).join('\n');
            navigator.clipboard.writeText(text);
            
            document.getElementById('urls-textarea').value = text;
            document.getElementById('urls-output').style.display = 'block';
            
            alert(`‚úÖ ${urls.length} URLs copiadas al portapapeles`);
        }
        
        function downloadURLsCSV() {
            const urls = generateURLs();
            if (!urls.length) return alert('Selecciona al menos una tienda');
            
            const csv = 'Tienda,Distribuidor,Estado,URL\n' + 
                urls.map(u => `"${u.store}","${u.distributor}","${u.state}","${u.url}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `qr-urls-${qrSelectedLanding.title || 'landing'}.csv`;
            a.click();
        }
        
        function downloadQRsPDF() {
            alert('Funci√≥n de PDF en desarrollo. Por ahora usa "Copiar URLs" y genera los QRs con un generador externo como qr-code-generator.com');
        }
        
        // ==================== FUNNEL ANALYTICS ====================
        let currentFunnelDays = 30;
        function setFunnelDays(days) {
            currentFunnelDays = days;
            document.querySelectorAll('.period-pill').forEach(p => p.classList.toggle('active', p.dataset.days == days));
            loadFunnel();
        }

        async function loadFunnel() {
            try {
                const days = currentFunnelDays;
                const res = await fetch(`/api/funnel?days=${days}`);
                const data = await res.json();
                const f = data.funnel;
                const maxVal = Math.max(f.scans, 1);

                const steps = [
                    { label: 'QR Scans', value: f.scans, color: '#3498db', width: 100 },
                    { label: 'WhatsApp Clicks', value: f.wa_clicks, color: '#25D366', width: 0 },
                    { label: 'Leads', value: f.leads, color: '#C9A962', width: 0 },
                    { label: 'Contactados', value: f.contacted, color: '#e67e22', width: 0 },
                    { label: 'Convertidos', value: f.converted, color: '#27ae60', width: 0 }
                ];
                // Calculate widths as percentage of max (trapezoid effect)
                steps.forEach((s, i) => {
                    if (i > 0) s.width = maxVal > 0 ? Math.max((s.value / maxVal) * 100, 18) : 18;
                });

                let stepsHtml = '';
                for (let i = 0; i < steps.length; i++) {
                    const s = steps[i];
                    stepsHtml += `<div class="funnel-step">
                        <div class="funnel-step-bar" style="width:${s.width}%;background:${s.color}">
                            <span class="step-value">${s.value.toLocaleString()}</span>
                            <span class="step-label">${s.label}</span>
                        </div>
                    </div>`;
                    if (i < steps.length - 1) {
                        const dropoff = steps[i].value > 0 ? ((1 - steps[i+1].value / steps[i].value) * 100).toFixed(0) : 0;
                        stepsHtml += `<div class="funnel-dropoff">‚Üì <span>-${dropoff}%</span></div>`;
                    }
                }
                document.getElementById('funnel-steps').innerHTML = stepsHtml;

                // Conversion rates sidebar
                const r = data.conversion_rates;
                const rates = [
                    { label: 'Scan ‚Üí Click', value: r.scan_to_click, icon: 'üì±' },
                    { label: 'Click ‚Üí Lead', value: r.click_to_lead, icon: 'üí¨' },
                    { label: 'Lead ‚Üí Contacto', value: r.lead_to_contacted, icon: 'üìû' },
                    { label: 'Lead ‚Üí Venta', value: r.lead_to_converted, icon: '‚úÖ' }
                ];
                document.getElementById('funnel-rates').innerHTML = rates.map(rc =>
                    `<div class="rate-card">
                        <div class="rate-icon">${rc.icon}</div>
                        <div><div class="rate-value">${rc.value}%</div><div class="rate-label">${rc.label}</div></div>
                    </div>`
                ).join('');

                // Top products
                const tpEl = document.getElementById('funnel-top-products');
                if (data.top_products && data.top_products.length > 0) {
                    tpEl.innerHTML = `<div class="fp-title">Top pisos escaneados</div>` +
                        data.top_products.slice(0, 5).map((p, i) =>
                            `<div class="funnel-product-item">
                                <span class="fp-rank ${i === 0 ? 'top' : ''}">${i + 1}</span>
                                <span class="fp-name">${p.name}</span>
                                <span class="fp-count">${p.scans}</span>
                            </div>`
                        ).join('');
                } else {
                    tpEl.innerHTML = '<div class="fp-title">Top pisos escaneados</div><span style="color:#ccc;font-size:0.8rem">Sin datos</span>';
                }
            } catch (e) { console.error('Funnel error:', e); }
        }

        // ==================== LEADS SUMMARY WIDGET ====================
        function getTimeAgo(dateStr) {
            const d = mxDate(dateStr);
            if (!d) return '';
            const now = new Date();
            const diff = Math.floor((now - d) / 1000);
            if (diff < 60) return 'ahora';
            if (diff < 3600) return `hace ${Math.floor(diff/60)}m`;
            if (diff < 86400) return `hace ${Math.floor(diff/3600)}h`;
            if (diff < 604800) return `hace ${Math.floor(diff/86400)}d`;
            return d.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
        }

        async function loadLeads() {
            try {
                const res = await fetch('/api/leads?days=90');
                const leads = await res.json();

                const total = leads.length;
                const landing = leads.filter(l => l.source === 'landing').length;
                const terra = leads.filter(l => l.source === 'terra_qr').length;
                const wa = leads.filter(l => l.source === 'whatsapp_bot').length;
                const nuevos = leads.filter(l => l.status === 'new').length;
                const contactados = leads.filter(l => l.status === 'contacted').length;
                const convertidos = leads.filter(l => l.status === 'converted').length;

                // Source bar
                const barEl = document.getElementById('leads-source-bar');
                if (total > 0) {
                    const pLanding = (landing / total * 100).toFixed(1);
                    const pTerra = (terra / total * 100).toFixed(1);
                    const pWa = (wa / total * 100).toFixed(1);
                    barEl.innerHTML = `<div class="seg seg-landing" style="width:${pLanding}%"></div><div class="seg seg-terra" style="width:${pTerra}%"></div><div class="seg seg-wa" style="width:${pWa}%"></div>`;
                    document.getElementById('leads-source-legend').innerHTML = `
                        <span><span class="dot" style="background:#3498db"></span>Landing ${pLanding}%</span>
                        <span><span class="dot" style="background:#C9A962"></span>Terra ${pTerra}%</span>
                        <span><span class="dot" style="background:#25D366"></span>WhatsApp ${pWa}%</span>`;
                } else {
                    barEl.innerHTML = '';
                    document.getElementById('leads-source-legend').innerHTML = '<span style="color:#ccc">Sin datos</span>';
                }

                // Stats grid
                document.getElementById('leads-stats-grid').innerHTML = `
                    <div class="lead-stat highlight"><div class="ls-value">${total}</div><div class="ls-label">Total</div></div>
                    <div class="lead-stat"><div class="ls-value">${nuevos}</div><div class="ls-label">Nuevos</div></div>
                    <div class="lead-stat"><div class="ls-value">${contactados}</div><div class="ls-label">Contactados</div></div>
                    <div class="lead-stat"><div class="ls-value">${convertidos}</div><div class="ls-label">Convertidos</div></div>`;

                // Recent leads (top 5)
                const recentEl = document.getElementById('leads-recent');
                const recent = leads.slice(0, 5);
                if (recent.length === 0) {
                    recentEl.innerHTML = '<div style="color:#ccc;font-size:0.8rem;padding:8px 0">Sin leads aun</div>';
                    return;
                }
                recentEl.innerHTML = recent.map(l => {
                    const srcClass = l.source === 'landing' ? 'src-landing' : l.source === 'terra_qr' ? 'src-terra' : 'src-wa';
                    const srcLabel = l.source === 'landing' ? 'Landing' : l.source === 'terra_qr' ? 'Terra' : 'WhatsApp';
                    const initial = (l.name || '?')[0].toUpperCase();
                    const store = l.store_name || l.store_full_name || '';
                    return `<div class="recent-lead" onclick="showPage('leads')">
                        <div class="lead-avatar ${srcClass}">${initial}</div>
                        <div class="rl-info">
                            <div class="rl-name">${l.name || l.phone}</div>
                            <div class="rl-meta">${srcLabel}${store ? ' ¬∑ ' + store : ''}</div>
                        </div>
                        <div class="rl-time">${getTimeAgo(l.created_at)}</div>
                    </div>`;
                }).join('');
            } catch (e) { console.error('Leads error:', e); }
        }

        // UTC date from SQLite ‚Üí local Mexico time
        function mxDate(utcStr) {
            if (!utcStr) return null;
            // Append Z so JS knows it's UTC
            const d = new Date(utcStr.endsWith('Z') ? utcStr : utcStr + 'Z');
            return isNaN(d) ? null : d;
        }

        // ==================== WHATSAPP BOT ====================
        async function loadWALeads() {
            try {
                const res = await fetch('/api/wa/conversations');
                const convos = await res.json();
                const today = new Date().toISOString().split('T')[0];
                const todayCount = convos.filter(c => c.last_contact && c.last_contact.startsWith(today)).length;
                const totalMsgs = convos.reduce((sum, c) => sum + (c.total_messages || 0), 0);

                document.getElementById('wa-total').textContent = convos.length;
                document.getElementById('wa-today').textContent = todayCount;
                document.getElementById('wa-msgs').textContent = totalMsgs;

                const listEl = document.getElementById('wa-leads-list');
                if (convos.length === 0) {
                    listEl.innerHTML = '<span style="color:#aaa">Sin conversaciones de WhatsApp Bot a√∫n.</span>';
                    return;
                }
                listEl.innerHTML = convos.map(c => {
                    const date = c.last_contact ? mxDate(c.last_contact).toLocaleDateString('es-MX', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
                    const phone = c.phone || '';
                    const displayPhone = phone.length > 10 ? phone.slice(0,2) + ' ' + phone.slice(2,5) + ' ' + phone.slice(5,8) + ' ' + phone.slice(8) : phone;
                    return `<div style="padding:8px 0;border-bottom:1px solid #f0f0f0;cursor:pointer" onclick="showWAConversation('${phone}')">
                        <strong style="color:#25D366">üì± ${displayPhone}</strong>
                        <div style="font-size:0.75rem;color:#555;margin-top:2px">${c.last_message || ''}</div>
                        <div style="font-size:0.65rem;color:#aaa">${c.total_messages} msgs ¬∑ ${date}</div>
                    </div>`;
                }).join('');
            } catch (e) { console.error('WA leads error:', e); }
        }

        async function showWAConversation(phone) {
            const detailEl = document.getElementById('wa-conversation-detail');
            try {
                const res = await fetch(`/api/wa/conversation/${phone}`);
                const msgs = await res.json();
                if (msgs.length === 0) { detailEl.innerHTML = '<span style="color:#aaa">Sin mensajes</span>'; return; }
                detailEl.innerHTML = msgs.map(m => {
                    const isUser = m.role === 'user';
                    const time = m.created_at ? mxDate(m.created_at).toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'}) : '';
                    return `<div style="padding:6px 10px;margin:4px 0;border-radius:8px;max-width:85%;${isUser ? 'background:#dcf8c6;margin-left:auto;text-align:right' : 'background:#f0f0f0'}">
                        <div style="font-size:0.8rem">${m.message}</div>
                        <div style="font-size:0.6rem;color:#888;margin-top:2px">${isUser ? 'üë§ Cliente' : 'ü§ñ Terra'} ¬∑ ${time}</div>
                    </div>`;
                }).join('');
                detailEl.scrollTop = detailEl.scrollHeight;
            } catch (e) { detailEl.innerHTML = '<span style="color:#aaa">Error cargando</span>'; }
        }

        async function loadWAPage() {
            try {
                const res = await fetch('/api/wa/conversations');
                const convos = await res.json();
                const today = new Date().toISOString().split('T')[0];
                const todayCount = convos.filter(c => c.last_contact && c.last_contact.startsWith(today)).length;
                const totalMsgs = convos.reduce((sum, c) => sum + (c.total_messages || 0), 0);

                document.getElementById('wa-page-total').textContent = convos.length;
                document.getElementById('wa-page-today').textContent = todayCount;
                document.getElementById('wa-page-msgs').textContent = totalMsgs;

                const listEl = document.getElementById('wa-page-list');
                if (convos.length === 0) {
                    listEl.innerHTML = '<span style="color:#aaa">Sin conversaciones a√∫n. El bot responde autom√°ticamente por WhatsApp.</span>';
                    return;
                }
                listEl.innerHTML = convos.map(c => {
                    const date = c.last_contact ? mxDate(c.last_contact).toLocaleDateString('es-MX', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
                    const phone = c.phone || '';
                    const displayPhone = phone.length > 10 ? phone.slice(0,2) + ' ' + phone.slice(2,5) + ' ' + phone.slice(5,8) + ' ' + phone.slice(8) : phone;
                    return `<div style="padding:10px 0;border-bottom:1px solid #f0f0f0;cursor:pointer" onclick="showWAPageChat('${phone}')">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong style="color:#25D366">üì± ${displayPhone}</strong>
                            <span style="font-size:0.65rem;color:#aaa">${date}</span>
                        </div>
                        <div style="font-size:0.8rem;color:#555;margin-top:4px">${c.last_message || ''}</div>
                        <span class="terra-stat">${c.total_messages} mensajes</span>
                        <span class="terra-stat" style="background:#dcf8c6">üí¨ Bot</span>
                    </div>`;
                }).join('');
            } catch (e) { console.error('WA page error:', e); }
        }

        async function showWAPageChat(phone) {
            document.getElementById('wa-page-phone').textContent = phone;
            const chatEl = document.getElementById('wa-page-chat');
            try {
                const res = await fetch(`/api/wa/conversation/${phone}`);
                const msgs = await res.json();
                if (msgs.length === 0) { chatEl.innerHTML = '<span style="color:#aaa">Sin mensajes</span>'; return; }
                chatEl.innerHTML = msgs.map(m => {
                    const isUser = m.role === 'user';
                    const time = m.created_at ? mxDate(m.created_at).toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'}) : '';
                    const date = m.created_at ? mxDate(m.created_at).toLocaleDateString('es-MX', {day:'numeric',month:'short'}) : '';
                    return `<div style="padding:8px 12px;margin:4px 0;border-radius:10px;max-width:80%;${isUser ? 'background:#dcf8c6;margin-left:auto;text-align:right' : 'background:#f0f0f0'}">
                        <div style="font-size:0.85rem">${m.message}</div>
                        <div style="font-size:0.6rem;color:#888;margin-top:3px">${isUser ? 'üë§ Cliente' : 'ü§ñ Terra'} ¬∑ ${date} ${time}</div>
                    </div>`;
                }).join('');
                chatEl.scrollTop = chatEl.scrollHeight;
            } catch (e) { chatEl.innerHTML = '<span style="color:#aaa">Error cargando</span>'; }
        }

        // ==================== LEADS PAGE ====================
        async function loadLeadsPage(sourceFilter, statusFilter) {
            try {
                let url = '/api/leads?days=365';
                if (sourceFilter) url += `&source=${sourceFilter}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                const res = await fetch(url);
                const leads = await res.json();

                document.getElementById('lp-total').textContent = leads.length;
                document.getElementById('lp-landing').textContent = leads.filter(l => l.source === 'landing').length;
                document.getElementById('lp-terra').textContent = leads.filter(l => l.source === 'terra_qr').length;
                document.getElementById('lp-wa').textContent = leads.filter(l => l.source === 'whatsapp_bot').length;
                document.getElementById('lp-new').textContent = leads.filter(l => l.status === 'new').length;

                const listEl = document.getElementById('lp-list');
                if (leads.length === 0) { listEl.innerHTML = '<div style="padding:40px;text-align:center;color:#aaa">Sin leads. Prueba el flujo desde una landing page.</div>'; return; }
                listEl.innerHTML = leads.map(l => {
                    const date = l.created_at ? mxDate(l.created_at).toLocaleDateString('es-MX', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
                    const sourceIcon = l.source === 'landing' ? 'üåê' : l.source === 'terra_qr' ? 'üè™' : 'üí¨';
                    const statusDot = l.status === 'new' ? '#27ae60' : l.status === 'contacted' ? '#f39c12' : l.status === 'converted' ? '#3498db' : '#ccc';
                    let products = '';
                    try { products = JSON.parse(l.products_interested || '[]').join(', '); } catch(e) { products = l.products_interested || ''; }
                    const city = l.store_city || '';
                    const store = l.store_full_name || l.store_name || '';
                    return `<div style="padding:12px 14px;border-bottom:1px solid #f5f5f5;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background=''" onclick="showLeadPage(${l.id})">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="width:8px;height:8px;border-radius:50%;background:${statusDot};display:inline-block"></span>
                                <strong style="font-size:0.9rem">${l.name || 'Sin nombre'}</strong>
                            </div>
                            <span style="font-size:0.65rem;color:#aaa">${date}</span>
                        </div>
                        <div style="margin-left:16px;margin-top:4px">
                            <div style="font-size:0.75rem;color:#555">${sourceIcon} ${store}${city ? ' ¬∑ ' + city : ''}</div>
                            ${products ? `<div style="font-size:0.7rem;color:#888;margin-top:2px">${products}</div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { console.error('Leads page error:', e); }
        }

        async function showLeadPage(leadId) {
            const el = document.getElementById('lp-detail');
            try {
                const res = await fetch(`/api/leads/${leadId}`);
                const l = await res.json();
                const phone = l.phone || '';
                const dp = phone.length > 10 ? '+' + phone.slice(0,2) + ' ' + phone.slice(2,5) + ' ' + phone.slice(5,8) + ' ' + phone.slice(8) : phone;
                const sourceLabel = l.source === 'landing' ? 'üåê Landing Page' : l.source === 'terra_qr' ? 'üè™ Terra en Tienda' : 'üí¨ WhatsApp Directo';
                const created = l.created_at ? mxDate(l.created_at).toLocaleDateString('es-MX', {day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
                const baseUrl = 'https://cesantoni-experience-za74.onrender.com';

                // Header: name + status + WhatsApp button
                let html = `
                <div style="padding:16px 20px;background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:10px;color:#fff;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                            <h2 style="margin:0;font-size:1.3rem;font-family:'Playfair Display',serif">${l.name || 'Sin nombre'}</h2>
                            <div style="font-size:0.8rem;opacity:0.7;margin-top:4px">${created}</div>
                        </div>
                        <select onchange="updateLeadPageStatus(${l.id}, this.value)" style="padding:5px 10px;border:none;border-radius:8px;font-size:0.75rem;font-weight:600;cursor:pointer;
                            background:${l.status==='new'?'#27ae60':l.status==='contacted'?'#f39c12':l.status==='converted'?'#3498db':'#888'};color:#fff">
                            <option value="new" ${l.status==='new'?'selected':''}>Nuevo</option>
                            <option value="contacted" ${l.status==='contacted'?'selected':''}>Contactado</option>
                            <option value="converted" ${l.status==='converted'?'selected':''}>Convertido</option>
                            <option value="lost" ${l.status==='lost'?'selected':''}>Perdido</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:12px">
                        <a href="https://wa.me/${phone}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:#25D366;color:#fff;border-radius:8px;text-decoration:none;font-size:0.8rem;font-weight:600">üì± WhatsApp ${dp}</a>
                        ${l.store_whatsapp ? `<a href="https://wa.me/${l.store_whatsapp}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(255,255,255,0.15);color:#fff;border-radius:8px;text-decoration:none;font-size:0.75rem">üè™ WA Tienda</a>` : ''}
                        ${l.store_phone ? `<a href="tel:${l.store_phone}" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(255,255,255,0.15);color:#fff;border-radius:8px;text-decoration:none;font-size:0.75rem">üìû Tienda</a>` : ''}
                    </div>
                </div>`;

                // Info cards grid
                html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">`;

                // Fuente
                html += `<div style="padding:12px 16px;background:#f8f9fa;border-radius:8px">
                    <div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Fuente</div>
                    <div style="font-size:0.9rem;font-weight:600">${sourceLabel}</div>
                </div>`;

                // Tienda
                html += `<div style="padding:12px 16px;background:#f8f9fa;border-radius:8px">
                    <div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Tienda</div>
                    <div style="font-size:0.9rem;font-weight:600">${l.store_full_name || l.store_name || '‚Äî'}</div>
                    ${l.store_address ? `<div style="font-size:0.7rem;color:#666;margin-top:2px">${l.store_address}</div>` : ''}
                </div>`;

                // Ciudad / Estado
                html += `<div style="padding:12px 16px;background:#f8f9fa;border-radius:8px">
                    <div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Ciudad</div>
                    <div style="font-size:0.9rem;font-weight:600">${l.store_city || '‚Äî'}${l.store_state ? ', ' + l.store_state : ''}</div>
                </div>`;

                // Distribuidor
                html += `<div style="padding:12px 16px;background:#f8f9fa;border-radius:8px">
                    <div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Distribuidor</div>
                    <div style="font-size:0.9rem;font-weight:600">${l.distributor_name || '‚Äî'}</div>
                    ${l.store_manager ? `<div style="font-size:0.7rem;color:#666;margin-top:2px">Gerente: ${l.store_manager}</div>` : ''}
                </div>`;

                html += `</div>`;

                // Pisos de interes (con imagen y link)
                if (l.products_detail && l.products_detail.length > 0) {
                    html += `<div style="margin-bottom:16px">
                        <div style="font-size:0.7rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Pisos de interes</div>`;
                    html += l.products_detail.map(p => {
                        const link = p.sku ? `${baseUrl}/p/${p.sku}` : (p.slug ? `${baseUrl}/p/${p.slug}` : '');
                        return `<div style="display:flex;align-items:center;gap:12px;padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:8px">
                            ${p.image_url ? `<img src="${p.image_url}" style="width:60px;height:60px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'">` : '<div style="width:60px;height:60px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.2rem">üß±</div>'}
                            <div style="flex:1">
                                <div style="font-weight:600;font-size:0.9rem">${p.name}</div>
                                <div style="font-size:0.75rem;color:#666;margin-top:2px">${p.format || ''} ¬∑ ${p.finish || ''} ${p.base_price ? '¬∑ $' + p.base_price + '/m¬≤' : ''}</div>
                                ${p.usage ? `<div style="font-size:0.7rem;color:#888;margin-top:1px">${p.usage}</div>` : ''}
                            </div>
                            ${link ? `<a href="${link}" target="_blank" style="padding:6px 12px;background:#C41E3A;color:#fff;border-radius:6px;text-decoration:none;font-size:0.7rem;white-space:nowrap">Ver landing</a>` : ''}
                        </div>`;
                    }).join('');
                    html += `</div>`;
                }

                // Notas
                if (l.notes) {
                    html += `<div style="padding:12px 16px;background:#fff9e6;border-radius:8px;border-left:3px solid #f39c12;margin-bottom:16px">
                        <div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Notas</div>
                        <div style="font-size:0.8rem;color:#555">${l.notes}</div>
                    </div>`;
                }

                // Conversation WhatsApp
                if (l.conversation && l.conversation.length > 0) {
                    html += `<div>
                        <div style="font-size:0.7rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Conversacion WhatsApp (${l.conversation.length} mensajes)</div>
                        <div style="background:#e5ddd5;border-radius:10px;padding:12px;max-height:350px;overflow-y:auto">`;
                    html += l.conversation.map(m => {
                        const isUser = m.role === 'user';
                        const time = m.created_at ? mxDate(m.created_at).toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'}) : '';
                        const date = m.created_at ? mxDate(m.created_at).toLocaleDateString('es-MX', {day:'numeric',month:'short'}) : '';
                        return `<div style="padding:8px 12px;margin:4px 0;border-radius:8px;max-width:85%;font-size:0.8rem;box-shadow:0 1px 1px rgba(0,0,0,0.08);${isUser ? 'background:#dcf8c6;margin-left:auto;text-align:right' : 'background:#fff'}">
                            ${m.message}
                            <div style="font-size:0.55rem;color:#888;margin-top:3px">${isUser ? 'üë§ Cliente' : 'ü§ñ Terra'} ¬∑ ${date} ${time}</div>
                        </div>`;
                    }).join('');
                    html += `</div></div>`;
                }

                el.innerHTML = html;
            } catch (e) { el.innerHTML = '<span style="color:#aaa">Error cargando lead</span>'; console.error(e); }
        }

        async function updateLeadPageStatus(leadId, status) {
            try {
                await fetch(`/api/leads/${leadId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
                showLeadPage(leadId);
            } catch (e) { console.error(e); }
        }

        // ==================== INIT ====================
        loadAllData().then(() => { loadDashboard(); loadFunnel(); loadLeads(); loadWALeads(); });
    </script>
</body>
</html>
